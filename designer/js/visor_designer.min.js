!function(e){visordesigner=function(t,n){this.parent=e(t),this.thumbnail=null,this.interval=2e4;var i=this;e.extend(this,n),this.createdocument=function(t,n){this.document=new visordocument(t,n),i.parent.find(".designer").each(function(t,n){e(n).css("left","200px").css("top","200px").css("position","relative")}),riot.observable(this),this.attachEvent(),this.on("navigation_loaded",function(){i.trigger("openpropertypanel",1),window.onresize=function(){var t=document.documentElement.clientHeight,n=document.documentElement.clientWidth,i=e("#panel_workspace .panel-heading").css("height");parseInt(i.substring(0,i.length-2));e("#editor").css("height",t-90+"px"),e("#navigation").css("height",t-90+"px"),e("#panel_propertyEditor").css("height",t-90+"px"),e("#panel_login").css("left",n-270+"px");var a=e("#panel_workspace").css("width");a=parseInt(a.substring(0,a.length-2)),e("#workspace-background").css("width",a-30)},window.onresize(),e("widgets img").attr("draggable",!0),e("widgets img").attr("ondragstart","drag(event)"),e("#widgets button").attr("draggable",!0),e("#widgets button").attr("ondragstart","drag(event)"),e("#modalbackgroundFile").on("hide.bs.modal",function(e){i.document.activePanel.instance.paint()}),e("#background_image_remove").bind("click",function(){return e("#backgroundFile").val(""),e("#backgroundFile").trigger("change"),i.document.activePanel.instance.paint(),!1}),this.setActive(this.document.activePanel.instance.name)}),riot.mount("diagrammenu,navigation,propertyEditorPage,propertyEditorWidget,diagramsetup,animation,diagramPublish",i)},this.attachEvent=function(){var t=function(t){e("#pageName").trigger("blur"),e(".dropdown-menu").parent().removeClass("open"),e("#result").hide(),currentconnector=null,i.document.activePanel.instance.Cursor("default"),e(i.document.activePanel.instance.canvas).contextmenu("closemenu",t),e("#customwidgets img").contextmenu("closemenu",t),i.document.activePanel.instance.canvas.focus()};this.document.on("fieldclickEvent",function(e,t){i.document.activePanel.instance.focuswidget=t,visordesigner.fieldclickEvent.call(t,e)}),this.document.on("keypress",function(t,n){var a=t.ctrlKey,s=t.keyCode;if(a&&83==s)i.trigger("savedocument");else if(112===s)e("#modalShortcut").modal("show");else if(113===s)i.trigger("openpropertypanel");else if(114===s)i.trigger("openwidgetpanel");else if(46===s){var o=n.focuswidget;o&&o.parent.deletefield?o.parent.deletefield(o):n.deleteFocus()}else 90==s&&a?i.trigger("undo"):89==s&&a&&i.trigger("redo")}),this.document.on("panel_click",function(e,n){if(i.trigger("updatepanel",n),t(e),n.focuswidget&&n.focuswidget.type.indexOf("Connector")>0){var a=i.document.activePanel.instance.focuswidget;(e.originalEvent.ctrlKey||"slideshow"===i.type)&&(0===a.resizer?(a.begin.x=a.begin.widget.width/2,a.begin.y=a.begin.widget.height/2,a.paint()):a.resizer===a.resizers.length-1&&(a.end.x=a.end.widget.width/2,a.end.y=a.end.widget.height/2,a.paint()))}i.updatePropertyEditor(),i.drawthumbnail(),i.document.activePanel.instance.focuswidget||i.trigger("openpropertypanel",1)}),this.on("selectbackgroundimage",function(t){a=t,riot.mount("div[self='background_file']","modaldialog",this),e("#backgroundfile").modal("show")}),this.on("restore",function(e){var t=JSON.parse(e);"object"==typeof t&&t.schema&&(i.reset(),t.id=null,i.document.restoreSchema(t),this.trigger("restoredocument"))}),this.on("display",function(e){ShowConfirmClose(!1),i.autoSave(!1)}),this.on("dialogsubmit",function(e){"diagramsave"==e&&i.saveDocument(function(e){ShowConfirmClose(!1),i.autoSave(!1),showmessage("#btn-save",MESSAGE.SAVE_SUCCESSFULL)})}),this.on("savedocument",function(){i.document.name||""==principal?i.trigger("dialogsubmit","diagramsave"):i.trigger("documentsetup")}),this.on("restoredocument",function(){e("#document-name").val(i.title),e("#document-description").val(i.description),i.setActive(i.document.activePanel.instance.name)}),this.on("uploadFile",function(e){i.uploadFile(e)}),this.on("propertychange",function(e,t,n){var i,a=this;if(i=t?e[t][n]:e[n],"treeNode"==e.type){if("name"==n){var s=e.objectdata.targetpath,o=a.document.activePanel.instance.Widget(s);o&&(o.objectdata.targetpath=i)}else if("datatype"==n){var r="images/tree/40-1-1.png";"Array"==i?r="images/tree/40-1.png":"Object"==i?r="images/tree/json-40-1.png":"MergedObject"==i?r="images/tree/lable.png":"Date"==i?r="date-40-1.png":"Integer"==i&&(r="number-40-1.png"),e.Background({filltype:"image",image:r},function(){a.document.activePanel.instance.paint()})}}else if("mapConnector"==e.type){if("mappingtype"==n){if(e.objectdata.target)e.objectdata.target.objectdata.datatype=i;else if(e.objectdata.targetpath){var c=e.targetpath.split(".");if(c.length>0){e.end.widget.includeChildren=!0;e.presenters[0].Widget(e.end.widget.name);e.objectdata.target=e.end.widget;for(var l=1;l<=c.length-1;l++)e.objectdata.target=e.objectdata.target.Widget(c[l]);e.objectdata.target.objectdata.datatype=i}}e.objectdata.targetpath=e.gettargetpath(e.objectdata.target,1,1),"Array"==i?r="images/tree/40-1.png":"Object"==i?r="images/tree/json-40-1.png":"MergedObject"==i&&(r="images/tree/lable.png"),e.objectdata.target.Background({filltype:"image",image:r},function(){a.document.activePanel.instance.paint()}),e.objectdata.matchcriteria.values.splice(0,e.objectdata.matchcriteria.values.length),e.objectdata.matchcriteria2.values.splice(0,e.objectdata.matchcriteria2.values.length),e.objectdata.matchcriteria.visible="Array"==i,e.objectdata.fieldmaps.values.splice(0,e.objectdata.fieldmaps.values.length);for(var l=0;l<=e.begin.widget.pk.length-1;l++){var n=e.begin.widget.pk[l].name;e.begin.widget.pk[l].data.isfk&&e.objectdata.matchcriteria2.values.push({source:n,target:n}),"Array"==i||"Object"==i?(e.objectdata.matchcriteria.values.push({source:n,target:e.objectdata.target.name+"."+n}),riot.update()):e.objectdata.matchcriteria.values.push({source:n,target:n}),e.objectdata.fieldmaps.values.push({source:n,target:n})}return}}else if("collection"==e.type&&""==t&&"name"==n)for(var l=0;l<e.widgets.length;l++)if(e.widgets[l].objectdata.targetpath){var s=e.widgets[l].objectdata.targetpath,o=a.document.activePanel.instance.Widget(s);if(o){var c=o.objectdata.targetpath.split(".");o.objectdata.targetpath=c.join(".")}}this.document.activePanel.instance.paint()}),this.off("publish").on("publish",function(){this.document.publishId=1,i.saveDocument(function(e){i.document.publishId=e.publishId,riot.mount("diagramPublish",i)})}),this.off("removepublish").on("removepublish",function(e){this.document.publishId=null,i.saveDocument(function(e){this.document.publishId=e.publishId,riot.mount("diagramPublish",i)})}),this.on("activepage",function(e){e.name!=this.document.activePanel.instance.rootwidget.name&&i.setActive(e.name)}),this.on("removepage",function(e){if(window.confirm(MESSAGE.REMOVE_PAGE_CONFIRM)){if(1==i.document.panels.length)return void alert("至少要保留一个页面,不能再删除当前页面了");i.removepage(e.name),riot.update()}}),this.on("newpage",function(){var e=this.document.newpage();i.setActive(e.instance.name)}),i.on("updatepanel",function(e){riot.update()}),this.document.on("cutwidget",function(){i.updatePropertyEditor()}),this.document.on("deletewidget",function(){i.updatePropertyEditor()})},this.removepage=function(e){for(var t=0;t<this.document.panels.length;t++)this.document.panels[t].instance.rootwidget.name===e&&(t>0?this.setActive(this.document.panels[t-1].instance.name):this.setActive(this.document.panels[t+1].instance.name),this.document.panels.splice(t,1),t--);return this},this.reset=function(){var t=this;this.id=null,this.name=null,t.document.panels.splice(0,t.document.panels.length),e(".designer").remove()},this.getActiveRect=function(){var t=e("#editor").scrollTop()-200,n=e("#editor").scrollLeft()-200,i=Math.max(n,0),a=Math.max(t,0),s=e("#editor").css("width"),o=e("#editor").css("height");return s=parseInt(s.substring(0,s.length-2))+n,o=parseInt(o.substring(0,o.length-2))+t,{x:i,y:a,width:Math.min(s,this.document.activePanel.instance.width)-i,height:Math.min(o,this.document.activePanel.instance.height)-a}},this.drawthumbnail=function(){this.thumbnail&&(this.thumbnail.owner=this.document.activePanel.instance,this.thumbnail.updateBoxSize(this.getActiveRect()),this.thumbnail.refresh())},this.createThumbnail=function(){var t=this,n=e.thumbnails({height:200,width:400,dom:e("#thumbnail"),owner:this.document.activePanel.instance,activeRect:this.getActiveRect(),onboxchange:function(n,i){e("#editor").scrollLeft(n.x/t.thumbnail.scale+200),e("#editor").scrollTop(n.y/t.thumbnail.scale+200)}});return this.thumbnail=n,t.drawthumbnail(),n},this.setActive=function(t){var n=this;this.showthumbnail="true"==localStorage.getItem("showthumbnail")||!1,this.showthumbnail?e("#thumbnail-box").show():e("#thumbnail-box").hide(),!n.thumbnail&&n.showthumbnail&&n.createThumbnail(),this.updateDesktop=function(){var t=(e("#backgroundfilltype").select2("val"),this.document.activePanel.instance.rootwidget);for(s in this.document.activePanel.instance.background)"image"!=s&&(t.background[s]=this.document.activePanel.instance.background[s]);for(s in this.document.activePanel.instance.gradient)"gradient"==s&&(t.gradient[s]=this.document.activePanel.instance.gradient[s]);e(n.document.activePanel.instance.canvas).css("height",n.document.activePanel.instance.canvas.height*t.scale),this.document.activePanel.instance.paint()};this.parent.find(".designer:visible").hide(),"number"==typeof t&&(t=this.document.panels[t].instance.rootwidget.name),e("#"+t).show();for(var i=0;i<this.document.panels.length;i++)this.document.panels[i].instance.rootwidget.name===t?(this.document.activePanel=this.document.panels[i],this.document.activePanel.active=!0,this.pageindex=i):this.document.panels[i].active=!1;!function(){var t=n.document.activePanel.instance.rootwidget;e("#workspace").css("width",parseInt(t.width)+400),e("#workspace").css("height",parseInt(t.height)+400),e("#editor").scrollTop(180),e("#editor").scrollLeft(180),e("#editor").scroll(function(){n.showthumbnail&&n.drawthumbnail()}),n.thumbnail&&n.showthumbnail?n.thumbnail.refresh():!n.thumbnail&&n.showthumbnail&&n.drawthumbnail(),e(n.document.activePanel.instance.canvas).css("height",n.document.activePanel.instance.canvas.height*t.scale),n.updateDesktop()}(),riot.update(),e(".activePage").appendTo(e("a[document='"+t+"']").parent()),e(n.parent).unbind(),e(n.parent).bind("mousemove",function(t){var i=t.clientX-e(this).offset().left+e(this).scrollLeft(),a=t.clientY-e(this).offset().top+e(this).scrollTop(),s=i-200,o=a-200;t.layerX=i,t.layerY=a,t.offsetX=s,t.offsetY=o;var r=n.document.activePanel.instance.width*n.document.activePanel.instance.scale,c=n.document.activePanel.instance.height*n.document.activePanel.instance.scale;(s<0||o<0||s>r||o>c)&&n.document.activePanel.instance._triggerEvent("mousemove",t)}).bind("mouseup",function(t){var i=t.clientX-e(this).offset().left+e(this).scrollLeft(),a=t.clientY-e(this).offset().top+e(this).scrollTop(),s=i-200,o=a-200;t.layerX=i,t.layerY=a,t.offsetX=s,t.offsetY=o;var r=n.document.activePanel.instance.width*n.document.activePanel.instance.scale,c=n.document.activePanel.instance.height*n.document.activePanel.instance.scale;(s<0||o<0||s>r||o>c)&&n.document.activePanel.instance._triggerEvent("mouseup",t)}),this.updateInfo&&this.updateInfo()},this.init=function(e){i.reset(),i.document.restoreSchema(e||{}),i.trigger("restoredocument")},this.restore=function(e){i.reset(),i.document.restoreDocument(e||{}),i.trigger("restoredocument")},this.getJsonResult=function(){var t={};return e.extend(t,this.document.persist()),t.data},this.getDesignResult=function(){var t={};return e.extend(t,this.document.persist()),t},i.createdocument(t,{name:n.type+"_"+(new Date).format("yyyyMMddhhmm"),category:n.category});var a="background";this.saveDocument=function(t){var n={};e.extend(n,this.document.persist()),this.trigger("save",n),localStorage.setItem("visordesigner",JSON.stringify(n)),console.info(n.data),ShowConfirmClose(!1)},this.uploadFile=function(e){new fileUploadSocket({index:0,sequence:0,file:e,folder:this.category.id,user:principal,onstarted:function(){uploading=!0,ShowConfirmClose(!0)},oncompleted:function(e){uploading=!1,ShowConfirmClose(!1),params.items.push(e),riot.update()}})}},visordesigner.widgetClickEvent=function(e){e.target&&console.info("widget "+e.target.name+" was clicked")},visordesigner.fieldclickEvent=function(e){mydesigner.updatePropertyEditor(),e.y=this.y+this.height/2,visordesigner.widgetClickEvent.call(this.parent,e)},visordesigner.prototype.autoSave=function(e){var t=this,n=this.interval;e?(null!=this.playhandler&&window.clearInterval(this.playhandler),null!=t.document.id&&(this.playhandler=setInterval(function(){t.trigger("dialogsubmit","diagramsave")},n))):e||null==this.playhandler||(window.clearInterval(this.playhandler),this.playhandler=null)},visordesigner.prototype.updatePropertyEditor=function(){var e=this,t=this.document.activePanel.instance.focuswidget;null!=t&&t.persist(),this.document.activePanel&&this.document.activePanel.instance.focuswidget&&("table"!=this.document.activePanel.instance.focuswidget.type&&"field"!=this.document.activePanel.instance.focuswidget.type?e.trigger("openpropertypanel",0):e.trigger("openpropertypanel",1),ShowConfirmClose(!0)),riot.mount("propertyEditorWidget",e),riot.mount("animation",e)},visordesigner.createWidget=function(e){return mydesigner.document.createWidget(e)},visordesigner.drop=function(t){var n=40,i=40;t.stopPropagation(),t.preventDefault();var a=t.dataTransfer.getData("text"),s=t.dataTransfer.files;if(a.indexOf("widget")>=0){var o={},r=mydesigner.document.activePanel.instance;t.offsetX?(o.x=t.offsetX-n,o.y=t.offsetY-i):(o.x=t.layerX-n,o.y=t.layerY-i);var c=visordesigner.createWidget(a);c.x=o.x/r.scale,c.y=o.y/r.scale,c.Scale(r.scale),c.appendPresenter(r),"table"!==c.type&&"entity"!==c.type&&"collection"!==c.type||(c.fieldclickEvent=visordesigner.fieldclickEvent),null!=r.focuswidget&&(r.focuswidget.focus=!1),r.focuswidget=c,e.command("new",r,c.persist()),r.paint()}else if(null!=s&&s.length>0)for(var r=mydesigner.activePanel.instance,l=function(t){return opt={},opt.type="box",opt.width=450,opt.height=400,opt.name=r.getName("New"+opt.type),opt.text="",opt.focus=!0,opt.background={filltype:"image",image:t,imageType:"fill",color:"none"},opt.border={color:"none"},opt.editable=!0,e.widgets(opt.type,opt)},d=0;d<=s.length-1;d++)if(s[d].type.indexOf("image")>=0){var o={};n=225+20*d,i=200+20*d,t.offsetX?(o.x=t.offsetX-n,o.y=t.offsetY-i):(o.x=t.layerX-n,o.y=t.layerY-i);var g=new FileReader;g.onload=function(t){var n=this.result;if(r.targetwidget)if(r.targetwidget.background&&"image"==r.targetwidget.background.filltype)if(null==r.targetwidget.background.image||"string"==typeof r.targetwidget.background.image){var i=document.createElement("img");i.src=n,r.targetwidget.background.image=i}else r.targetwidget.background.image.src=n;else{var a=l(n);a.x=o.x/r.scale,a.y=o.y/r.scale,a.Scale(r.scale),a.appendPresenter(r),null!=r.focuswidget&&(r.focuswidget.focus=!1),r.focuswidget=a,e.command("new",r,a.persist())}else if("image"==r.rootwidget.background.filltype)if(e("#backgroundImage").attr("src",n),null==r.rootwidget.background.image||"string"==typeof r.rootwidget.background.image){var i=document.createElement("img");i.src=n,r.rootwidget.background.image=i}else r.rootwidget.background.image.src=n;else{var a=l(n);a.x=o.x/r.scale,a.y=o.y/r.scale,a.Scale(r.scale),a.appendPresenter(r),null!=r.focuswidget&&(r.focuswidget.focus=!1),r.focuswidget=a,e.command("new",r,a.persist())}r.paint()},g.readAsDataURL(s[d])}mydesigner.updatePropertyEditor()}}(jQuery),function(e){visordocument=function(t,n){this.id=null,this.type="slideshow",this.name="",this.description="",this.activePanel=null,this.width=1510,this.height=1050,this.pagesize="1050X1510",this.pagedirection="horization",this.editable=!0,this.showRelation=!0,this.dpi=8,this.category=null,this.showthumbnail=!1,this.defaultconnectionType="brokenLineConnector-0322",this.defaulttableconnectionType="relationConnector-02120",this.defaultentityconnectionType="referenceConnector-012101",this.defaultmapconnectionType="mapConnector-0322",this.defaultfont={style:"normal",weight:"normal",family:"微软雅黑",size:"11pt",color:"black",fill:!0},this.accesscontrolsetting={type:"public",securitycode:"",enableapi:!1},this.acl={editable:!0},e.extend(this,n),riot.observable(this),this.parent=t;var i=this;this.findPanel=function(e){for(var t=0;t<=this.panels.length-1;t++)if(this.panels[t].instance.rootwidget.name===e)return this.panels[t];return null},this.getName=function(e){var t="slide";1===arguments.length&&(t=e);for(var n=1;null!=this.findPanel(t+n);)n++;return t+n},this.newpage=function(){var n={name:i.getName(this.prefix||"slide"),title:i.getName(this.prefix||"slide"),width:i.width,dpi:i.dpi,aligngrid:!1,height:i.height,background:{filltype:"color",image:null,color:"#ffffff"},widgets:[]},a=new visorpanel(t,n,this);return i.panels.push(a),i.activePanel=a,a.on("_triggerEvent",function(e,t,n){i.trigger(e,t,n)}),e(a.instance.canvas).attr("ondrop","drop(event)").attr("ondragover","allowDrop(event)"),a},this.restorePanel=function(n){var a=[];if(n){var s=JSON.parse(n);s.join?a=s:s.panels&&(a=s.panels),this.accesscontrolsetting=s.accesscontrolsetting}this.panels=[],e(a).each(function(n,a){a.editable=i.editable;var s=new visorpanel(t,a,i);i.panels.push(s),s.instance.rootwidget.name===i.activePanel&&(i.activePanel=s),s.on("_triggerEvent",function(e,t,n){i.trigger(e,t,n)}),e(s.instance.canvas).attr("ondrop","drop(event)").attr("ondragover","allowDrop(event)")})},this.restorePanel(this.content),delete this.content,0==this.panels.length&&(this.newpage(),this.name=this.name||this.getName(this.type)),this.restoreDocument=function(t){e.extend(this,t),this.restorePanel(this.content),delete this.content},this.restoreSchema=function(e){for(var t=this.newpage(),n=100,i=100,o=[],r=0;r<=e.schema.tables.length-1;r++){var c=e.schema.tables[r],l=new table({x:n,y:i,name:c.table_name,text:c.table_name,editable:!0}).appendPresenter(t.instance);n+=180,i+=30,n>=this.activePanel.instance.width/2&&(n=100,i+=100),l.fieldclickEvent=visordesigner.fieldclickEvent;for(var d=0;d<=c.fields.length-1;d++){var g=c.fields[d];if("PRI"==g.key)l.newpk({name:g.field_name,text:g.field_name,data:{datatype:s(g.data_type),isfk:!!g.foreign_key_table}});else{l.newfield({name:g.field_name,text:g.field_name,data:{datatype:s(g.data_type),isfk:!!g.foreign_key_table}})}if(g.foreign_key_table){var p={target:l.name,source:g.foreign_key_table,source_column:g.foreign_key_column,target_column:g.field_name};o.push(p)}}}for(var r=0;r<=o.length-1;r++){var h=this.activePanel.instance.Widget(o[r].source),u=this.activePanel.instance.Widget(o[r].target);a(h,u)}console.info(o),l.paint()};var a=function(t,n){var a=i.activePanel.instance.getName("R"),s=i.defaulttableconnectionType,o=s.substring(0,s.indexOf("-")),r=s.substring(s.indexOf("-")+1,s.length),c=r.substring(0,1),l="none";"1"===c?l="dot":"2"===c&&(l="arrow");var d=parseInt(r.substring(1,2));c=r.substring(2,3);var g="none";"1"===c?g="dot":"2"===c&&(g="arrow");var p=parseInt(r.substring(3,4)),h=e.connector(o,{name:a,text:a,begin:new endpoint({x:t.width/2,y:t.height/2,shape:{name:l,type:d},position:"top",widget:t}),end:new endpoint({x:n.width/2,y:n.height/2,shape:{name:g,type:p},widget:n}),editable:!0});if(r.length>4)if(linetype=r.substring(4,5),"0"==linetype?h.border.type="solid":"1"==linetype?h.border.type="dotted":"2"==linetype&&(h.border.type="dashed"),"relationConnector"===o)h.key.identifying="0"===linetype;else if("referenceConnector"===o){var u=r.substring(5,6);"1"===u?h.key.type="one-to-one":"2"===u?h.key.type="one-to-many":"3"===u?h.key.type="many-to-one":"4"===u&&(h.key.type="many-to-many")}h.begin.widget.connections.push(h),h.end.widget.connections.push(h),h.appendPresenter(i.activePanel.instance),e.command("new",i.activePanel.instance,h.persist())},s=function(e){return e=e.toLowerCase(),"int"==e?"integer":"float"==e||"double"==e||"decimal"==e?"number":e};this.createWidget=function(t){var n={style:"normal",weight:"normal",family:"verdana",size:"11pt",color:"black",fill:!0};e.extend(n,this.defaultfont);var i,a;if(t=t.substring(t.indexOf(":")+1,t.length),0==t.indexOf("custom:")){var s=t.substring("7",t.length);widgetModel=e.restfulService(ctx+"/api/visorwidget/",{async:!1,retrieveUrl:ctx+"/api/visorwidget/"+s});var o=widgetModel.items()[0];i=JSON.parse(o.content),i.name=this.activePanel.instance.getName(i.type),null!=i.background.image&&null==i.background.filltype&&(i.background.filltype="image"),i.text=i.text,i.focus=!0,i.editable=!0,i.click=visordesigner.widgetClickEvent,a=i.type}else if(0==t.indexOf("image:")){var r=t.split(";"),c=r[0].split(":")[1],l=200;r[1]&&(l=r[1].split(":")[1]),i={},i.type="box",i.width=parseInt(l),i.height=parseInt(l),i.name=this.activePanel.instance.getName(i.type),i.text="",i.focus=!0,i.background={filltype:"image",image:c,imageType:"fill",color:"none"},i.border={color:"none"},i.editable=!0,a=i.type}else{var d,g={};t.indexOf(":")<0?a=t:(a=t.substring(0,t.indexOf(":")),g=JSON.parse(t.substring(t.indexOf(":")+1,t.length))),d=this.activePanel.instance.getName("New"+a.slice(0,1).toUpperCase()+a.slice(1)),i={name:d,text:d,focus:!0,editable:!0,font:n},e.extend(i,g)}return e.widgets(a,i)},this.size=function(){return this.panels.length}},visorpanel=function(t,n,i){var a=n.name,s=n.title,o=n.width,r=n.type,c=n.height,l=n.showgrid||!1,d=n.pagesize,g=n.pagein,p=n.pageout,h=n.pagedirection,u=n.dom,f=n.editable||!1,m=n.scale||1,v=n.aligngrid||!1,w={};this.parent=e(t),this.document=i,e.extend(w,n.background);var y,b=this;u||(u=e("<div></div>").addClass("designer").attr("id",a).css("left",200).css("top",200).css("position","relative").css("width",o).css("height",c),this.parent.find(".designer").hide(),this.parent&&u.appendTo(this.parent)),this.copy=function(){y.focuswidget&&(this.document.copyObj=y.focuswidget.persist(),y.focuswidget.fieldclickEvent&&(this.document.copyObj.fieldclickEvent=y.focuswidget.fieldclickEvent))},this.paste=function(){if(null!=this.document.copyObj){y.focuswidget&&(y.focuswidget.focus=!1),this.document.copyObj.x+=25,this.document.copyObj.y+=25,this.document.copyObj.name=y.getName(this.document.copyObj.type);var t=e.widgets(this.document.copyObj.type,this.document.copyObj).appendPresenter(y);y.focuswidget=t,t.focus=!0,t.editable=!0,b.trigger("_triggerEvent","updatePropertyEditor",y),t.paint()}},y=e.presenter({name:a,title:s,width:o,type:r,height:c,showgrid:l,aligngrid:v,pagesize:d,pagein:g,pageout:p,pagedirection:h,dom:u,editable:b.editable,scale:m||1,background:w,imageload:function(){b.trigger("_triggerEvent","imageload",y)},click:function(e){if(y.focuswidget&&y.focuswidget.type.indexOf("Connector")>0){var t=y.focuswidget;(e.originalEvent.ctrlKey||"slideshow"===b.type)&&(0===t.resizer?(t.begin.x=t.begin.widget.width/2,t.begin.y=t.begin.widget.height/2,t.paint()):t.resizer===t.resizers.length-1&&(t.end.x=t.end.widget.width/2,t.end.y=t.end.widget.height/2,t.paint()))}b.trigger("_triggerEvent","panel_click",e,y)},keypress:function(e){var t=e.keyCode,n=e.ctrlKey,i=e.ctrlKey?y.dpi:1,a=!0;if(n&&67==t&&null!=y.focuswidget)b.copy();else if(n&&86==t&&null!=b.document.copyObj)b.paste();else if(n&&88==t&&null!=y.focuswidget)b.copy(),y.deleteFocus(),b.document.trigger("cutwidget");else if(46==t&&null!=y.focuswidget)y.deleteFocus();else if(y.selectwidgets.length>0)if(38===t)for(var s=0;s<=y.selectwidgets.length-1;s++)y.selectwidgets[s].y-=i;else if(40===t)for(var s=0;s<=y.selectwidgets.length-1;s++)y.selectwidgets[s].y+=i;else if(37===t)for(var s=0;s<=y.selectwidgets.length-1;s++)y.selectwidgets[s].x-=i;else if(39===t)for(var s=0;s<=y.selectwidgets.length-1;s++)y.selectwidgets[s].x+=i;else a=!1;else null!=y.focuswidget&&y.focuswidget.editable?38===t?y.focuswidget.y-=i:40===t?y.focuswidget.y+=i:37===t?y.focuswidget.x-=i:39===t?y.focuswidget.x+=i:a=!1:a=!1;if(b.trigger("_triggerEvent","keypress",e,y),a)return e.preventDefault(),e.stopPropagation(),y.paint(),!1},afterPaint:function(e){b.trigger("_triggerEvent","afterPaint",null,e)}});for(var P=[],x=0;x<n.widgets.length;x++)if(null!=n.widgets[x].begin&&null!=n.widgets[x].end&&n.widgets[x].type.indexOf("Connector")>0)P.push(n.widgets[x]);else{var k=e.widgets(n.widgets[x].type,n.widgets[x]);k.editable=f,k.appendPresenter(y),"table"!=k.type&&"entity"!=k.type&&"collection"!=k.type||(k.fieldclickEvent=function(e,t){b.trigger("_triggerEvent","fieldclickEvent",e,this)})}for(var x=0;x<=P.length-1;x++){var k=e.widgets(P[x].type,P[x]);k.editable=f,k.begin&&k.begin.widget&&(k.begin.widget=y.Widget(k.begin.widget)),k.end&&k.end.widget&&(k.end.widget=y.Widget(k.end.widget)),k.begin.widget&&k.end.widget&&(k.begin.widget.connections.push(k),k.end.widget.connections.push(k),k.appendPresenter(y))}var j=new Map;n.animations&&e(n.animations.elements).each(function(t,n){var i=n.value.widget,a=y.Widget(i);if(null!=a){n.value.widget=a;var s=e.animation(n.value);j.put(n.key,s)}}),y.animations=j,this.instance=y;for(var x=0;x<=this.instance.widgets.length-1;x++){var k=this.instance.widgets[x];console.info(k.name+"-"+k.height);for(var E=0;E<=k.widgets.length-1;E++)console.info(k.widgets[E].name+"-"+k.widgets[E].height)}riot.observable(this),y.adddefaultconnection=function(t){var n;if("connection"==this.targetwidget.type&&this.targetwidget.widgets.length>0){var i=this.targetwidget.findtargets(t);i.length>0&&(n=i[i.length-1])}var a=this.getName("R"),s="right";1===this.connectionPoint?s="top":3===this.connectionPoint?s="bottom":4===this.connectionPoint&&(s="left");var o=b.document.defaultconnectionType;"table"===this.focuswidget.type&&"table"===this.targetwidget.type?o=b.document.defaulttableconnectionType:"entity"===this.focuswidget.type&&"entity"===this.targetwidget.type&&(o=b.document.defaultentityconnectionType),"table"===this.focuswidget.type&&"collection"===this.targetwidget.type&&(o=b.document.defaultmapconnectionType);var r=o.substring(0,o.indexOf("-")),c=o.substring(o.indexOf("-")+1,o.length),l=c.substring(0,1),d="none";"1"===l?d="dot":"2"===l&&(d="arrow");var g=parseInt(c.substring(1,2));l=c.substring(2,3);var p="none";"1"===l?p="dot":"2"===l&&(p="arrow");var h=parseInt(c.substring(3,4));if(currentconnector=e.connector(r,{name:a,text:a,begin:new endpoint({x:this.focuswidget.width/2,y:this.focuswidget.height/2,shape:{name:d,type:g},position:s,widget:this.focuswidget}),end:new endpoint({x:this.targetwidget.width/2,y:this.targetwidget.height/2,shape:{name:p,type:h},widget:this.targetwidget}),editable:!0}),c.length>4)if(linetype=c.substring(4,5),"0"==linetype?currentconnector.border.type="solid":"1"==linetype?currentconnector.border.type="dotted":"2"==linetype&&(currentconnector.border.type="dashed"),"relationConnector"===r)currentconnector.key.identifying="0"===linetype;else if("referenceConnector"===r){var u=c.substring(5,6);"1"===u?currentconnector.key.type="one-to-one":"2"===u?currentconnector.key.type="one-to-many":"3"===u?currentconnector.key.type="many-to-one":"4"===u&&(currentconnector.key.type="many-to-many")}currentconnector.begin.widget.connections.push(currentconnector),currentconnector.end.widget.connections.push(currentconnector),currentconnector.appendPresenter(this),e.command("new",this,currentconnector.persist()),null!=currentconnector.onconnected&&(currentconnector.onconnected(n),currentconnector.key&&(currentconnector.key.name=currentconnector.name))};!function(){y.canvas.addEventListener("keydown",function(e){b.instance._triggerEvent("keypress",e)},!0)}();!function(){e(y.canvas).contextmenu({target:"#context-menu",onItem:function(t,n){var i=y.focuswidget,a=e(n.target).attr("alt");if("paste"===a&&b.document.copyObj)b.paste();else if("savepicture"===a)if(i){var s=i.getImageData(0,0);Downloader.save(s,i.name+".png")}else{var o=y.rootwidget.getImageData(0,0);Downloader.save(o,y.title+".png")}if(i)if("copy"===a&&b.copy(),"newitem"===a&&i.newfield(),"cut"===a)b.copy(),y.deleteFocus(),b.document.trigger("cutwidget");else if("duplicate"===a)b.copy(),b.paste();else if("save"===a)y.paint(),b.document.saveaswidget();else if("edit"===a)b._triggerEvent("dblclick",n),this.closemenu();else if("delete"===a){var r=y.focuswidget;r&&"treeNode"==r.type?r.deletefield():r&&r.parent.deletefield?r.parent.deletefield(r):y.deleteFocus(),b.document.trigger("deletewidget")}else"bring to front"===a?(y.focuswidget.topDepth(),y.paint()):"send to back"===a?(y.focuswidget.downDepth(),y.paint()):"goup one step"===a?(y.focuswidget.topStep(),y.paint()):"godown one step"===a&&(y.focuswidget.downStep(),y.paint());else y.selectwidgets.length>0&&"delete"===a&&(y.deleteFocus(),b.trigger("deletewidget"))},before:function(t,n,i){t.preventDefault(),e("#context-menu").find("a").css("color","");var a=y.focuswidget;return null==a||null!=a&&"entity"!==a.type&&"table"!==a.type&&"collection"!==a.type&&"treeNode"!==a.type?(e("#context-menu").find("a[alt='newitem']").hide(),e("#context-menu").find("a[alt='edit']").show()):(e("#context-menu").find("a[alt='newitem']").show(),e("#context-menu").find("a[alt='edit']").hide()),null==a?(t.preventDefault(),e("#context-menu").find("a").css("color","gray")):e("#context-menu").find("a[alt='save']").css("color","gray"),e("#context-menu").find("a[alt='savepicture']").css("color",""),y.selectwidgets.length>0&&e("#context-menu").find("a[alt='delete']").css("color",""),b.document.copyObj?e("#context-menu").find("a[alt='paste']").css("color",""):e("#context-menu").find("a[alt='paste']").css("color","gray"),!0}})}()},visorpanel.prototype.listTables=function(){var e=[],t=[],n=[];n=this.selectwidgets,0===n.length&&(n=this.widgets);for(var i=0;i<=n.length-1;i++)if("table"==n[i].type){var a=n[i];e.push(a.getdata());for(var s=0;s<=a.connections.length-1;s++){var o=a.connections[s];if(console.info(o.type),"relationConnector"===o.type&&a==o.begin.widget){var r=o.key;r.source_owner=o.begin.widget.settings.owner,r.source_prefix=o.begin.widget.settings.prefix,r.source=o.begin.widget.name,r.target_owner=o.end.widget.settings.owner,r.target_prefix=o.end.widget.settings.prefix,r.target=o.end.widget.name,r.elements=o.fieldmaps.elements,t.push(r)}}}var c={};return c.tables=e,c.connections=t,c.option={},c.option.datetime=new Date,c},visorpanel.prototype.listEntities=function(){var e=[],t=[];t=this.instance.selectwidgets,0===t.length&&(t=this.instance.widgets);for(var n=0;n<=t.length-1;n++)if("entity"==t[n].type){var i=t[n];e.push(i.getdata())}var a={};return a.entities=e,a.option={},a.option.datetime=new Date,a},visorpanel.prototype.listMapping=function(){for(var e=this.instance.widgets,t=[],n=0;n<=e.length-1;n++)if("mapConnector"==e[n].type){var i=e[n],a={from_table:i.begin.widget.name,to_table:i.objectdata.targetpath,join_condition:i.objectdata.matchcriteria.values,relationship:"Array"==i.objectdata.mappingtype?"ManyOne":"OneOne",target_path:""};if(i.objectdata.targetpath)var s=i.objectdata.targetpath.split(".");else var s=i.persist().objectdata.targetpath.split(".");a.target_path=i.objectdata.targetpath,a.to_table=s[s.length-1],s.length>1?a.to_table=s[s.length-2]:a.to_table=i.end.widget.name,"Array"==i.objectdata.mappingtype&&(a.match_condition=i.objectdata.matchcriteria.values),t.push(a)}return t},visorpanel.prototype.listwidgets=function(){var e=[],t=[];t=this.selectwidgets,0===t.length&&(t=this.instance.widgets);for(var n=0;n<=t.length-1;n++)if("note"==t[n].type){var i=t[n];e.push(i.persist())}e.sort();var a={};return a.widgets=e,a.name=this.activePanel.instance.name,a.option={},a.option.datetime=new Date,a},visordocument.prototype.persist=function(){var t={};t.id=this.id,t.version=this.version,t.type=this.type,t.description=this.description,t.createdBy=this.createdBy,t.createdDate=this.createdDate,t.lastModifiedBy=this.lastModifiedBy,t.lastModifiedDate=this.lastModifiedDate,t.fileCategoryId=this.fileCategoryId,t.name=this.name?this.name:this.getName(this.type),t.activePanel=this.activePanel.instance.rootwidget.name,
t.category=this.category,t.status=this.status,t.publishId=this.publishId,t.template=this.template;var n=this.activePanel.instance.rootwidget,i=Math.min(300,n.width),a=Math.min(300,n.height);this.cover&&this.cover.indexOf("data:image")<0?t.cover=this.cover:t.cover=this.activePanel.instance.rootwidget.getImageData(0,0,null,null,i,a);for(var s=[],o=[],r=0;r<this.panels.length;r++){var c=this.panels[r],l=c.instance.persist();if(null!=c.instance.animations){var d=new Map;e(c.instance.animations.elements).each(function(e,t){var n=t.value.persist();d.put(t.key,n)}),l.animations=d}s.push(l);var g=c.listMapping();e(g).each(function(e,t){o.push(t)})}var p={};return p.panels=s,this.accesscontrolsetting&&(p.accesscontrolsetting={},e.extend(p.accesscontrolsetting,this.accesscontrolsetting)),t.content=JSON.stringify(p),t.data=JSON.stringify(o),t}}(jQuery),function(e){e.command=function(e,t){return"new"===e?new newcommand(arguments[1],arguments[2]):"delete"===e?new deletecommand(arguments[1],arguments[2]):"move"===e?new movecommand(arguments[1],arguments[2],arguments[3],arguments[4]):"change"===e?new propertychangecommand(arguments[1],arguments[2],arguments[3]):void 0};var t=function(t){var n={name:"command",target:null,presenter:null};return e.extend(n,t),e.extend(this,n),this.type="command",this.undo=function(){},this.redo=function(){},this};newcommand=function(n,i){var a={name:n.getName("newCommand"),presenter:n,target:i};return e.extend(this,new t(a)),this.undo=function(){var e=this.presenter.Widget(this.target.name);e&&this.presenter.removeWidget(e).paint()},this.redo=function(){e.widgets(this.target.type,this.target).appendPresenter(this.presenter).paint()},n.history.push(this),this},deletecommand=function(n,i){var a={name:n.getName("deletecommand"),target:i,presenter:n};return e.extend(this,new t(a)),this.redo=function(){if("object"!=typeof this.target||this.target.length){if("object"==typeof this.target&&this.target.length&&this.target.length>1){var t=this;e(this.target).each(function(e,n){if(n.type.indexOf("connector")<0){var i=t.presenter.Widget(n.name);i&&t.presenter.removeWidget(i,!0)}}),this.presenter.paint()}}else{var n=this.presenter.Widget(this.target.name);n&&this.presenter.removeWidget(n,!0).paint()}},this.undo=function(){if("object"!=typeof this.target||this.target.length){if("object"==typeof this.target&&this.target.length&&this.target.length>0){for(var t=this,n=[],i=0;i<this.target.length;i++)if(null!=this.target[i].begin&&null!=this.target[i].end&&this.target[i].type.indexOf("Connector")>0)n.push(this.target[i]);else{var a=e.widgets(this.target[i].type,this.target[i]);a.editable=!0,a.appendPresenter(t.presenter)}for(var i=0;i<=n.length-1;i++){var a=e.widgets(n[i].type,n[i]);a.editable=t.editable,a.begin&&a.begin.widget&&(a.begin.widget=t.presenter.Widget(a.begin.widget)),a.end&&a.end.widget&&(a.end.widget=t.presenter.Widget(a.end.widget)),a.begin.widget&&a.end.widget&&(a.begin.widget.connections.push(a),a.end.widget.connections.push(a),a.appendPresenter(t.presenter))}this.presenter.paint()}}else this.target.editable=!0,e.widgets(this.target.type,this.target).appendPresenter(this.presenter).paint()},n.history.push(this),this},movecommand=function(n,i,a,s){var o={name:n.getName("movecommand"),target:i,presenter:n};return e.extend(this,new t(o)),this.undo=function(){var e=n.Widget(this.target);e.x=a.x,e.y=a.y,e.width=a.width,e.height=a.height,e.paint()},this.redo=function(){var e=n.Widget(this.target);e.x=s.x,e.y=s.y,e.width=s.width,e.height=s.height,e.paint()},n.history.push(this),this},propertychangecommand=function(n,i,a){var s={name:n.getName("propertychangecommand"),target:i,presenter:n};return e.extend(this,new t(s)),this.undo=function(){var t=this.presenter.Widget(a.name);i.background&&e.extend(t.background,i.background),i.border&&e.extend(t.border,i.border),i.tail&&e.extend(t.tail,i.tail),i.shadow&&e.extend(t.shadow,i.shadow),i.font&&e.extend(t.font,i.font),i.functionPoints.length>0&&e.extend(t.functionPoints,i.functionPoints),n.paint()},this.redo=function(){var t=this.presenter.Widget(i.name);a.background&&e.extend(t.background,a.background),a.border&&e.extend(t.border,a.border),a.tail&&e.extend(t.tail,a.tail),a.shadow&&e.extend(t.shadow,a.shadow),a.font&&e.extend(t.font,a.font),a.font.functionPoints.length>0&&e.extend(t.functionPoints,a.functionPoints),n.paint()},n.history.push(this),this}}(jQuery),function(e){player=function(t){this.parent=e("document"),this.panels=[],this.activePanel=null,this.pageindex=0,this.scale=1,this.scaleType=1,this.timeout=3e3,this.updateinfo=null,this.id=null,this.showtype=-1,this.name="",this.speed=1e3,this.loops=!1,this.playhandler=null,this.enableAnimation=!0,e.extend(this,t);var n=t.currentdoc||null;"string"==typeof this.parent&&(this.parent=e(this.parent)),this.init(n);var i=!1,a=0,s=0,o={x:0,y:0};this.mousemove=function(n){var r=this,c=r.activePanel.targetwidget;if(!c||!c.hyperlink||""==c.hyperlink.url&&""==c.hyperlink.window||c.editable?c&&"noticeboard"===c.type&&""!=c.tooltip.text?(r.activePanel.Cursor("pointer"),i=!0,console.info("showtips")):(r.activePanel.Cursor("default"),i&&(console.info("no active widget"),r.activePanel.paint(),i=!1)):r.activePanel.Cursor("pointer"),0===n.button&&1===n.buttons){a=n.originalEvent.clientX-o.x,s=n.originalEvent.clientY-o.y,o.x=n.originalEvent.clientX,o.y=n.originalEvent.clientY;var l=e(this.parent).scrollLeft()-a,d=e(this.parent).scrollTop()-s;e(this.parent).scrollLeft(l),e(this.parent).scrollTop(d)}t.mousemove&&t.mousemove(n)},this.mouseup=function(e){t.mouseup&&t.mouseup(e)},this.mousedown=function(e){0===e.button&&(o.x=e.originalEvent.clientX,o.y=e.originalEvent.clientY),t.mousedown&&t.mousedown(e)},this.click=function(e){t.click&&t.click.call(this,e)}},player.prototype.setKeypress=function(e){var t=this;t.activePanel.canvas.addEventListener("keydown",function(e){t.activePanel._triggerEvent("keypress",e)},!0)},player.prototype.playGlobalAnimation=function(){this.activePanel.globalAnimations&&(e(this.activePanel.globalAnimations).each(function(e,t){t.run()}),this.playAnimation())},player.prototype.pageIn=function(e,t){var n=this,i=null;i=this.findPanel(e);var a=this.parent.find("#"+e),s=-1===t?Math.round(3*Math.random()+1):t,o=n.parent.css("width");n.parent.css("height");o=parseInt(o.substring(0,o.length-2));var r=parseInt(a.find("canvas").attr("height")),c=document.body.clientHeight/i.height+.05;this.scale=parseFloat(c.toFixed(1)),this.Scale(this.scale);var l=function(){n.updateInfo&&n.updateInfo(),n.playGlobalAnimation()};if(n.prepareEnter&&n.enableAnimation&&n.prepareEnter(),2===s){var d=o;a.css("left",+d).show().animate({left:0},n.speed,l)}else if(1===s){var d=o;a.css("left",-d).show().animate({left:0},n.speed,l)}else if(4===s){var d=r;a.css("top",-d).show().animate({top:0},n.speed,l)}else if(3===s){var d=r;a.css("top",d).show().animate({top:0},n.speed,l)}else if(5===s){var d=r;a.css("top",d).css("left",-d).show().animate({top:0,left:0},n.speed,l)}else if(6===s){var d=r;a.css("top",-d).css("left",-d).show().animate({top:0,left:0},n.speed,l)}else if(7===s){var d=r;a.css("top",d).css("left",d).show().animate({top:0,left:0},n.speed,l)}else if(8===s){var d=r;a.css("top",-d).css("left",d).show().animate({top:0,left:0},n.speed,l)}else 9===s&&a.css("top",0).css("left",0).css("opacity",.1).show().animate({opacity:1},n.speed,l)},player.prototype.setActive=function(t){var n,i=this;if(!this.changing){"number"==typeof t?(n=this.panels[t].pageinStyle,t=this.panels[t].rootwidget.name):n=this.findPanel(t).pageinStyle||-1,n=n||-1;for(var a=0;a<this.panels.length;a++)if(this.panels[a].rootwidget.name===t){this.activePanel=this.panels[a],this.pageindex=a;break}var s=this.parent.find(".section:visible");if(s.size()>1)s.hide(),i.pageIn(t,n);else{var o=this.parent.find(".section:visible"),r=this.findPanel(o.attr("id")),c=r.pageoutStyle||-1;this.showtype>0&&(c=this.showtype);var l=-1===c?Math.round(4*Math.random()+1):c,d=document.body.clientWidth,g=document.body.clientHeight;o.attr("id")!=t?(this.changing=!0,2===l?(i.distance=d,o.animate({left:-i.distance},i.speed,function(){e(this).hide().css("left",0).appendTo(i.parent),i.pageIn(t,n),i.changing=!1})):1===l?(i.distance=d,o.animate({left:i.distance},i.speed,function(){e(this).hide().css("left",0).appendTo(i.parent),i.pageIn(t,n),i.changing=!1})):4===l?(i.distance=g,o.animate({top:i.distance},i.speed,function(){e(this).hide().css("top",0).appendTo(i.parent),i.pageIn(t,n),i.changing=!1})):3===l?(i.distance=g,o.animate({top:-i.distance},i.speed,function(){e(this).hide().css("top",0).appendTo(i.parent),i.pageIn(t,n),i.changing=!1})):5===l?(i.distance=g,o.animate({top:-i.distance,left:i.distance},i.speed,function(){e(this).hide().css("top",0).css("left",0).appendTo(i.parent),i.pageIn(t,n),i.changing=!1})):6===l?(i.distance=g,o.animate({top:-i.distance,left:-i.distance},i.speed,function(){e(this).hide().css("top",0).css("left",0).appendTo(i.parent),i.pageIn(t,n),i.changing=!1})):7===l?(i.distance=g,o.animate({top:i.distance,left:i.distance},i.speed,function(){e(this).hide().css("top",0).css("left",0).appendTo(i.parent),i.pageIn(t,n),i.changing=!1})):8===l?(i.distance=g,o.animate({top:i.distance,left:-i.distance},i.speed,function(){e(this).hide().css("top",0).css("left",0).appendTo(i.parent),i.pageIn(t,n),i.changing=!1})):9===l&&(i.distance=g,o.animate({opacity:.2},i.speed,function(){e(this).hide().css("top",0).css("left",0).css("opacity",1).appendTo(i.parent),i.pageIn(t,n),i.changing=!1}))):(this.activePanel.Scale(this.scale),i.pageIn(t,n));for(var a=0;a<this.panels.length;a++)if(this.panels[a].rootwidget.name===t){this.activePanel=this.panels[a],this.pageindex=a;break}i.activePanel.designer=this,i.activePanel.paint()}}},player.prototype.init=function(t){var n=this,i=this.id?this.id:e.queryString("id"),a=t;if(void 0!==i)e.restfulService(ctx+"/api/visordocument",{async:!0,retrieveUrl:ctx+"/api/visordocument/"+i,callback:function(e){a=e,a&&"undefined"!=a&&(n.name=a.name,n.description=a.description,n.restorePanel(a),n.setActive(0)),n.success&&"function"==typeof n.success&&n.success(),n.Scale(n.scale)}});else{if(null===a){var s=localStorage.getItem("visordesigner");a=JSON.parse(s)}else if(null===a){var s=localStorage.getItem("currentDoc_"+this.type);a=JSON.parse(s)}a&&"undefined"!=a&&(this.name=a.name,this.description=a.description,this.restorePanel(a),this.setActive(0)),this.success&&"function"==typeof this.success&&this.success(),this.Scale(this.scale)}return this},player.prototype.buildGif=function(e){for(var t=new GIF({workers:this.panels.length,workerScript:ctx+"/res/js/gif.worker.js",quality:10}),n=0;n<=this.panels.length-1;n++)t.addFrame(this.panels[n].canvas,{delay:3e3});t.on("finished",function(t){e?e(t):window.open(URL.createObjectURL(t))}),t.render()},player.prototype.playAnimation=function(){function e(){var n=t.activePanel;TWEEN.getAll().length>0&&requestAnimFrame(e),TWEEN.update(),n.paint()}var t=this;e()},player.prototype.next=function(){var e=this,t=function(){var t=!0;e.pageindex<e.size()-1?(e.pageindex+=1,t=!1):e.loops&&(e.pageindex=0,t=!1),t?e.end&&e.end():e.setActive(e.pageindex)};if(this.activePanel.totalsteps>0&&this.activePanel.step==this.activePanel.totalsteps||0==this.palyAnimation)t();else if(this.activePanel.totalsteps>0&&this.activePanel.step<this.activePanel.totalsteps){var n=this.activePanel.animations.elements[this.activePanel.step].value;for(n.enter(),this.activePanel.step++;this.activePanel.step<this.activePanel.totalsteps&&!n.paused;)n=this.activePanel.animations.elements[this.activePanel.step].value,n.enter(),this.activePanel.step++;this.playAnimation()}else t()},player.prototype.prev=function(){this.pageindex>0&&(this.pageindex-=1,this.setActive(this.pageindex))},player.prototype.play=function(){var t=this;this.playhandler=setInterval(function(){t.next()},this.timeout),e(".btn-play").html('<i class="fa fa-2x fa-pause"></i>')},player.prototype.Scale=function(t){if(1!==arguments.length)return this.scale;this.scale=t;for(var n=0;n<=this.panels.length-1;n++){var i=t;2==this.scaleType?i=this.width/this.panels[n].canvas.width:3==this.scaleType&&(i=this.height/this.panels[n].canvas.height),this.panels[n].Scale(i),e(this.panels[n].canvas).css("height",this.panels[n].canvas.height*i).css("width",this.panels[n].canvas.width*i)}},player.prototype.Zoom=function(e){if(1!==arguments.length)return this.scale;this.scale=e;for(var t=0;t<=this.panels.length-1;t++)this.panels[t].rootwidget.scaleX=e,this.panels[t].rootwidget.scaleY=e},player.prototype.stop=function(){this.playhandler&&(window.clearInterval(this.playhandler),this.playhandler=null,e(".btn-play").html('<i class="fa fa-2x fa-play"></i>'))},player.prototype.newPanel=function(t,n){var i=this;return panel=e.presenter({name:t.name,name:t.name,width:t.width,height:t.height,type:t.type,dom:n,pageinStyle:parseInt(t.pageinStyle),pageoutStyle:parseInt(t.pageoutStyle),showgrid:t.showgrid,imageload:function(){setTimeout(function(){i.activePanel.paint()},100)},scale:t.scale,background:t.background,click:function(e){t.click&&t.click.call(i,e),i.click&&i.click.call(i,e)},mousedown:function(e){i.mousedown&&i.mousedown.call(i,e)},mouseup:function(e){i.mouseup&&i.mouseup.call(i,e)},mousemove:function(e){i.mousemove&&i.mousemove.call(i,e)}}),this.panels.push(panel),this.activePanel=panel,this.setKeypress(),e(panel.canvas).attr("ondrop","drop(event)").attr("ondragover","allowDrop(event)"),panel},player.prototype.size=function(){return this.panels.length},player.prototype.findPanel=function(e){for(var t=0;t<=this.panels.length-1;t++)if(this.panels[t].rootwidget.name===e)return this.panels[t];return null},player.prototype.restorePanel=function(t){var n,i=JSON.parse(t.content);n=i.join?i:i.panels,this.id=t.id,this.name=t.name;var a=this;e(n).each(function(t,n){for(var i=e("<div class='section' id='"+n.name+"' style='position:relative'></div>").appendTo(a.parent),s=[],o=a.newPanel(n,i),t=0;t<n.widgets.length;t++)if(null!=n.widgets[t].begin&&null!=n.widgets[t].end)s.push(n.widgets[t]);else{n.widgets[t].click=player.widgetClickEvent;var r=e.widgets(n.widgets[t].type,n.widgets[t]);r.editable=a.editable,r.appendPresenter(o)}for(var t=0;t<=s.length-1;t++){var r=e.widgets(s[t].type,s[t]);r.editable=a.editable,r.begin&&r.begin.widget&&(r.begin.widget=o.Widget(r.begin.widget)),r.end&&r.end.widget&&(r.end.widget=o.Widget(r.end.widget)),r.appendPresenter(o)}var c=new Map;n.animations&&(e(n.animations.elements).each(function(t,n){var i=n.value.widget,a=o.Widget(i);if(null!=a){n.value.widget=a;var s=e.animation(n.value);c.put(n.key,s)}}),o.animations=c),o.totalsteps=c.elements.length,o.step=0,o.paint()})}}(jQuery);