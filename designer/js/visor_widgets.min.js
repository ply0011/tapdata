!function(t){var i=new Map,e="#cecfff";e="#8dc73e",t.register=function(t,e){if(i.containsKey(t))alert(t+" was already exist,please rename your widget");else{if("function"!=typeof e)return void alert(t+" is not a widget");try{i.put(t,e)}catch(t){alert(t)}}},t.widgets=function(t,e){return i.containsKey(t)||(alert(t+" is not exist"),t="widget"),new(i.get(t))(e)},t.presenter=function(t){return new presenter(t||{})},widget=function(i){this.name="",this.x=0,this.y=0,this.version=1,this.width=275,this.height=140,this.minwidth=36,this.minheight=36,this.alpha=1,this.editable=!1,this.visible=!0,this.scaleX=1,this.scaleY=1,this.scale=1,this.gradient={type:"liner",begincolor:"white",endcolor:"#9dd6ea",angle:90,radius:45},this.background={filltype:"color",color:"none",image:null,imageType:"center"},this.corner={type:"rect",radius:16},this.border={width:1,type:"solid",color:"none"},this.shadow={color:"none",offsetX:4,offsetY:4,blur:4},this.rotate=0,this.rotatepoint={x:0,y:0,offsetx:0,offsety:0},this.font={style:"normal",weight:"normal",family:"Arial",size:"10pt",color:"black",fill:!0},this.margin=5,this.widgets=[],this.presenters=[],this.mousedown=null,this.mousemove=null,this.mouseup=null,this.mouseover=null,this.mouseout=null,this.click=null,this.resize=null,this.afterresize=null,this.afterfunctionPoint=null,this.dblclick=null,this.imageload=null,this.ondelete=null,this.selectable=!0,this.allowconnectionPoint=!0,this.allowRotate=!0,this.allowResizer=!0,this.functionPoints=[],this.type="widget",t.extend(!0,this,i),this.direction=1,this.root=null,this.parent=null,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=this.width,this.canvas.height=this.height,this.setResizers(),this.widgets.length>0&&(this._widgets=[],t.extend(this._widgets,this.widgets),this.widgets.splice(0,this.widgets.length),this.includeChildren&&this.restoreChildren(this._widgets,{editable:this.editable}),delete this._widgets),this.connections=[],null!=this.background&&"image"===this.background.filltype&&"string"==typeof this.background.image&&this.Background(this.background),this.propertyEditors=["common","border","corner","font","background","shadow","hyperlink","paragraph"]},widget.prototype.Background=function(t,i){if(arguments.length>=1){if(this.background=t,null!=this.background&&"image"===this.background.filltype&&"string"==typeof this.background.image){var e=this.background.image;this.background.image=null;var s=this,h=document.createElement("img"),n=document.createElement("canvas"),o=n.getContext("2d");h.addEventListener("load",function(t){n.height=h.height,n.width=h.width,o.drawImage(h,0,0);var e=n.toDataURL("image/png");s.background.image?s.background.image.src!=e&&(s.background.image.src=e):(h.removeEventListener("load",this),s.background.image=t.target,s.background.image.src=e),null!=i?i():null!=s.imageload?s.imageload.call(s):s.visible&&!s.silence&&s.paint({action:"loading image"})},!0),h.src=e}return this}return this.background},widget.prototype.Scale=function(t){if(1===arguments.length){this.scale=t;for(var i=0;i<=this.widgets.length-1;i++)this.widgets[i].Scale(t);return this}return this.scale},widget.prototype.equals=function(t){for(var i in t)if("object"!=typeof t[i]&&t[i]!=this[i])return!1;return!0},widget.prototype.setResizers=function(){this.resizers=[{x:0,y:0,cursor:"nw-resize",visible:!0},{x:this.width,y:0,cursor:"ne-resize",visible:!0},{x:0,y:this.height,cursor:"ne-resize",visible:!0},{x:this.width,y:this.height,cursor:"nw-resize",visible:!0}],this.setConnectionPoints(),this.setRotateKeyPoint()},widget.prototype.setConnectionPoints=function(){this.connectionPoints=[{x:this.width/2,y:0,cursor:"crosshair",visible:!0},{x:this.width,y:this.height/2,cursor:"crosshair",visible:!0},{x:this.width/2,y:this.height,cursor:"crosshair",visible:!0},{x:0,y:this.height/2,cursor:"crosshair",visible:!0}]},widget.prototype.setRotateKeyPoint=function(){this.rotateKeyPoint={x:this.width/2,y:-20,cursor:"pointer",visible:!0}},widget.prototype.fontSize=function(){var t,i=/\d+/;return t="String"==typeof this.font?parseInt(i.exec(this.font)[0]):parseInt(i.exec(this.font.size)[0]),t=t||18},widget.prototype.checkPointIn=function(t,i,e){if(!this.visible)return!1;null!=this.root&&(e=e||this.root.scale),e||(e=1);var s=this.relativePoint(t,i,e),h=s.x,n=s.y,o=h>=0&&h<=this.width*e*this.scaleX&&n>=0&&n<=this.height*e*this.scaleY;if(!o){o=math.checkPointInfunctionPoint(this,t,i,e)>0||math.checkPointInRotateKeyPoint(this,t,i,e)}return o},widget.prototype.relativePoint=function(t,i,e){this.root&&(e=e||this.root.scale),e||(e=1);var s=math.angle(this.rotate),h=Math.cos(s),n=Math.sin(s),o=(t-this.rotatepoint.x*e)*h+(i-this.rotatepoint.y*e)*n+this.rotatepoint.x*e,r=(i-this.rotatepoint.y*e)*h-(t-this.rotatepoint.x*e)*n+this.rotatepoint.y*e;return{x:o-this.x*e,y:r-this.y*e}},widget.prototype.clean=function(){return this.ctx.clearRect(0,0,this.width,this.height),this},widget.prototype.persist=function(){return widget.persistproperty(this)},widget.persistproperty=function(i){var e={};e.name=i.name,e.version=i.version,e.visible=i.visible,e.x=i.x,e.y=i.y,e.width=i.width,e.height=i.height,e.minwidth=i.minwidth,e.minheight=i.minheight,e.alpha=i.alpha,e.type=i.type,e.margin=i.margin,e.rotate=i.rotate,e.text=i.text,e.scaleX=i.scaleX,e.scaleY=i.scaleY,e.scale=i.scale,e.editable=i.editable,e.allowResizer=i.allowResizer,e.allowConnectionPoint=i.allowConnectionPoint,e.allowRotate=i.allowRotate,e.functionPoints=[],i.functionPoints.length>0&&t.extend(!0,e.functionPoints,i.functionPoints),i.gradient&&(e.gradient={},t.extend(e.gradient,i.gradient)),i.background&&(e.background={},t.extend(e.background,i.background),i.background.image&&(e.background.image=i.background.image.src)),i.corner&&(e.corner={},t.extend(e.corner,i.corner)),i.border&&(e.border={},t.extend(e.border,i.border)),i.shadow&&(e.shadow={},t.extend(e.shadow,i.shadow)),i.rotatepoint&&(e.rotatepoint={},t.extend(e.rotatepoint,i.rotatepoint)),i.font&&(e.font={},t.extend(e.font,i.font)),i.hyperlink&&(e.hyperlink={},t.extend(e.hyperlink,i.hyperlink)),i.arrow&&(e.arrow={},t.extend(e.arrow,i.arrow)),e.widgets=[];for(var s=0;s<i.widgets.length;s++)e.widgets.push(i.widgets[s].persist());return e},widget.prototype.drawImageTo=function(t){var i=this,e=1;if(null!=i.background&&"image"==i.background.filltype){var s=i.background.image,h=i.background.imageType?i.background.imageType:"fit";if(s)if("fit"===h){var n,o=0,r=0,d=0;s.width>i.width?(o=i.width,(n=s.height/s.width*o)>i.height&&(n=i.height,o=s.width/s.height*n)):(n=i.height,(o=s.width/s.height*n)>i.width&&(o=i.width,n=s.height/s.width*o)),r=(i.width-o)/2,d=(i.height-n)/2,t.drawImage(s,r+e,d+e,o,n)}else if("repeat"===h){for(var o=i.width,n=i.height,r=0,d=0;;)if(t.drawImage(s,r+e,d+e,s.width,s.height),(r+=s.width)>o){if(!((d+=s.height)<n))break;r=0}}else if("fill"===h)t.drawImage(s,e,e,i.width,i.height);else if("center"===h){var o=s.width,n=s.height,r=0,d=0;r=(i.width-o)/2,d=(i.height-n)/2;var g=Math.abs(Math.min(0,r)),a=Math.abs(Math.min(0,d)),l=Math.min(o,i.width),w=Math.min(n,i.height),e=Math.max(r,0),c=Math.max(d,0);t.drawImage(s,g,a,l,w,e,c,l,w)}return this}},widget.prototype.calculateSize=function(t){var i=this.margin;return t.save(),null!=this.font&&this.text&&("String"==typeof this.font?t.font=this.font:t.font=this.font.style+" "+this.font.weight+" "+this.font.size+" "+this.font.family,t.strokeStyle=this.font.color||"black",t.fillStyle=this.font.color||"black",metrics=t.measureText(this.text),this.autosize?(this.width=Math.round(metrics.width+2*i),this.height=Math.round(this.fontSize()+2*i),this.setResizers()):(this.minwidth=Math.round(metrics.width+2*i),this.minheight=Math.round(this.fontSize()+2*i),this.width=Math.max(this.width,this.minwidth),this.height=Math.max(this.height,this.minheight))),t.restore(),this},widget.prototype.drawTextTo=function(t){var i=this.margin;return t.save(),null!=this.font&&this.text&&("String"==typeof this.font?t.font=this.font:t.font=this.font.style+" "+this.font.weight+" "+this.font.size+" "+this.font.family,t.strokeStyle=this.font.color||"black",t.fillStyle=this.font.color||"black",this.font.fill=null==this.font.fill||this.font.fill,this.font.fill?t.fillText(this.text,i,this.fontSize()+i):t.strokeText(this.text,i,this.fontSize()+i)),t.restore(),this},widget.prototype.drawBorderTo=function(t){var i=this;if(i.border){if("none"===i.border.color&&i.background&&"color"===i.background.filltype&&"none"!=i.background.color?i.border.color=i.background.color:"none"===i.border.color&&i.background&&"gradient"===i.background.filltype&&"none"!=i.gradient.begincolor&&(i.border.color=i.gradient.begincolor),"none"!==i.border.color){if(t.save(),t.beginPath(),t.lineJoin="round",i.border.width=parseInt(i.border.width),t.lineWidth=i.border.width,t.lineCap="round",t.strokeStyle=i.border.color,"solid"!==i.border.type){var e="dashed"===i.border.type?[i.border.width+3,i.border.width+1]:[i.border.width+1,i.border.width+1];t.setLineDash(e)}if(this.corner&&"round"===this.corner.type){var s=this.corner.radius;t.moveTo(.5,this.height-s+.5),t.lineTo(.5,s+.5),t.arcTo(.5,.5,s+.5,.5,s),t.lineTo(this.width-s+.5,.5),t.arcTo(this.width+.5,.5,this.width+.5,s+.5,s),t.lineTo(this.width+.5,this.height-s+.5),t.arcTo(this.width+.5,this.height+.5,this.width-s+.5,this.height+.5,s),t.lineTo(s+.5,this.height+.5),t.arcTo(.5,this.height+.5,.5,this.height-s+.5,s),t.stroke(),this.fillBackgroundTo(t,2),t.clip()}else t.moveTo(.5,.5),t.lineTo(.5+this.width,.5),t.lineTo(.5+this.width,.5+this.height),t.lineTo(.5,this.height+.5),t.closePath(),t.stroke(),this.fillBackgroundTo(t,2),t.clip();this.fillBackgroundTo(t),this.drawImageTo(t),t.restore()}else this.fillBackgroundTo(t),this.drawImageTo(t);return this}},widget.prototype.drawSelectionBorderTo=function(t){this.selectable&&(t.save(),t.beginPath(),t.globalAlpha=1,t.strokeStyle="#cecfff",t.lineWidth=1,t.strokeRect(.5,.5,this.width+.5,this.height+.5),t.fill(),t.restore())},widget.prototype.drawResizerTo=function(t){t.save(),t.beginPath(),t.globalAlpha=1,t.fillStyle=e,t.lineWidth=1;if(!this.autosize)for(var i=0;i<=this.resizers.length-1;i++)this.resizers[i].visible&&t.fillRect(this.resizers[i].x-4,this.resizers[i].y-4,8,8);t.restore()},widget.prototype.drawFunctionPointTo=function(t){if(0!==this.functionPoints.length){t.save(),t.beginPath(),t.globalAlpha=1,t.fillStyle="#ff0000",t.lineWidth=1;if(this.functionPoints.length>0){for(var i=0;i<=this.functionPoints.length-1;i++)if(this.functionPoints[i].visible){var e=this.functionPoints[i].x,s=this.functionPoints[i].y,h=8*Math.sin(45*Math.PI/180);t.moveTo(e,s-h),t.lineTo(e+h,s),t.lineTo(e,h+s),t.lineTo(e-h,s),t.closePath()}t.stroke(),t.fill()}t.restore()}},widget.prototype.drawConnectionPointTo=function(t){if(this.allowconnectionPoint){t.save(),t.globalAlpha=1,t.fillStyle=e,t.lineWidth=1;for(var i=0;i<=this.connectionPoints.length-1;i++)this.connectionPoints[i].visible&&(t.beginPath(),t.arc(this.connectionPoints[i].x,this.connectionPoints[i].y,4,0,2*Math.PI),t.stroke(),t.fill());t.restore()}},widget.prototype.drawRotateKeyPoint=function(t){if(this.allowRotate){t.save(),t.globalAlpha=1,t.strokeStyle=e,t.fillStyle="#ffff00",t.lineWidth=1;this.rotateKeyPoint.visible&&(t.beginPath(),t.moveTo(this.width/2,0),t.lineTo(this.rotateKeyPoint.x,this.rotateKeyPoint.y-4),t.stroke(),t.beginPath(),t.arc(this.rotateKeyPoint.x,this.rotateKeyPoint.y,4,0,2*Math.PI),t.stroke(),t.fill()),t.restore()}},widget.prototype.fillBackgroundTo=function(t,i){if(this.gradient&&"none"!=this.gradient.type&&this.background&&"gradient"===this.background.filltype){t.save(),this.drawShadowTo(t);var e;if("liner"===this.gradient.type){var s,h,n,o,r=Math.atan(this.height/this.width)/Math.PI*180;this.gradient.angle<90?(s=0,h=0,this.gradient.angle<r?(n=this.width,o=this.width*Math.tan(this.gradient.angle*Math.PI/180)):(o=this.height,n=this.height*Math.atan(this.gradient.angle*Math.PI/180))):90===this.gradient.angle?(s=0,h=0,n=0,o=this.height):(s=this.width,h=0,this.gradient.angle<r+90?(o=this.height,n=this.width-this.height*Math.atan(this.gradient.angle*Math.PI/180)):(n=0,o=-this.height*Math.tan(this.gradient.angle*Math.PI/180))),e=t.createLinearGradient(s,h,n,o),this.gradient.angle<180?(e.addColorStop(0,this.gradient.begincolor),e.addColorStop(1,this.gradient.endcolor)):(e.addColorStop(0,this.gradient.endcolor),e.addColorStop(1,this.gradient.begincolor))}else{var d=Math.max(this.width/2,this.height/2);e=t.createRadialGradient(this.width/2,this.height/2,this.gradient.radius,this.width/2,this.height/2,d),e.addColorStop(0,this.gradient.begincolor),e.addColorStop(1,this.gradient.endcolor)}t.fillStyle=e;var g=i||1;1===g?t.fillRect(.5,.5,this.width-.5,this.height-.5):t.fill(),t.restore()}else if(null!=this.background&&"none"!==this.background.color&&("color"===this.background.filltype||"image"===this.background.filltype)){t.save(),this.drawShadowTo(t),t.fillStyle=this.background.color;var g=i||1;1===g?t.fillRect(.5,.5,this.width-.5,this.height-.5):t.fill(),t.restore()}},widget.prototype.drawShadowTo=function(t){this.shadow&&"none"!==this.shadow.color&&!this.is_mouse_down&&(t.shadowColor=this.shadow.color,t.shadowBlur=this.shadow.blur,t.shadowOffsetX=this.shadow.offsetX,t.shadowOffsetY=this.shadow.offsetY)},widget.prototype.paintTo=function(t,i,e){var s=t.getContext("2d"),h=this;if(s.save(),h.RotatePoint(h.x+h.width/2,h.y+h.height/2),t!=this.canvas)if(0===h.rotate)s.translate(h.x,h.y);else{var n=math.getRotatePoint(h.rotate,h.rotatepoint);s.translate(h.x+n.x,h.y+n.y)}else 0!==h.rotate&&s.translate(h.rotatepoint.x,h.rotatepoint.y);if(s.scale(this.scaleX,this.scaleY),s.rotate(h.rotate/180*Math.PI),s.globalAlpha=h.alpha,this.calculateSize(s),this.beforePaint&&this.beforePaint(s),this.drawBorderTo(s),this.drawTextTo(s),this.focus&&t!=this.canvas&&this.editable?(this.drawSelectionBorderTo(s),this.focuswidget||(this.drawRotateKeyPoint(s),this.allowResizer&&this.drawResizerTo(s),this.drawConnectionPointTo(s),this.drawFunctionPointTo(s))):this.inselect&&t!=this.canvas&&this.editable&&this.drawSelectionBorderTo(s),null!=this.parent)for(var o=0;o<=this.widgets.length-1;o++)this.widgets[o].visible&&this.widgets[o].paintTo(t);s.restore()},widget.prototype.paint=function(){return this.canvas.width=this.width,this.canvas.height=this.height,this.paintTo(this.canvas),this.presenters.length>0?t(this.presenters).each(function(t,i){i.paint({action:"called from "+this.name})}):this.parent&&this.parent.paint(),this},widget.prototype.Width=function(t){if(1===arguments.length){var i=this.rotatepoint.offsetx/this.width*t;return this.x-=i-this.rotatepoint.offsetx,this.rotatepoint.offsetx=this.rotatepoint.x-this.x,this.width=t,this.canvas.width=this.width,this}return this.width},widget.prototype.Height=function(t){if(1===arguments.length){var i=this.rotatepoint.offsety/this.height*t;return this.y-=i-this.rotatepoint.offsety,this.rotatepoint.offsety=this.rotatepoint.y-this.y,this.height=t,this.canvas.height=this.height,this}return this.height},widget.prototype.Widget=function(t){if(1===arguments.length){var i=null;if("string"==typeof t){for(var e=0;e<this.widgets.length;e++)if(this.widgets[e].name===t){i=this.widgets[e];break}}else if("number"==typeof t)t>=0&&t<this.widgets.length&&(i=this.widgets[t]);else if("object"==typeof t)for(var e=0;e<this.widgets.length;e++){var s=!0;for(p in this.widgets[e]){this.widgets[e][p]!=t[p]&&(s=!1);break}s&&(i=this.widgets[e])}return i}return this.widgets},widget.prototype.Presenters=function(t){if(1===arguments.length){var i=null;if("string"==typeof t){for(var e=0;e<this.presenters.length;e++)if(this.presenters[e].name===t){i=this.presenters[e];break}}else"number"==typeof t&&t>=0&&t<this.presenters.length&&(i=this.presenters[t]);return i}return this.presenters},widget.prototype.downDepth=function(){var t=this.parent.widgets;if(t.length>0&&this.depth<=t.length){for(var i=this.depth-2;i>=0;i--)this.parent.widgets[i+1]=this.parent.widgets[i],this.parent.widgets[i+1].depth=i+2;this.parent.widgets[0]=this,this.depth=1}return this},widget.prototype.downStep=function(){var t=this.parent.widgets;return t.length>0&&this.depth<=t.length&&this.depth>1&&(this.parent.widgets[this.depth-1]=this.parent.widgets[this.depth-2],this.parent.widgets[this.depth-1].depth=this.depth,this.parent.widgets[this.depth-2]=this,this.parent.widgets[this.depth-2].depth=this.depth-1),this},widget.prototype.topDepth=function(){var t=this.parent.widgets;if(t.length>0&&this.depth<=t.length){for(var i=this,e=this.depth-1;e<t.length-1;e++)this.parent.widgets[e]=this.parent.widgets[e+1],this.parent.widgets[e].depth=e+1;this.parent.widgets[t.length-1]=i,i.depth=this.parent.widgets.length}return this},widget.prototype.topStep=function(){var t=this.parent.widgets;if(t.length>0&&this.depth<t.length){var i=this;this.parent.widgets[this.depth-1]=this.parent.widgets[this.depth],this.parent.widgets[this.depth-1].depth=this.depth,this.parent.widgets[this.depth]=i,i.depth=this.depth+1}return this},widget.prototype.appendPresenter=function(t){return this.parent=t.rootwidget,this.root=t.rootwidget,t.widgets.push(this),this.depth=t.widgets.length,this.presenters.push(t),this._widgets&&this._widgets.length>0&&this.restoreChildren(this._widgets,{editable:this.editable,includeChildren:!0}),this},widget.prototype.appendWidget=function(t){t.root=this.root?this.root:this,t.parent=this,this.widgets.push(t),t.depth=this.widgets.length;for(var i=0;i<=t.widgets.length-1;i++)t.widgets[i].root=t.root;return this},widget.prototype.restoreChildren=function(i,e){for(var s=[],h=0;h<=i.length-1;h++)if(i[h].scilence=this.scilence,t.extend(i[h],e),i[h].background&&null!=i[h].background.image&&null==i[h].background.filltype&&i[h].background.filltype,null!=i[h].begin&&null!=i[h].end&&i[h].type.indexOf("Connector")>0)s.push(i[h]);else{var n=t.widgets(i[h].type,i[h]);this.appendWidget(n)}for(var h=0;h<=s.length-1;h++){var n=t.widgets(s[h].type,s[h]);n.begin&&n.begin.widget&&(n.begin.widget=this.Widget(n.begin.widget)),n.end&&n.end.widget&&(n.end.widget=this.Widget(n.end.widget)),this.appendWidget(n)}},widget.prototype.removeWidget=function(t){for(var i=this.widgets.length,e=0;e<this.widgets.length;e++){if(this.widgets[e]===t){for(var s=this.widgets[e].connections.length-1;s>=0;s--)this.removeWidget(this.widgets[e].connections[s]);i=e,this.widgets.splice(e,1),e--}e>=0&&(this.widgets[e].depth=e<i?e+1:e)}return this},widget.prototype.RotatePoint=function(t,i){return 2===arguments.length?(this.rotatepoint.x=t,this.rotatepoint.y=i,this.rotatepoint.offsetx=t-this.x,this.rotatepoint.offsety=i-this.y,this):this.rotatepoint},widget.prototype._triggerEvent=function(i,e){if("drop"!=i||this.allowdrop){this.local={x:e.x,y:e.y};var s=this.widgets,h=!1,n={};t.extend(n,e),e.originalEvent&&(n.originalEvent={},t.extend(n.originalEvent,e.originalEvent));for(var o=s.length-1;o>=0;--o)if(s[o].checkPointIn(e.x,e.y)){var r=s[o].relativePoint(e.x,e.y);n.x=r.x,n.y=r.y,"mousedown"!==i&&"mouseup"!==i||!s[o].shadow||"none"==s[o].shadow.color||(n.requiredPaint=!0),s[o]._triggerEvent.call(s[o],i,n),n.requiredPaint&&(e.requiredPaint=!0),h=!0;break}if("mousedown"===i?this.is_mouse_down=!0:"mouseup"===i&&delete this.is_mouse_down,!h){n.target=this,n.eventType=i,n.cancel=!1;for(var d=this;d;)d[i]&&d.local&&(n.x=d.local.x,n.y=d.local.y,n.currentTarget=d,d[i].call(d,n)),n.cancel?(d=null,e.cancel=!0):d=d.parent}}},widget.prototype.getImageData=function(t,i,e,s,h,n){var o=t||0,r=i||0,d=parseInt(e||this.width),g=parseInt(s||this.height),a=h||d,l=n||g,w=document.createElement("canvas"),c=w.getContext("2d"),f=Math.min(a/d,l/g);w.width=a,w.height=l;var p=(a-d*f)/2,b=(l-g*f)/2;c.drawImage(this.ctx.canvas,o,r,d,g,p,b,d*f,g*f);try{return w.toDataURL("image/png")}catch(t){return console.warn(t),null}},widget.prototype.getImageBlob=function(t,i,e,s,n){return h(n?this.getImageData(t,i,e,s).replace("image/png",n):this.getImageData(t,i,e,s))},presenter=function(i){var e={name:"presenter",title:"presenter",dom:t("body"),width:1024,height:800,pagesize:"Other",pagein:-1,pageout:-1,pagedirection:"vertical",type:"panel",background:{filltype:"color",color:"#ABABAB"},border:{color:"none",width:1,type:"solid"},showgrid:!1,scale:1,dpi:8,aligngrid:!0,mousedown:null,mousemove:null,mouseup:null,click:null,dblclick:null};t.extend(e,i),t.extend(this,e),this.offsetx=e.dom.offset().left?parseInt(e.dom.offset().left):0,this.offsety=e.dom.offset().top?parseInt(e.dom.offset().top):0,this.selectRect={x:0,y:0,width:0,height:0},this.inSelection=!1,this.point={x:0,y:0};var s=new widget({name:this.name,width:this.width,height:this.height,background:this.background,gradient:this.gradient,border:this.border,dpi:this.dpi,scale:this.scale,imageload:this.imageload});s.editable=!0,s.paint(),s.parent=null,s.local={x:0,y:0},s.mousedown=this.mousedown?this.mousedown:null,s.mousemove=this.mousemove?this.mousemove:null,s.mouseup=this.mouseup?this.mouseup:null,s.click=this.click?this.click:null,s.dblclick=this.dblclick?this.dblclick:null,this.rootwidget=s,this.rootwidget.scale=e.scale,this.ctx=s.ctx,this.canvas=s.canvas,this.dom&&"object"==typeof this.dom&&(t(this.canvas).appendTo(this.dom),this.textbox=document.createElement("textarea"),t(this.textbox).appendTo(this.dom).css("position","absolute").hide(),this.mask=document.createElement("img"),t(this.mask).appendTo(this.dom).css("position","absolute").hide()),this.widgets=s.widgets,this.connectors=[],this.history=[],this.redohistory=[],this.resizer=0;var h=t(this.canvas).css({"-webkit-user-select":"none","-webkit-touch-callout":"none","-webkit-user-drag":"none","-webkit-tap-highlight-color":"rgba(0,0,0,0)"}).get(0);t(h).attr("tabindex","0");var n=this;this.defaultcursor="default";var o=function(t){n._triggerEvent("mousemove",t)};h.addEventListener("mousemove",o),h.addEventListener("click",function(t){n._triggerEvent("click",t)}),h.addEventListener("dblclick",function(t){n._triggerEvent("dblclick",t)}),h.addEventListener("mousedown",function(t){n.offsetx=parseInt(n.dom.offset().left),n.offsety=parseInt(n.dom.offset().top),n._triggerEvent("mousedown",t)}),h.addEventListener("mouseup",function(t){n._triggerEvent("mouseup",t),n.Cursor(n.defaultcursor)}),this.activewidget=null,this.focuswidget=null,this.selectwidgets=[]},presenter.prototype.Cursor=function(t){return 1===arguments.length?(this.canvas.style.cursor=t,this):this.canvas.style.cursor},presenter.prototype.Scale=function(t){return 1===arguments.length?(this.scale=t,this.rootwidget.Scale(t),this):this.rootwidget.scale},presenter.prototype.Widget=function(t){return 1===arguments.length?this.rootwidget.Widget(t):this.widgets},presenter.persistproperty=function(i){var e={};e.name=i.rootwidget.name,e.width=i.rootwidget.width,e.height=i.rootwidget.height,e.title=i.title,e.scale=i.scale,e.showgrid=i.showgrid,e.aligngrid=i.aligngrid,e.pagesize=i.pagesize,e.pagein=i.pagein,e.pageout=i.pageout,e.pagedirection=i.pagedirection,i.rootwidget.background&&(e.background={},t.extend(e.background,i.rootwidget.background),i.rootwidget.background.image&&(e.background.image=i.rootwidget.background.image.src)),i.rootwidget.border&&(e.border={},t.extend(e.border,i.rootwidget.border)),e.widgets=[];for(var s=0;s<i.widgets.length;s++)e.widgets.push(i.widgets[s].persist());return e},presenter.prototype.persist=function(){return presenter.persistproperty(this)},presenter.prototype.appendWidget=function(t){return t.root=this.rootwidget,t.parent=this.rootwidget,this.widgets.push(t),t.presenters.push(this),this},presenter.prototype.drawGrid=function(){var t=4*this.dpi;this.ctx.save(),this.ctx.strokeStyle="silver",this.ctx.lineWidth=1,this.ctx.beginPath();var i=[4,3];this.ctx.setLineDash(i);for(var e=t;e<this.rootwidget.width;)this.ctx.moveTo(e+.5,0),this.ctx.lineTo(e+.5,this.rootwidget.height),e+=t;for(var e=t;e<this.rootwidget.height;)this.ctx.moveTo(0,e+.5),this.ctx.lineTo(this.rootwidget.width,e+.5),e+=t;this.ctx.stroke(),this.ctx.restore()},presenter.prototype.paint=function(t){this.rootwidget.paint(),this.showgrid&&this.drawGrid(),this.connectors.splice(0,this.connectors.length);for(var i=[],e=0;e<this.widgets.length;e++){var s=this.widgets[e];null!=s.begin&&null!=s.begin.widget&&null!=s.end&&s.type.indexOf("Connector")>0&&null!=s.end.widget?this.connectors.push(s):t&&t.filter&&"function"==typeof t.filter&&0!=t.filter(s)||s.visible&&i.push(s)}for(var h=0;h<=this.connectors.length-1;h++){var n=this.connectors[h];t&&t.filter&&"function"==typeof t.filter&&0!=t.filter(n)||n.visible&&n.begin.widget.visible&&n.end.widget.visible&&n.paintTo(this.canvas)}for(var h=0;h<=i.length-1;h++)i[h].visible&&i[h].paintTo(this.canvas);return this.selectwidgets.length>0&&(this.calculateRect(),this.fillSelectionRegion()),this.afterPaint&&this.afterPaint(this),t&&t.action&&console.info(t.action),this},presenter.prototype.fillSelectionRegion=function(){if(this.inSelection||this.selectwidgets.length>1){var t=this.canvas.getContext("2d");t.save(),t.beginPath(),t.globalAlpha=.5,t.fillStyle="#cecfff",t.strokeStyle="#cecfff",t.lineWidth=1,t.fillRect(this.selectRect.x/this.scale,this.selectRect.y/this.scale,this.selectRect.width/this.scale,this.selectRect.height/this.scale),t.restore()}},presenter.prototype.removeWidget=function(i,e){var s=[],h=[];i.length&&i.length>0?s=i:s.push(i);for(var n=0;n<=s.length-1;n++)for(var o=s[n],r=0;r<this.widgets.length;r++){if(this.widgets[r]===o){e||h.push(this.widgets[r].persist());for(var n=this.widgets[r].connections.length-1;n>=0;n--)e||h.push(this.widgets[r].connections[n].persist()),this.removeWidget(this.widgets[r].connections[n],!0);this.widgets.splice(r,1),r--}r>=0&&(this.widgets[r].depth=r+1)}return h.length>0&&t.command&&t.command("delete",this,h),this},presenter.prototype.calculateRect=function(){for(var t=0;t<=this.selectwidgets.length-1;t++){var i={x:this.selectwidgets[t].x*this.scale,y:this.selectwidgets[t].y*this.scale},e={x:this.selectwidgets[t].x*this.scale+this.selectwidgets[t].width*this.selectwidgets[t].scaleX*this.scale,y:this.selectwidgets[t].y*this.scale+this.selectwidgets[t].height*this.selectwidgets[t].scaleY*this.scale};0===t?(this.selectRect.x=i.x,this.selectRect.y=i.y,this.selectRect.width=e.x-i.x,this.selectRect.height=e.y-i.y):(e.x=Math.max(e.x,this.selectRect.x+this.selectRect.width),e.y=Math.max(e.y,this.selectRect.y+this.selectRect.height),this.selectRect.x=Math.min(this.selectRect.x,i.x),this.selectRect.y=Math.min(this.selectRect.y,i.y),this.selectRect.width=e.x-this.selectRect.x,this.selectRect.height=e.y-this.selectRect.y)}this.selectwidgets.length>0&&(this.selectRect.x=this.selectRect.x-1,this.selectRect.y=this.selectRect.y-1,this.selectRect.width=this.selectRect.width+2,this.selectRect.height=this.selectRect.height+2)},presenter.prototype.clearSelection=function(){for(var t=0;t<this.selectwidgets.length;t++)this.selectwidgets[t].inselect=!1;this.selectwidgets.splice(0,this.selectwidgets.length)},presenter.prototype.deleteFocus=function(){var t=[];this.focuswidget&&this.focuswidget.editable&&(this.removeWidget(this.focuswidget),null!=this.focuswidget.ondelete&&this.focuswidget.ondelete.call(this.focuswidget),this.focuswidget=null);for(var i=0;i<this.selectwidgets.length;i++)this.selectwidgets[i].editable&&t.push(this.selectwidgets[i]);return this.removeWidget(t),this.clearSelection(),this.paint({action:"delete focus"}),!0},presenter.prototype.getName=function(t){var i="widget";1===arguments.length&&(i=t);for(var e=1;null!=this.rootwidget.Widget(i+e);)e++;return i+e},presenter.startMoveWidget=function(i,s,h){var n=t(i.mask),o=i;if(o.activewidget){var r=parseInt(o.activewidget.x)*o.scale,d=parseInt(o.activewidget.y)*o.scale,g=o.activewidget.width*o.scale,a=o.activewidget.height*o.scale;o.selectwidgets.length>1&&(r=parseInt(o.selectRect.x),d=parseInt(o.selectRect.y),g=o.selectRect.width,a=o.selectRect.height),n.css("z-index",0).css("width",g*o.activewidget.scaleX).css("height",a*o.activewidget.scaleY).css("left",r).css("top",d).css("border","solid 1px").css("border-color",e).css("-moz-transform","rotate("+o.activewidget.rotate+"deg)").css("transform","rotate("+o.activewidget.rotate+"deg)").css("-webkit-transform","rotate("+o.activewidget.rotate+"deg)").css("-o-transform","rotate("+o.activewidget.rotate+"deg)").attr("moving",!0).attr("oldx",s.clientX).attr("oldy",s.clientY).attr("offsetX",h.x).attr("offsetY",h.y).css("cursor","move").bind("click",function(i){var e=function(){t(window).unbind("mousemove").unbind("mouseup"),n.unbind(),n.hide().css("height","1px").css("width","1px").css("cursor","default")};setTimeout(e,100),o.activewidget&&(delete o.activewidget.is_mouse_down,o.activewidget._triggerEvent("click",h),o.activewidget=null,o.paint())}).bind("dblclick",function(t){console.info("dblclick")}).show(),t(window).bind("mousemove",function(t){t.preventDefault();var i=n;if(i.attr("moving")){var e=i.attr("oldx")-t.clientX,s=i.attr("oldy")-t.clientY,h=i.css("left"),o=i.css("top");h=parseInt(h.substring(0,h.length-2))-e,o=parseInt(o.substring(0,o.length-2))-s,i.css("top",o).css("left",h).attr("oldy",t.clientY).attr("oldx",t.clientX)}}).bind("mouseup",function(i){if(i.preventDefault(),n.attr("moving")){n.attr("moving",!1);var e=n.css("left"),s=n.css("top");delete o.is_mouse_down;var g=parseInt(e.substring(0,e.length-2))-r,a=parseInt(s.substring(0,s.length-2))-d;if(o.selectwidgets.length>1)t(o.selectwidgets).each(function(t,i){i.x=parseInt(i.x)+g/o.scale,i.y=parseInt(i.y)+a/o.scale});else if(o.activewidget){var l={x:o.activewidget.x,y:o.activewidget.y,width:o.activewidget.width,height:o.activewidget.height};o.activewidget.x=parseInt(e.substring(0,e.length-2))/o.scale,o.activewidget.y=parseInt(s.substring(0,s.length-2))/o.scale;var w={x:o.activewidget.x,y:o.activewidget.y,width:o.activewidget.width,height:o.activewidget.height};if(l.x==w.x&&l.y==w.y&&l.width==w.width&&l.height==w.height||t.command&&t.command("move",o,o.activewidget.name,l,w),h.offsetX=g,h.offsetY=a,o.aligngrid){var c=o.activewidget.x%(4*o.dpi),f=o.activewidget.y%(4*o.dpi);c>=2*o.dpi?o.activewidget.x+=4*o.dpi-c:o.activewidget.x-=c,f>=2*o.dpi?o.activewidget.y+=4*o.dpi-f:o.activewidget.y-=f}o.activewidget._triggerEvent("mouseup",h)}n.trigger("click")}})}},presenter.prototype.adddefaultconnection=function(t){};var s=null;presenter.prototype._triggerEvent=function(i,e){if("keypress"===i){if("none"===t(this.textbox).css("display")){if(null!=this.focuswidget&&null!=this.focuswidget.keypress&&this.focuswidget.keypress.call(this.focuswidget,e),e.cancel)return;this.keypress&&this.keypress(e)}return!0}e.stopPropagation&&e.stopPropagation(),e.preventDefault(),e.center?(this.point.x=e.center.x,this.point.y=e.center.y):e.offsetX?(this.point.x=e.offsetX,this.point.y=e.offsetY):(this.point.x=e.layerX,this.point.y=e.layerY);var h={};h.desktopX=h.x=this.point.x,h.desktopY=h.y=this.point.y,h.originalEvent=e,h.button=e.button,h.buttons=e.buttons,this.targetwidget=null;for(var n=[],o=!1,r=this.widgets.length-1;r>=0;--r)if(null!=this.widgets[r].begin&&null!=this.widgets[r].end&&this.widgets[r].type.indexOf("Connector")>0)n.push(this.widgets[r]);else if(this.widgets[r].checkPointIn(this.point.x,this.point.y)){var d=this.widgets[r].relativePoint(this.point.x,this.point.y);h.x=d.x,h.y=d.y,this.targetwidget=this.widgets[r],"mousedown"===i&&0===this.resizer&&0===e.button&&(this.activewidget=this.widgets[r],this.focuswidget!=this.widgets[r]&&(null!=this.focuswidget&&(void 0!=this.focuswidget.root.focus?this.focuswidget.root.focus=!1:void 0!=this.focuswidget.parent.focus&&(this.focuswidget.parent.focus=!1),this.focuswidget.focus=!1),this.focuswidget=this.widgets[r],this.focuswidget.focus=!0,o=!0)),e.center&&(h=e),this.widgets[r]._triggerEvent.call(this.widgets[r],i,h),e.cancel=h.cancel;break}if(null===this.targetwidget){for(var r=0;r<=n.length-1;r++){if(n[r].checkPointIn(this.point.x,this.point.y)){var d=n[r].relativePoint(this.point.x,this.point.y);h.x=d.x,h.y=d.y,this.targetwidget=n[r],"mousedown"===i&&0===this.resizer&&0===e.button?(this.activewidget=n[r],
this.focuswidget!=n[r]&&(null!=this.focuswidget&&(this.focuswidget.focus=!1),this.focuswidget=n[r],this.focuswidget.focus=!0,o=!0)):"mousemove"==i&&(this.defaultcursor="pointer"),n[r]._triggerEvent.call(n[r],i,h),e.cancel=h.cancel;break}this.defaultcursor="default"}this.Cursor(this.defaultcursor)}if(null==this.targetwidget&&this.rootwidget._triggerEvent.call(this.rootwidget,i,h),o=o||h.requiredPaint,"mousedown"===i&&0===e.button){if(this.is_mouse_down=!0,null!=this.focuswidget&&this.focuswidget.allowconnectionPoint&&0===this.functionPoint&&(this.connectionPoint=math.checkPointInconnectionPoint(this.focuswidget,this.point.x,this.point.y),this.connectionPoint>0&&(this.drawingconnection=!0)),this.activewidget&&this.activewidget.shadow&&"none"!=this.activewidget.shadow.color&&(o=!0),this.focuswidget&&this.focuswidget.allowRotate&&(this.rotating=math.checkPointInRotateKeyPoint(this.focuswidget,this.point.x,this.point.y)),null==this.activewidget||!this.activewidget.editable||this.rotating||this.drawingconnection||0!==this.functionPoint&&this.functionPoint)null==this.activewidget&&(this.rotating||this.functionPoint&&0!=this.functionPoint||(t(this.textbox).hide(),this.clearSelection(),0!==this.resizer||this.drawingconnection||(this.inSelection=!0,this.focuswidget&&(void 0!=this.focuswidget.root.focus?this.focuswidget.root.focus=!1:void 0!=this.focuswidget.parent.focus&&(this.focuswidget.parent.focus=!1),this.focuswidget.focus=!1,this.focuswidget=null)),this.selectRect.x=this.point.x,this.selectRect.y=this.point.y));else{s=this.activewidget.persist(),this.inSelection=!1,this.Cursor("move"),this.activewidget.setResizers(),this.canvas.focus();var g=this,a=function(){g.activewidget&&g.activewidget.type.indexOf("Connector")<0&&g.is_mouse_down&&presenter.startMoveWidget(g,e,h)};setTimeout(a,200)}null!=this.focuswidget&&this.focuswidget.editable&&(this.functionPoint=math.checkPointInfunctionPoint(this.focuswidget,this.point.x,this.point.y),this.functionPoint>0&&(this.activewidget=this.focuswidget,s=this.activewidget.persist()),this.focuswidget.oldX=this.point.x,this.focuswidget.oldY=this.point.y),o&&this.paint({action:"mousedown"})}else if("mousemove"===i){if(null!=this.activewidget&&this.activewidget.editable){var l=t(this.mask);if(l.attr("moving")){var w=l.attr("oldx")-e.clientX,c=l.attr("oldy")-e.clientY,f=l.css("left"),p=l.css("top");f=parseInt(f.substring(0,f.length-2))-w,p=parseInt(p.substring(0,p.length-2))-c,l.css("top",p).css("left",f).attr("oldy",e.clientY).attr("oldx",e.clientX)}}if(null!=this.focuswidget&&this.focuswidget.editable)if(this.is_mouse_down){if(this.drawingconnection)this.paint({action:"drawingconnection"}),this.ctx.save(),this.ctx.strokeStyle="black",this.ctx.lineWidth=1,this.ctx.lineCap=this.focuswidget.linecap,this.ctx.beginPath(),this.ctx.moveTo(this.focuswidget.connectionPoints[this.connectionPoint-1].x*this.focuswidget.scaleX+this.focuswidget.x,this.focuswidget.connectionPoints[this.connectionPoint-1].y*this.focuswidget.scaleY+this.focuswidget.y),this.ctx.lineTo(this.point.x/this.scale,this.point.y/this.scale),this.ctx.stroke(),this.ctx.restore();else if(this.rotating){var b=this.point.x-this.focuswidget.rotatepoint.x*this.scale,y=this.point.y-this.focuswidget.rotatepoint.y*this.scale,u=Math.abs(b/y),x=Math.atan(u)/(2*Math.PI)*360;b<0&&y<0?x=-x:b<0&&y>0?x=-(180-x):b>0&&y<0?x=x:b>0&&y>0&&(x=180-x);this.focuswidget.rotate;this.focuswidget.rotate=Math.round(x),o=!0}else if(this.functionPoint>0){var w=this.point.x-(this.focuswidget.functionPoints[this.functionPoint-1].x+this.focuswidget.x)*this.scale,c=this.point.y-(this.focuswidget.functionPoints[this.functionPoint-1].y+this.focuswidget.y)*this.scale;if(this.focuswidget.functionPoints[this.functionPoint-1].x+=w,this.focuswidget.functionPoints[this.functionPoint-1].y+=c,this.focuswidget.afterfunctionPoint){var m={offset:{x:w,y:c},point:this.point,functionPoint:this.functionPoint,originalEvent:e};this.focuswidget.afterfunctionPoint(m)}o=!0}else if(this.resizer>0&&null!=this.focuswidget.oldX){var v=(this.point.x-this.focuswidget.oldX)/this.scale,k=(this.point.y-this.focuswidget.oldY)/this.scale,x=math.angle(this.focuswidget.rotate),z=Math.cos(x),P=Math.sin(x),w=v*z+k*P,c=k*z-v*P;if(e.ctrlKey&&this.focuswidget.type.indexOf("Connector")<0&&(c=w),this.focuswidget.oldX=this.point.x,this.focuswidget.oldY=this.point.y,this.focuswidget.oldwidth=this.focuswidget.width,this.focuswidget.oldheight=this.focuswidget.height,null===this.focuswidget.resize){if(1===this.resizer?(this.focuswidget.x+=w,this.focuswidget.width-=w,this.focuswidget.y+=c,this.focuswidget.height-=c):2===this.resizer?(this.focuswidget.width+=w,this.focuswidget.y+=c,this.focuswidget.height-=c):3===this.resizer?(this.focuswidget.x+=w,this.focuswidget.width-=w,this.focuswidget.height+=c):4===this.resizer&&(this.focuswidget.width+=w,this.focuswidget.height+=c),this.focuswidget.afterresize){var m={offset:{x:w,y:c},point:this.point,resizer:this.resizer,originalEvent:e};this.focuswidget.afterresize(m)}this.focuswidget.setResizers()}else{var m={offset:{x:w,y:c},point:this.point,resizer:this.resizer,originalEvent:e};this.focuswidget._triggerEvent.call(this.focuswidget,"resize",m)}if((null!=this.focuswidget.background&&null!=this.focuswidget.background.image||this.focuswidget.widgets.length>0)&&(this.focuswidget.width=Math.max(this.focuswidget.width,this.focuswidget.minwidth),this.focuswidget.height=Math.max(this.focuswidget.height,this.focuswidget.minheight)),!this.focuswidget.disableScale)for(var T=this.focuswidget.width/this.focuswidget.oldwidth,S=this.focuswidget.height/this.focuswidget.oldheight,r=0;r<=this.focuswidget.widgets.length-1;r++)this.focuswidget.widgets[r].width=this.focuswidget.widgets[r].width*T,this.focuswidget.widgets[r].height=this.focuswidget.widgets[r].height*S,this.focuswidget.widgets[r].x=this.focuswidget.widgets[r].x*T,this.focuswidget.widgets[r].y=this.focuswidget.widgets[r].y*S;o=!0}}else this.functionPoint=math.checkPointInfunctionPoint(this.focuswidget,this.point.x,this.point.y),this.functionPoint>0?this.Cursor(this.focuswidget.functionPoints[this.functionPoint-1].cursor?this.focuswidget.functionPoints[this.functionPoint-1].cursor:"move"):(this.Cursor(this.defaultcursor),this.resizer=math.checkPointInResizer(this.focuswidget,this.point.x,this.point.y),this.resizer>0?this.Cursor(this.focuswidget.resizers[this.resizer-1].cursor?this.focuswidget.resizers[this.resizer-1].cursor:"move"):(this.focuswidget.allowconnectionPoint&&(this.connectionPoint=math.checkPointInconnectionPoint(this.focuswidget,this.point.x,this.point.y),this.connectionPoint>0&&this.Cursor(this.focuswidget.connectionPoints[this.connectionPoint-1].cursor?this.focuswidget.connectionPoints[this.connectionPoint-1].cursor:"move")),this.focuswidget.allowRotate&&math.checkPointInRotateKeyPoint(this.focuswidget,this.point.x,this.point.y)&&this.Cursor(this.focuswidget.rotateKeyPoint.cursor)));if(o&&this.paint({action:"mousemove"}),this.inSelection&&0===e.button&&1==e.buttons){var w=this.point.x-this.selectRect.x,c=this.point.y-this.selectRect.y;this.selectRect.width=w,this.selectRect.height=c,o||this.paint({action:"mousemove"}),this.fillSelectionRegion()}}else if("mouseup"===i&&0===e.button){var l=t(this.mask);if(l.attr("moving")&&l.trigger("mouseup"),t.command&&this.functionPoint>0&&this.focuswidget&&t.command("change",this,this.focuswidget.persist(),s),this.drawingconnection&&null!=this.targetwidget&&this.targetwidget!=this.focuswidget){var d=this.targetwidget.relativePoint(h.desktopX,h.desktopY);h.x=d.x,h.y=d.y,this.adddefaultconnection(h)}else this.drawingconnection&&null==this.targetwidget&&(o=!0);if(null!=this.focuswidget&&this.focuswidget.is_mouse_down&&!this.focuswidget.editable&&(this.focuswidget.focus=!1,delete this.focuswidget.is_mouse_down,o=!0),null!=this.focuswidget&&this.focuswidget.editable){var M=this.focuswidget;if(M.width<0&&M.height>0?(M.width=-M.width,M.x-=M.width,1===M.direction?M.direction=2:2===M.direction?M.direction=1:4===M.direction?M.direction=3:3===M.direction&&(M.direction=4)):M.width>0&&M.height<0?(M.height=-M.height,M.y-=M.height,1===M.direction?M.direction=4:2===M.direction?M.direction=3:4===M.direction?M.direction=1:3===M.direction&&(M.direction=2)):M.width<0&&M.height<0&&(M.height=-M.height,M.width=-M.width,M.x-=M.width,M.y-=M.height,M.direction=M.direction>2?M.direction-2:M.direction+2),s){var I={x:s.x,y:s.y,width:s.width,height:s.height},C={x:M.x,y:M.y,width:M.width,height:M.height};I.x==C.x&&I.y==C.y&&I.width==C.width&&I.height==C.height||t.command&&t.command("move",this,M.persist(),I,C)}M.setResizers(),delete this.is_mouse_down,delete this.drawingconnection,delete this.rotating}if(o&&this.paint({action:"mouseup"}),this.inSelection){var w=this.point.x-this.selectRect.x,c=this.point.y-this.selectRect.y;if(w<0&&(this.selectRect.x+=w),c<0&&(this.selectRect.y+=c),this.selectRect.width=Math.abs(w),this.selectRect.height=Math.abs(c),this.selectRect.width>0&&this.selectRect.height>0){for(var r=0;r<=this.widgets.length-1;r++)this.widgets[r].editable&&math.checkwidgetInRect(this.widgets[r],this.selectRect)&&(this.widgets[r].inselect=!0,this.selectwidgets.push(this.widgets[r]));this.calculateRect()}this.inSelection=!1,o||this.paint({action:"mouseup"}),this.selectwidgets.length>0&&this.fillSelectionRegion()}}else if("click"===i&&0===e.button){if(null!=this.activewidget){if(e.ctrlKey){this.activewidget.type.indexOf("Connector")>0?this.activewidget.downDepth():this.activewidget.topDepth(),this.activewidget.inselect=!0;for(var R=0;R<this.selectwidgets.length;R++)if(this.selectwidgets[R]===this.activewidget){this.activewidget.inselect=!1,this.selectwidgets.splice(R,1);break}this.activewidget.inselect&&this.selectwidgets.push(this.activewidget),o=!0}this.activewidget.shadow&&"none"!=this.activewidget.shadow.color&&(o=!0),o&&this.paint({action:"click"}),this.activewidget=null}}else if("dblclick"===i&&0===e.button&&!h.cancel&&null!=this.focuswidget&&this.focuswidget.editable){this.focuswidget.dblclick||t(this.textbox).val(this.focuswidget.text).css("width",Math.max(this.focuswidget.width+30,100)*this.scale).css("height",Math.max(this.focuswidget.height+30,100)*this.scale).css("left",this.focuswidget.x*this.scale).css("top",this.focuswidget.y*this.scale).show();var g=this;t(this.textbox).off("keyup"),t(this.textbox).on("keyup",function(i){i.preventDefault(),13===i.keyCode&&i.ctrlKey?(g.focuswidget.text=g.textbox.value,t(g.textbox).hide(),g.paint({action:"edit text"})):27===i.keyCode?t(g.textbox).hide():g.focuswidget.text=g.textbox.value})}};var h=function(t){if(-1===t.indexOf(";base64,")){var i=t.split(","),e=i[0].split(":")[1],s=i[1];return new Blob([s],{type:e})}for(var i=t.split(";base64,"),e=i[0].split(":")[1],h=atob(i[1]),n=new ArrayBuffer(h.length),o=new Uint8Array(n),r=0;r<h.length;r++)o[r]=h.charCodeAt(r);return new Blob([n],{type:e})};math={pi:Math.PI,angle:function(t){return Math.PI*(t/180)},getRotatePoint:function(t,i){var e=this.angle(t);return{x:i.offsetx*(1-Math.cos(e))+i.offsety*Math.sin(e),y:i.offsety*(1-Math.cos(e))-i.offsetx*Math.sin(e)}},checkPointInResizer:function(t,i,e,s){s=s||t.root.scale;var h=t.relativePoint(i,e,s);i=h.x,e=h.y;for(var n=0;n<=t.resizers.length-1;n++)if(i>(t.resizers[n].x-6)*s*t.scaleX&&i<(t.resizers[n].x+6)*s*t.scaleX&&e>(t.resizers[n].y-6)*s*t.scaleY&&e<(t.resizers[n].y+6)*s*t.scaleY)return n+1;return 0},checkPointInRotateKeyPoint:function(t,i,e,s){s=s||t.root.scale;var h=t.relativePoint(i,e,s);i=h.x,e=h.y;return(i-t.rotateKeyPoint.x*s*t.scaleX)*(i-t.rotateKeyPoint.x*s*t.scaleX)+(e-t.rotateKeyPoint.y*s*t.scaleY)*(e-t.rotateKeyPoint.y*s*t.scaleY)<=16*s*t.scaleX*s*t.scaleY},checkPointInfunctionPoint:function(t,i,e,s){s=s||t.root.scale;var h=t.relativePoint(i,e,s);i=h.x,e=h.y;for(var n=0;n<=t.functionPoints.length-1;n++)if(t.functionPoints[n].visible&&i>(t.functionPoints[n].x-6)*s*t.scaleX&&i<(t.functionPoints[n].x+6)*s*t.scaleX&&e>(t.functionPoints[n].y-6)*s*t.scaleY&&e<(t.functionPoints[n].y+6)*s*t.scaleY)return n+1;return 0},checkPointInconnectionPoint:function(t,i,e,s){s=s||t.root.scale;var h=t.relativePoint(i,e,s);i=h.x,e=h.y;for(var n=0;n<=t.connectionPoints.length-1;n++)if((i-t.connectionPoints[n].x*s*t.scaleX)*(i-t.connectionPoints[n].x*s*t.scaleX)+(e-t.connectionPoints[n].y*s*t.scaleY)*(e-t.connectionPoints[n].y*s*t.scaleY)<=16*s*t.scaleX*s*t.scaleY)return n+1;return 0},checkwidgetInRect:function(t,i,e){e=e||t.root.scale;var s=i;return Math.abs(t.x*e+t.width*e*t.scaleX/2-s.x-s.width/2)<(t.width*e*t.scaleX+s.width)/2&&Math.abs(t.y*e+t.height*e*t.scaleY/2-s.y-s.height/2)<(t.height*e*t.scaleY+s.height)/2},Multiply:function(t,i,e,s,h,n){return(e-t)*(s-i)-(h-t)*(n-i)},isPointOnLine:function(t,i,e,s,h,n){return flag=!1,ESP=50,(t-e)*(t-h)<=ESP&&(i-s)*(i-n)<=ESP&&(flag=!0),flag}},t.register("widget",widget)}(jQuery),function(t){function i(t,i,e,s,h){var n=.5522848,o=s*n,r=h*n;t.beginPath(),t.moveTo(i-s,e),t.bezierCurveTo(i-s,e-r,i-o,e-h,i,e-h),t.bezierCurveTo(i+o,e-h,i+s,e-r,i+s,e),t.bezierCurveTo(i+s,e+r,i+o,e+h,i,e+h),t.bezierCurveTo(i-o,e+h,i-s,e+r,i-s,e),t.closePath(),t.stroke()}var e=new Map;t.registerPropertyObject=function(t,i){if("function"!=typeof i)return void alert(t+" is not a sinppet");try{globalSnippetPropertyEditor.update(t,i)}catch(t){alert(t)}},t.propertyObject=function(t,i){return e.containsKey(t)?new(e.get(t))(i):new propertyObject(i)},propertyObject=function(i){var e={datatype:{format:"single",title:"Data Type",required:!1,editable:!0,options:[{id:"String",text:"String"},{id:"Integer",text:"Integer"},{id:"Date",text:"Date"},{id:"Boolean",text:"Boolean"},{id:"Array",text:"Array"},{id:"Object",text:"Object"},{id:"MergedObject",text:"MergedObject"}]},originedatatype:{format:"string",title:"DB Datatype",required:!1,editable:!1},mappingtype:{format:"single",title:"Mapping Type",required:!1,editable:!0,options:[{id:"MergedObject",text:"Merged Object"},{id:"Object",text:"Sub document"},{id:"Array",text:"Array"}]},matchcriteria:{format:"list",title:"Array Match <br>Criteria",required:!1,editable:!1},matchcriteria2:{format:"list",title:"Join Criteria",required:!1,editable:!1},targetpath:{format:"string",title:"Target Path",required:!1,editable:!1}};return t.extend(e,i),e},t.drawArrow=function(t,i,e,s,n){return new h(t,i,e,s,n)},t.drawDiamond=function(t,i,e,h,n){return new s(t,i,e,h,n)},t.drawEllipse=function(t,e,s,h,n){return new i(t,e,s,h,n)},endpoint=function(i){return this.x=0,this.y=0,this.position="",this.shape={name:"arrow",type:1,size:5,sharp:10,radius:5},this.background={filltype:"color",color:"black"},this.border={width:1,type:"solid",color:"black"},t.extend(this,i),this.offsetx=0,this.offsety=0,this.shape.size=this.shape.size?this.shape.size:5,this.shape.sharp=this.shape.sharp?this.shape.sharp:10,this.shape.radius=this.shape.radius?this.shape.radius:5,i&&(this.widget=i.widget),this},endpoint.prototype.persist=function(){var i={};return i.x=this.x,i.y=this.y,i.position=this.position,i.shape={},t.extend(i.shape,this.shape),i.background={},t.extend(i.background,this.background),i.border={},t.extend(i.border,this.border),this.widget&&(i.widget=this.widget.persist()),i};var s=function(t,i,e,s,h){if(void 0===e||void 0===i)return null;if(void 0===e||void 0===i)return null;var n=new Array(i.x,i.y),o=new Array(e.x,e.y),r=h.size?h.size:5,d=h.sharp?h.sharp:10,g=(h.radius&&h.radius,(o[0]-n[0])/(o[1]-n[1]));g=Math.atan(g),t.save(),t.beginPath(),t.translate(o[0],o[1]),o[1]-n[1]>=0?t.rotate(-g):t.rotate(Math.PI-g),1==s?(t.moveTo(0,2*-d),t.lineTo(-r,-d),t.lineTo(0,0),t.lineTo(r,-d),t.lineTo(0,2*-d),t.stroke(),t.restore(),t.closePath()):2==s?(t.moveTo(0,2*-d),t.lineTo(-r,-d),t.lineTo(0,0),t.lineTo(r,-d),t.lineTo(0,2*-d),t.stroke(),t.fill(),t.restore(),t.closePath()):(t.moveTo(0,2*-d),t.lineTo(-r,-d),t.lineTo(0,0),t.lineTo(r,-d),t.lineTo(0,2*-d),t.stroke(),t.fillStyle="white",t.fill(),t.restore(),t.closePath())},h=function(t,i,e,s,h){if(void 0===e||void 0===i)return null;var n=new Array(i.x,i.y),o=new Array(e.x,e.y),r=h.size?h.size:5,d=h.sharp?h.sharp:10,g=h.radius?h.radius:5,a=(o[0]-n[0])/(o[1]-n[1]);a=Math.atan(a),t.save(),t.beginPath(),t.translate(o[0],o[1]),o[1]-n[1]>=0?t.rotate(-a):t.rotate(Math.PI-a),1==s&&(t.moveTo(-r,-d),t.lineTo(0,0),t.lineTo(r,-d),t.stroke(),t.restore(),t.closePath()),2==s?(t.moveTo(-r,-d),t.lineTo(r,-d),t.lineTo(0,0),t.moveTo(-r,-d),t.stroke(),t.fill(),t.restore(),t.closePath()):3==s?(t.moveTo(-r,-d),t.lineTo(r,-d),t.lineTo(0,0),t.lineTo(-r,-d),t.stroke(),t.fillStyle="white",t.fill(),t.restore(),t.closePath()):4==s?(t.moveTo(-r,-d),t.lineTo(0,-g),t.lineTo(r,-d),t.lineTo(0,0),t.lineTo(-r,-d),t.stroke(),t.fill(),t.restore(),t.closePath()):5==s?(t.moveTo(-r,0),t.lineTo(0,-d),t.lineTo(r,0),t.stroke(),t.restore(),t.closePath()):6==s&&(t.moveTo(-r,0),t.lineTo(0,-d),t.lineTo(r,0),t.moveTo(-r,-d),t.lineTo(r,-d),t.stroke(),t.restore(),t.closePath())};label=function(i){var e={name:"label",height:22,margin:10,font:{style:"normal",weight:"normal",family:"Arial",size:"11pt",color:"black",fill:!0},minheight:17};return t.extend(e,i),t.extend(this,new widget(e)),this.type="label",this.propertyEditors=["common","font"],this.afterresize=function(t){this.font.size=this.height-2*this.margin+"pt"},this.beforePaint=function(t){var i=this.margin;"String"==typeof this.font?t.font=this.font:t.font=this.font.style+" "+this.font.weight+" "+this.font.size+" "+this.font.family;var e=t.measureText(this.text);this.width=Math.round(e.width+2*i),this.setResizers()},this},actionWidget=function(i){var e={name:"actionWidget",hyperlink:{window:"",url:"",command:"",type:"url",target:"_blank"},shadow:{color:"black",offsetX:4,offsetY:4,blur:4}};t.extend(e,i),t.extend(this,new widget(e)),this.type="actionWidget",this.click=function(e){!this.editable&&this.hyperlink&&("url"===this.hyperlink.type&&""!=this.hyperlink.url?window.open(this.hyperlink.url,this.hyperlink.target):"window"===this.hyperlink.type&&""!=this.hyperlink.window&&(null!=t.fn.fullpage&&t.fn.fullpage.moveTo&&this.hyperlink.index?t.fn.fullpage.moveTo(this.hyperlink.index,0):this.presenters[0]?this.presenters[0].designer.setActive(parseInt(this.hyperlink.window)):this.root.presenters[0].designer.setActive(parseInt(this.hyperlink.window)))),i.click&&i.click.call(this,e),this.paint()},this.tap=function(t){this.click.call(this,t.originalEvent)}},link=function(i){var e={name:"link",text:"link",font:{style:"normal",weight:"normal",family:"Arial",size:"10pt",color:"blue",fill:!0},shadow:null,height:24,minheight:17};return t.extend(e,i),t.extend(this,new actionWidget(e)),this.propertyEditors=["common","font","hyperlink"],this.afterresize=function(t){this.font.size=this.height-2*this.margin+"pt"},this.beforePaint=function(t){var i=this.margin;"String"==typeof this.font?t.font=this.font:t.font=this.font.style+" "+this.font.weight+" "+this.font.size+" "+this.font.family;var e=t.measureText(this.text);this.width=Math.round(e.width+2*i),this.setResizers()},this.font.color="blue",this.type="link",this},note=function(i){var e={name:"note",text:"note",width:160,height:140,corner:{type:"round",radius:16},background:{filltype:"color",image:"",imageType:"fill",color:"yellow"},font:{style:"normal",weight:"normal",family:"Arial",size:"10pt",color:"blue",fill:!0},paragraph:{linespace:10,textalign:"center",textvalign:"middle"},autosize:!1};return t.extend(e,i),t.extend(this,new actionWidget(e)),this.type="note",this.persist=function(){var i=widget.persistproperty(this);return this.paragraph&&(i.paragraph={},t.extend(i.paragraph,this.paragraph)),i},this.calculateSize=function(i){if(this.text){i.save(),"String"==typeof this.font?i.font=this.font:i.font=this.font.style+" "+this.font.weight+" "+this.font.size+" "+this.font.family;var e=this,s=this.text.split("\n"),h=[];this.paragraph.linespace=parseInt(this.paragraph.linespace),t(s).each(function(t,s){for(var n=s.split(/[\s]/),o="";n.length>0;){var r=n.shift();if(i.measureText(o+" "+r).width>e.width-2*e.margin)if(""!=o&&h.push(o),i.measureText(r).width>e.width-2*e.margin){o="";for(var d=0;d<r.length;d++){var g=r.substring(d,d+1);i.measureText(o+g).width>e.width-2*e.margin?(h.push(o),o=g):o+=g}}else o=r;else o=o?o+" "+r:r}""!=o&&h.push(o)}),this.minheight=this.fontSize()*h.length+this.paragraph.linespace*(h.length-1)+2*this.margin,this.height<this.minheight&&(this.height=this.minheight),i.restore(),this.formatlines=h}return this},this.drawTextTo=function(i){if(this.text){i.save(),"String"==typeof this.font?i.font=this.font:i.font=this.font.style+" "+this.font.weight+" "+this.font.size+" "+this.font.family,i.StrokeStyle=this.font.color||"black",i.fillStyle=this.font.color||"black";var e=this.margin,s=this.margin+this.fontSize();i.textAlign="start","center"===this.paragraph.textalign?(e=this.width/2,i.textAlign="center"):"right"===this.paragraph.textalign&&(e=this.width-this.margin,i.textAlign="end"),i.textBaseline=this.textBaseline||"alphabetic";var h=this;this.paragraph.linespace=parseInt(this.paragraph.linespace),"middle"===this.paragraph.textvalign?s=(this.height-this.minheight)/2+s:"bottom"===this.paragraph.textvalign&&(s=this.height-this.minheight+s),t(this.formatlines).each(function(t,n){h.font.fill?i.fillText(n,e,s,h.width-2*h.margin):i.strokeText(n,e,s,h.width-2*h.margin),s=s+h.fontSize()+h.paragraph.linespace}),i.restore()}},this},noticeboard=function(i){var e={name:"noticeboard",tooltip:null,shadow:{color:"none",offsetX:4,offsetY:4,blur:4},background:{color:"none",filltype:"color",image:null,imageType:"center"},corner:{type:"rect",radius:16},border:{width:1,type:"dashed",color:"black"},hint:{show:!0,hasmask:!0,maskcolor:"#cecccd",maskalpha:.5}};t.extend(e,i),t.extend(this,new note(e)),this.type="noticeboard",0===this.functionPoints.length&&(this.functionPoints=[{x:3*this.width/4,y:0,cursor:"pointer",visible:!0}]),null==this.tooltip?this.tooltip=t.widgets("tooltip",{editable:this.editable,height:50,width:250,text:"",tail:{position:"left",margin:16,size:20},name:this.name+"_tooltip"}):(this.tooltip=new tooltip(this.tooltip),this.tooltip.name=this.name+"_tooltip"),this.beforePaint=function(t){0==this.tooltip.x&&0==this.tooltip.y&&(this.tooltip.x=this.x+this.width+10,this.tooltip.y=this.y-60),this.tooltip.functionPoints[1].visible=!1;var i=this.functionPoints[0],e=this.tooltip.relativePoint(this.x+i.x,this.y+i.y,1);this.tooltip.functionPoints[1].x=e.x,this.tooltip.functionPoints[1].y=e.y,this.editable&&this.presenters[0]&&!this.presenters[0].Widget(this.tooltip)&&this.hint.show&&(this.tooltip.editable=!0,this.presenters[0].appendWidget(this.tooltip))},this.mouseup=function(t){t.offsetX&&(this.tooltip.x+=t.offsetX/this.scale,this.tooltip.y+=t.offsetY/this.scale)},this.mousemove=function(t){if(""!=this.tooltip.text&&!this.editable){var i=this,e=this.tooltip.relativePoint(i.x+i.functionPoints[0].x,i.y+i.functionPoints[0].y);this.tooltip.functionPoints[1].x=e.x,this.tooltip.functionPoints[1].y=e.y,i.paint(),i.hint.hasmask&&(i.paintMask(i.parent),i.paintTo(i.parent.canvas)),this.tooltip.paintTo(i.parent.canvas)}},this.persist=function(){this.presenters[0]&&this.presenters[0].Widget(this.tooltip)?this.presenters[0].removeWidget(this.tooltip):this.parent&&this.parent.Widget(this.tooltip)&&this.parent.removeWidget(this.tooltip);var i=widget.persistproperty(this);return this.paragraph&&(i.paragraph={},t.extend(i.paragraph,this.paragraph)),this.hint&&(i.tooltip=this.tooltip.persist(),i.hint={},t.extend(i.hint,this.hint)),i},this.paintMask=function(t){if(this.hint.hasmask){var i=t.ctx,e=t;i.save(),i.fillStyle=this.hint.maskcolor,i.globalAlpha=this.hint.maskalpha,i.fillRect(e.x,e.y,e.width,e.height),i.restore()}}},checkbox=function(i){var e={name:"checkBox",checked:!0,size:15,text:"checkBox",autosize:!0};return t.extend(e,i),t.extend(this,new widget(e)),this.propertyEditors=["common"],this.allowRotate=!1,this.click=function(t){var e=this;this.checked=!this.checked,i.click&&i.click.call(this,t),this.presenters.length>0?e.paint():this.root.paint()},this.type="checkbox",this.persist=function(){var t=widget.persistproperty(this);return t.checked=this.checked,t},this.drawBorderTo=function(t){var i=this.margin;t.strokeStyle="black",t.lineWidth=1,t.beginPath();var e=this.size;return t.strokeRect(i,i,e,e),this.checked&&(t.moveTo(0+i,e/2+i),t.lineTo(e/2+i,e+i),t.lineTo(e+i,0+i),t.stroke()),this},this.drawTextTo=function(t){var i=this,e=this.margin,s=i.autosize||!1;if(i.text){if("String"==typeof i.font)t.font=i.font;else{var h=i.font.style+" "+i.font.weight+" "+i.font.size+" "+i.font.family;t.font=h}t.fillStyle=i.font.color||"black",t.strokeStyle=i.font.color||"black",aWidth=t.measureText("A"),metrics=t.measureText(i.text),s&&(i.width=Math.round(metrics.width+16+8+2*e),i.height=Math.round(16+2*e),this.setConnectionPoints()),i.font.fill?t.fillText(i.text,24+e,(16+aWidth.width)/2+e):t.strokeText(i.text,24+e,(16+aWidth.width)/2+e)}},this},radio=function(i){var e={name:"radio",text:"radio",radius:15,autosize:!0,allowRotate:!1};return t.extend(e,i),t.extend(this,new checkbox(e)),this.type="radio",this.drawBorderTo=function(t){t.beginPath(),t.strokeStyle="black",t.lineWidth=1;var i=this.radius;return t.arc(i/2+this.margin,i/2+this.margin,i/2,0,2*Math.PI,!0),t.closePath(),t.stroke(),this.checked&&(t.save(),t.fillStyle="black",t.beginPath(),t.arc(i/2+this.margin,i/2+this.margin,i/2-3,0,2*Math.PI,!0),t.stroke(),t.fill(),t.restore()),this},this},box=function(i){var e={border:{width:1,type:"solid",color:"black"},corner:{type:"round",radius:16},background:{filltype:"none",color:"white",image:"",imageType:"fill"},paragraph:{linespace:10,textalign:"center",textvalign:"top"},width:145,height:125,afterresize:function(t){4==t.resizer?(this.functionPoints[0].x+=t.offset.x/2,this.functionPoints[0].y+=t.offset.y):1==t.resizer?(this.functionPoints[0].x-=t.offset.x/2,this.functionPoints[0].y-=t.offset.y):2==t.resizer?(this.functionPoints[0].x+=t.offset.x/2,this.functionPoints[0].y-=t.offset.y):3==t.resizer&&(this.functionPoints[0].x-=t.offset.x/2,this.functionPoints[0].y+=t.offset.y)}};return t.extend(e,i),t.extend(this,new actionWidget(e)),this.propertyEditors=["common","border","corner","font","background","hyperlink"],0===this.functionPoints.length&&(this.functionPoints=[{x:this.width/2,y:this.height+12,cursor:"pointer",visible:!0}]),this.calculateSize=function(t){},this.drawTextTo=function(i){if(this.text){i.save(),"String"==typeof this.font?i.font=this.font:i.font=this.font.style+" "+this.font.weight+" "+this.font.size+" "+this.font.family,i.StrokeStyle=this.font.color||"black",i.fillStyle=this.font.color||"black";var e=this.margin,s=this.height+this.fontSize()+this.margin;i.textAlign="start","center"===this.paragraph.textalign?(e=this.width/2,i.textAlign="center"):"right"===this.paragraph.textalign&&(e=this.width-this.margin,i.textAlign="end"),e=this.functionPoints[0].x,s=this.functionPoints[0].y+18,this.functionPoints[0].visible=!0,i.textBaseline=this.textBaseline||"alphabetic";var h=this,n=this.text.split("\n");t(n).each(function(t,n){h.font.fill?i.fillText(n,e,s):i.strokeText(n,e,s),s=s+h.fontSize()+h.paragraph.linespace}),i.restore()}else this.functionPoints[0].visible=!1},this.type="box",this},line=function(i){var e={name:"line",width:250,height:140,border:{width:1,type:"solid",color:"black"},margin:2,linecap:"round",minheight:0,minwidth:0};return t.extend(e,i),t.extend(this,new widget(e)),this.allowconnectionPoint=!1,this.begin=new endpoint(i.begin),this.end=new endpoint(i.end),this.type="line",this.direction=i.direction?i.direction:1,this.persist=function(){var t=widget.persistproperty(this);return t.direction=this.direction,t.begin=this.begin.persist(),t.end=this.end.persist(),t},this.checkPointIn=function(t,i,e){null!=this.root&&(e=e||this.root.scale),e||(e=1);var s=this.relativePoint(t,i,e),h=s.x,n=s.y;return math.isPointOnLine(h,n,this.begin.x*e,this.begin.y*e,this.end.x*e,this.end.y*e)},this.paintTo=function(t){var i=t.getContext("2d");i.save(),i.scale(this.scaleX,this.scaleY),t!=this.canvas&&i.translate(this.x,this.y),i.rotate(this.rotate/180*Math.PI),i.globalAlpha=this.alpha,this.drawImageTo(i),this.editable&&this.focus&&t!=this.canvas&&this.editable&&!this.autosize&&this.drawResizerTo(i),i.restore()},this.drawImageTo=function(i){if(i.beginPath(),i.strokeStyle=this.border.color,i.lineWidth=this.border.width,i.lineCap=this.linecap,i.fillStyle=this.border.color,"solid"!=this.border.type&&i.setLineDash){var e="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];i.setLineDash(e)}var s=0,h=0;return this.direction&&1!==this.direction?2===this.direction?(i.moveTo(this.width,this.margin),i.lineTo(this.margin,this.height),s={x:this.width,y:this.margin},h={x:this.margin,y:this.height},this.resizers[0].visible=!1,this.resizers[3].visible=!1):3===this.direction?(i.moveTo(this.width,this.height),i.lineTo(this.margin,this.margin),s={x:this.width,y:this.height},h={x:this.margin,y:this.margin},this.resizers[1].visible=!1,this.resizers[2].visible=!1):4===this.direction&&(i.moveTo(this.margin,this.height),i.lineTo(this.width,this.margin),s={x:this.margin,y:this.height},h={x:this.width,y:this.margin},this.resizers[0].visible=!1,this.resizers[3].visible=!1):(i.moveTo(this.margin,this.margin),i.lineTo(this.width,this.height),s={x:this.margin,y:this.margin},h={x:this.width,y:this.height},this.resizers[1].visible=!1,this.resizers[2].visible=!1),this.begin.x=s.x,this.begin.y=s.y,this.end.x=h.x,this.end.y=h.y,i.stroke(),"arrow"===this.begin.shape.name&&h&&s?t.drawArrow(i,h,s,this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"diamond"===this.begin.shape.name?t.drawDiamond(i,h,s,this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"dot"===this.begin.shape.name&&(i.beginPath(),i.arc(s.x,s.y,this.begin.shape.radius,0,2*Math.PI),i.stroke(),2===this.begin.shape.type?i.fill():3===this.begin.shape.type&&(i.fillStyle="white",i.fill())),i.fillStyle=this.border.color,"arrow"===this.end.shape.name&&s&&h?t.drawArrow(i,s,h,this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):"diamond"===this.end.shape.name?t.drawDiamond(i,s,h,this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):"dot"===this.end.shape.name&&(i.beginPath(),i.arc(h.x,h.y,this.end.shape.radius,0,2*Math.PI),i.stroke(),2===this.end.shape.type?i.fill():3===this.end.shape.type&&(i.fillStyle="white",i.fill())),this},this},circle=function(e){var s={name:"circle",width:150,height:150,border:{width:1,type:"solid",color:"black"},background:{filltype:"none",color:"white"},corner:null,margin:2,minheight:15,minwidth:15,autosize:!1};return t.extend(s,e),e.focus&&(s.text=""),t.extend(this,new note(s)),this.propertyEditors=["common","border","font","background","hyperlink"],this.type="circle",this.drawBorderTo=function(t){if(t.save(),t.beginPath(),t.strokeStyle=this.border.color,t.lineWidth=this.border.width,"solid"!=this.border.type&&t.setLineDash){var e="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];t.setLineDash(e)}return i(t,this.width/2,this.height/2,(this.width-2*this.margin)/2,(this.height-2*this.margin)/2),this.fillBackgroundTo(t,2),t.clip(),this.fillBackgroundTo(t),this.drawImageTo(t),t.restore(),this},this},quadraticCurve=function(i){var e={name:"quadraticCurve",width:250,height:140,margin:2,linecap:"round",minheight:0,minwidth:0,border:{width:1,type:"solid",color:"black"}};t.extend(e,i),t.extend(this,new widget(e)),this.allowconnectionPoint=!1,this.begin=new endpoint(i.begin),this.end=new endpoint(i.end),this.type="curve",this.persist=function(){var i=widget.persistproperty(this);return this.resizers&&(i.resizers=[],t.extend(!0,i.resizers,this.resizers)),i.begin=this.begin.persist(),i.end=this.end.persist(),i};var s={x:this.margin,y:this.margin,cursor:"nw-resize",visible:!0},h={x:this.width,y:this.height,cursor:"nw-resize",visible:!0},n={x:this.margin,y:this.height,cursor:"ne-resize",visible:!0};return this.paintTo=function(t){
var i=t.getContext("2d");i.save(),i.scale(this.scaleX,this.scaleY),t!=this.canvas&&i.translate(this.x,this.y),i.rotate(this.rotate/180*Math.PI),i.globalAlpha=this.alpha,this.setResizers(),this.drawImageTo(i),this.focus&&t!=this.canvas&&this.editable?(this.drawResizerTo(i),this.drawSelectRect(i)):this.inselect&&t!=this.canvas&&this.drawSelectRect(i),i.restore()},this.setResizers=function(){i.resizers?this.resizers=i.resizers:this.resizers=[s,n,h]},this.resize=function(t){var i=t.offset.x,e=t.offset.y,s=t.resizer-1;if(s>=0){if(this.resizers[s].x+=i,this.resizers[s].y+=e,this.resizers[s].x<0)this.x+=i,this.resizers[0].x-=i,this.resizers[1].x-=i,this.resizers[2].x-=i;else{var h=Math.min(this.resizers[0].x,this.resizers[1].x,this.resizers[2].x);h>0&&(this.x+=h,this.resizers[0].x-=h,this.resizers[1].x-=h,this.resizers[2].x-=h)}if(this.resizers[s].y<0)this.y+=e,this.resizers[0].y-=e,this.resizers[1].y-=e,this.resizers[2].y-=e;else{var n=Math.min(this.resizers[0].y,this.resizers[1].y,this.resizers[2].y);n>0&&(this.y+=n,this.resizers[0].y-=n,this.resizers[1].y-=n,this.resizers[2].y-=n)}var h=Math.min(this.resizers[0].x,this.resizers[1].x,this.resizers[2].x),n=Math.min(this.resizers[0].y,this.resizers[1].y,this.resizers[2].y),o=Math.max(this.resizers[0].x,this.resizers[1].x,this.resizers[2].x),r=Math.max(this.resizers[0].y,this.resizers[1].y,this.resizers[2].y);this.height=r-n,this.width=o-h}},this.drawImageTo=function(i){if(i.beginPath(),i.strokeStyle=this.border.color,i.lineWidth=this.border.width,i.lineCap=this.linecap,i.fillStyle=this.border.color,"solid"!=this.border.type&&i.setLineDash){var e="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];i.setLineDash(e)}return i.moveTo(this.resizers[0].x,this.resizers[0].y),i.quadraticCurveTo(this.resizers[1].x,this.resizers[1].y,this.resizers[2].x,this.resizers[2].y),i.stroke(),"arrow"===this.begin.shape.name?t.drawArrow(i,this.resizers[1],this.resizers[0],this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"diamond"===this.begin.shape.name?t.drawDiamond(i,this.resizers[1],this.resizers[0],this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"dot"===this.begin.shape.name&&(i.beginPath(),i.arc(this.resizers[0].x,this.resizers[0].y,this.begin.shape.radius,0,2*Math.PI),i.stroke(),2===this.begin.shape.type?i.fill():3===this.begin.shape.type&&(i.fillStyle="white",i.fill())),i.fillStyle=this.border.color,"arrow"===this.end.shape.name?t.drawArrow(i,this.resizers[1],this.resizers[2],this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):"diamond"===this.end.shape.name?t.drawDiamond(i,this.resizers[1],this.resizers[2],this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):"dot"===this.end.shape.name&&(i.beginPath(),i.arc(this.resizers[2].x,this.resizers[2].y,this.end.shape.radius,0,2*Math.PI),i.stroke(),2===this.end.shape.type?i.fill():3===this.end.shape.type&&(i.fillStyle="white",i.fill())),this},this},bezierCurve=function(i){var e={name:"bezierCurve",width:250,height:140,margin:2,linecap:"round",minheight:20,minwidth:30,border:{width:1,type:"solid",color:"black"}};t.extend(e,i),t.extend(this,new widget(e)),this.allowconnectionPoint=!1,this.begin=new endpoint(i.begin),this.end=new endpoint(i.end),this.type="bezierCurve",this.allowRotate=!1,this.text="",this.persist=function(){var i=widget.persistproperty(this);return this.resizers&&(i.resizers=[],t.extend(!0,i.resizers,this.resizers)),i.begin=this.begin.persist(),i.end=this.end.persist(),i};var s={x:this.margin,y:this.margin,cursor:"nw-resize",visible:!0},h={x:this.width,y:this.height,cursor:"nw-resize",visible:!0},n={x:this.margin,y:this.height,cursor:"ne-resize",visible:!0};return controlpoint2={x:this.width,y:this.margin,cursor:"ne-resize",visible:!0},this.paintTo=function(t){var i=t.getContext("2d");i.save(),i.scale(this.scaleX,this.scaleY),t!=this.canvas&&i.translate(this.x,this.y),i.rotate(this.rotate/180*Math.PI),i.globalAlpha=this.alpha,this.setResizers(),this.drawImageTo(i),this.focus&&t!=this.canvas&&this.editable?(this.drawResizerTo(i),this.drawSelectRect(i)):this.inselect&&t!=this.canvas&&this.drawSelectRect(i),i.restore()},this.setResizers=function(){i.resizers?this.resizers=i.resizers:this.resizers=[s,n,controlpoint2,h]},this.resize=function(t){var i=t.offset.x,e=t.offset.y,s=t.resizer-1;if(s>=0){if(this.resizers[s].x+=i,this.resizers[s].y+=e,this.resizers[s].x<0)this.x+=i,this.resizers[0].x-=i,this.resizers[1].x-=i,this.resizers[2].x-=i,this.resizers[3].x-=i;else{var h=Math.min(this.resizers[0].x,this.resizers[1].x,this.resizers[2].x);h>0&&(this.x+=h,this.resizers[0].x-=h,this.resizers[1].x-=h,this.resizers[2].x-=h,this.resizers[3].x-=h)}if(this.resizers[s].y<0)this.y+=e,this.resizers[0].y-=e,this.resizers[1].y-=e,this.resizers[2].y-=e,this.resizers[3].y-=e;else{var n=Math.min(this.resizers[0].y,this.resizers[1].y,this.resizers[2].y);n>0&&(this.y+=n,this.resizers[0].y-=n,this.resizers[1].y-=n,this.resizers[2].y-=n,this.resizers[3].y-=n)}var h=Math.min(this.resizers[0].x,this.resizers[1].x,this.resizers[2].x,this.resizers[3].x),n=Math.min(this.resizers[0].y,this.resizers[1].y,this.resizers[2].y,this.resizers[3].y),o=Math.max(this.resizers[0].x,this.resizers[1].x,this.resizers[2].x,this.resizers[3].x),r=Math.max(this.resizers[0].y,this.resizers[1].y,this.resizers[2].y,this.resizers[3].y);this.height=r-n,this.width=o-h}},this.drawImageTo=function(i){if(i.beginPath(),i.strokeStyle=this.border.color,i.lineWidth=this.border.width,i.lineCap=this.linecap,i.fillStyle=this.border.color,"solid"!=this.border.type&&i.setLineDash){var e="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];i.setLineDash(e)}return i.moveTo(this.resizers[0].x,this.resizers[0].y),i.bezierCurveTo(this.resizers[1].x,this.resizers[1].y,this.resizers[2].x,this.resizers[2].y,this.resizers[3].x,this.resizers[3].y),i.stroke(),"arrow"===this.begin.shape.name?t.drawArrow(i,this.resizers[1],this.resizers[0],this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"diamond"===this.begin.shape.name?t.drawDiamond(i,this.resizers[1],this.resizers[0],this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"dot"===this.begin.shape.name&&(i.beginPath(),i.arc(this.resizers[0].x,this.resizers[0].y,this.begin.shape.radius,0,2*Math.PI),i.stroke(),2===this.begin.shape.type?i.fill():3===this.begin.shape.type&&(i.fillStyle="white",i.fill())),i.fillStyle=this.border.color,"arrow"===this.end.shape.name?t.drawArrow(i,this.resizers[2],this.resizers[3],this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):"diamond"===this.begin.shape.name?t.drawDiamond(i,this.resizers[2],this.resizers[3],this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"dot"===this.end.shape.name&&(i.beginPath(),i.arc(this.resizers[3].x,this.resizers[3].y,this.end.shape.radius,0,2*Math.PI),i.stroke(),2===this.end.shape.type?i.fill():3===this.end.shape.type&&(i.fillStyle="white",i.fill())),this},this},tooltip=function(i){var e={name:"tooltip",text:"tooltip",height:140,width:280,corner:{type:"round",radius:8},background:{filltype:"color",image:"",imageType:"fill",color:"white"},font:{style:"normal",weight:"normal",family:"Arial",size:"10pt",color:"black",fill:!0},paragraph:{linespace:10,textalign:"left"},tail:{position:"top",margin:16,size:20}};return t.extend(e,i),t.extend(this,new note(e)),this.type="tooltip",this.setFunctionPoints=function(){"top"==this.tail.position?0===this.functionPoints.length?this.functionPoints=[{x:this.tail.margin,y:0,cursor:"pointer",visible:!0},{x:this.tail.margin+this.tail.size/2,y:-15,cursor:"pointer",visible:!0},{x:this.tail.margin+this.tail.size,y:0,cursor:"pointer",visible:!0}]:this.functionPoints=[{x:this.tail.margin,y:0,cursor:"pointer",visible:!0},this.functionPoints[1],{x:this.tail.margin+this.tail.size,y:0,cursor:"pointer",visible:!0}]:"bottom"==this.tail.position?0===this.functionPoints.length?this.functionPoints=[{x:this.tail.margin,y:this.height,cursor:"pointer",visible:!0},{x:this.tail.margin+this.tail.size/2,y:this.height+this.tail.size,cursor:"pointer",visible:!0},{x:this.tail.margin+this.tail.size,y:this.height,cursor:"pointer",visible:!0}]:this.functionPoints=[{x:this.tail.margin,y:this.height,cursor:"pointer",visible:!0},this.functionPoints[1],{x:this.tail.margin+this.tail.size,y:this.height,cursor:"pointer",visible:!0}]:"left"==this.tail.position?0===this.functionPoints.length?this.functionPoints=[{x:0,y:this.tail.margin,cursor:"pointer",visible:!0},{x:-this.tail.size,y:this.tail.margin+this.tail.size/2,cursor:"pointer",visible:!0},{x:0,y:this.tail.margin+this.tail.size,cursor:"pointer",visible:!0}]:this.functionPoints=[{x:0,y:this.tail.margin,cursor:"pointer",visible:!0},this.functionPoints[1],{x:0,y:this.tail.margin+this.tail.size,cursor:"pointer",visible:!0}]:"right"==this.tail.position&&(0===this.functionPoints.length?this.functionPoints=[{x:this.width,y:this.tail.margin,cursor:"pointer",visible:!0},{x:this.width+this.tail.size,y:this.tail.margin+this.tail.size/2,cursor:"pointer",visible:!0},{x:this.width,y:this.margin+this.tail.size,y:this.tail.margin+this.tail.size,cursor:"pointer",visible:!0}]:this.functionPoints=[{x:this.width,y:this.tail.margin,cursor:"pointer",visible:!0},this.functionPoints[1],{x:this.width,y:this.margin+this.tail.size,y:this.tail.margin+this.tail.size,cursor:"pointer",visible:!0}])},this.setFunctionPoints(),this.beforePaint=function(t){this.setFunctionPoints()},this.persist=function(){var i=widget.persistproperty(this);return this.paragraph&&(i.paragraph={},t.extend(i.paragraph,this.paragraph)),this.tail&&(i.tail={},t.extend(i.tail,this.tail)),i},this.drawBorderTo=function(t){t.save();var i=0;if(this.border.width=parseInt(this.border.width),t.beginPath(),t.lineWidth=this.border.width,t.strokeStyle=this.border.color,t.fillStyle=this.background.color,"String"==typeof this.font?t.font=this.font:t.font=this.font.style+" "+this.font.weight+" "+this.font.size+" "+this.font.family,"solid"!==this.border.type&&t.setLineDash){var e="dashed"===this.border.type?[this.border.width+3,this.border.width+1]:[this.border.width+1,this.border.width+1];t.setLineDash(e)}"round"===this.corner.type&&(i=this.corner.radius),"top"===this.tail.position?(t.moveTo(0,this.height-i),t.lineTo(0,i),t.arcTo(0,0,i,0,i),t.lineTo(this.functionPoints[0].x,this.functionPoints[0].y),t.lineTo(this.functionPoints[1].x,this.functionPoints[1].y),t.lineTo(this.functionPoints[2].x,this.functionPoints[2].y),t.lineTo(this.width-i,0),t.arcTo(this.width,0,this.width,i,i),t.lineTo(this.width,this.height-i),t.arcTo(this.width,this.height,this.width-i,this.height,i),t.lineTo(i,this.height),t.arcTo(0,this.height,0,this.height-i,i),t.stroke()):"bottom"===this.tail.position?(t.moveTo(0,this.height-i),t.lineTo(0,i),t.arcTo(0,0,i,0,i),t.lineTo(this.width-i,0),t.arcTo(this.width,0,this.width,i,i),t.lineTo(this.width,this.height-i),t.arcTo(this.width,this.height,this.width-i,this.height,i),t.lineTo(this.functionPoints[2].x,this.functionPoints[2].y),t.lineTo(this.functionPoints[1].x,this.functionPoints[1].y),t.lineTo(this.functionPoints[0].x,this.functionPoints[0].y),t.lineTo(i,this.height),t.arcTo(0,this.height,0,this.height-i,i),t.stroke()):"right"===this.tail.position?(t.moveTo(0,this.height-i),t.lineTo(0,i),t.arcTo(0,0,i,0,i),t.lineTo(this.width-i,0),t.arcTo(this.width,0,this.width,i,i),t.lineTo(this.functionPoints[0].x,this.functionPoints[0].y),t.lineTo(this.functionPoints[1].x,this.functionPoints[1].y),t.lineTo(this.functionPoints[2].x,this.functionPoints[2].y),t.lineTo(this.width,this.height-i),t.arcTo(this.width,this.height,this.width-i,this.height,i),t.lineTo(i,this.height),t.arcTo(0,this.height,0,this.height-i,i),t.stroke()):"left"===this.tail.position&&(t.moveTo(0,this.height-i),t.lineTo(0,i+this.tail.margin+this.tail.size),t.lineTo(this.functionPoints[2].x,this.functionPoints[2].y),t.lineTo(this.functionPoints[1].x,this.functionPoints[1].y),t.lineTo(this.functionPoints[0].x,this.functionPoints[0].y),t.lineTo(0,i),t.arcTo(0,0,i,0,i),t.lineTo(this.width-i,0),t.arcTo(this.width,0,this.width,i,i),t.lineTo(this.width,this.height-i),t.arcTo(this.width,this.height,this.width-i,this.height,i),t.lineTo(i,this.height),t.arcTo(0,this.height,0,this.height-i,i),t.stroke()),this.fillBackgroundTo(t,2),t.clip(),this.drawImageTo(t),t.restore()},this.afterfunctionPoint=function(t){var i=0;if("round"===this.corner.type&&(i=this.corner.radius),"top"==this.tail.position){if(1==t.functionPoint){var e=this.tail.margin+t.offset.x;e>i&&e<this.width-2*i-this.tail.size&&(this.tail.margin=e)}else if(3==t.functionPoint){var e=this.tail.size+t.offset.x;e>15&&e<this.width-2*i-this.tail.margin&&(this.tail.size=e)}}else if("bottom"==this.tail.position){if(1==t.functionPoint){var e=this.tail.margin+t.offset.x;e>i&&e<this.width-2*i-this.tail.size&&(this.tail.margin=e)}else if(3==t.functionPoint){var e=this.tail.size+t.offset.x;e>15&&e<this.width-2*i-this.tail.margin&&(this.tail.size=e)}}else if("right"==this.tail.position){if(1==t.functionPoint){var s=this.tail.margin+t.offset.y;s>i&&s<this.height-2*i-this.tail.size&&(this.tail.margin=s)}else if(3==t.functionPoint){var e=this.tail.size+t.offset.y;e>15&&e<this.height-2*i-this.tail.margin&&(this.tail.size=e)}}else if("left"==this.tail.position)if(1==t.functionPoint){var e=this.tail.margin+t.offset.y;e>i&&e<this.height-2*i-this.tail.size&&(this.tail.margin=e)}else if(3==t.functionPoint){var e=this.tail.size+t.offset.y;e>15&&e<this.height-2*i-this.tail.margin&&(this.tail.size=e)}},this},textInput=function(i){var e={name:"textInput",text:"textInput",width:150,height:35,minheight:15,margin:10,shadow:{color:"none",offsetX:4,offsetY:4,blur:4},corner:{type:"rect",radius:8},background:{filltype:"color",image:"",imageType:"fill",color:"white"},border:{color:"#e5cdcd",width:1,type:"solid"},font:{style:"italic",weight:"normal",family:"Arial",size:"10pt",color:"black",fill:!0}};t.extend(e,i),t.extend(this,new note(e)),this.propertyEditors=["common","border","font"],this.type="textInput"},spirograph=function(i){var e={name:"spirograph",corner:null,background:{filltype:"none",image:"",imageType:"fill",color:"white"},border:{width:1,type:"solid",color:"black"},width:150,height:150,linecap:"round",minheight:20,minwidth:20,spirograph:{R:1,r:1,o:40}};t.extend(e,i),t.extend(this,new note(e)),this.propertyEditors=["common","border","font","background","shadow","hyperlink","paragraph"],this.type="spirograph",this.persist=function(){var i=widget.persistproperty(this);return this.paragraph&&(i.paragraph={},t.extend(i.paragraph,this.paragraph)),this.spirograph&&(i.spirograph={},t.extend(i.spirograph,this.spirograph)),i},this.drawSpirograph=function(t,i,e,s){var h=i-s,n=0,o=1;t.beginPath(),t.moveTo(h,n);do{if(o>2e3)break;var r=(i+e)*Math.cos(o*Math.PI/72)-(e+s)*Math.cos((i+e)/e*(o*Math.PI/72)),d=(i+e)*Math.sin(o*Math.PI/72)-(e+s)*Math.sin((i+e)/e*(o*Math.PI/72));t.lineTo(r,d),h=r,n=d,o++}while(r!=i-s&&0!=d);t.stroke()},this.drawBorderTo=function(t){var i=this;if(this.spirograph.o=Math.min(this.width,this.height)/2,"none"===i.border.color&&i.background&&"color"===i.background.filltype&&"none"!=i.background.color?i.border.color=i.background.color:"none"===i.border.color&&i.background&&"gradient"===i.background.filltype&&"none"!=i.gradient.begincolor&&(i.border.color=i.gradient.begincolor),"none"!==i.border.color){if(t.save(),t.beginPath(),t.lineJoin="round",i.border.width=parseInt(i.border.width),t.lineWidth=i.border.width,t.lineCap="round",t.strokeStyle=i.border.color,"solid"!==i.border.type){var e="dashed"===i.border.type?[i.border.width+3,i.border.width+1]:[i.border.width+1,i.border.width+1];t.setLineDash(e)}t.translate(this.width/2,this.height/2);var s=this.spirograph.o;this.drawSpirograph(t,s*(this.spirograph.r+5)/10,-s*(this.spirograph.R/10),s/2),this.drawShadowTo(t),this.fillBackgroundTo(t,2),t.clip(),this.fillBackgroundTo(t),this.drawImageTo(t),t.restore()}else this.fillBackgroundTo(t),this.drawImageTo(t);return this}},polygon=function(i){var e={name:"polygon",corner:null,background:{filltype:"none",image:"",imageType:"fill",color:"white"},border:{width:1,type:"solid",color:"black"},width:150,height:150,linecap:"round",minheight:20,minwidth:20,polygon:{sides:7,startAngle:0}};t.extend(e,i),i.focus&&(e.text=""),t.extend(this,new note(e)),this.propertyEditors=["common","border","font","background","hyperlink"];var s=[];this.type="polygon",this.persist=function(){var i=widget.persistproperty(this);return this.paragraph&&(i.paragraph={},t.extend(i.paragraph,this.paragraph)),this.polygon&&(i.polygon={},t.extend(i.polygon,this.polygon)),i};var h=function(t,i,e,s,h){for(var n=[],o=h*Math.PI/180||0,r=0;r<s;r++)n.push({x:t+e*Math.sin(o),y:i-e*Math.cos(o)}),o+=2*Math.PI/s;return n};this.refresh=function(){s=h(this.width/2,this.height/2,this.polygon.radius,this.polygon.sides,this.polygon.startAngle)},this.afterresize=function(t){this.refresh()},this.drawBorderTo=function(t){var i=this;if(this.polygon.radius=Math.min(this.height,this.width)/2,this.refresh(),"none"===i.border.color&&i.background&&"color"===i.background.filltype&&"none"!=i.background.color?i.border.color=i.background.color:"none"===i.border.color&&i.background&&"gradient"===i.background.filltype&&"none"!=i.gradient.begincolor&&(i.border.color=i.gradient.begincolor),"none"!==i.border.color){if(t.save(),t.beginPath(),t.lineJoin="round",i.border.width=parseInt(i.border.width),t.lineWidth=i.border.width,t.lineCap="round",t.strokeStyle=i.border.color,"solid"!==i.border.type){var e="dashed"===i.border.type?[i.border.width+3,i.border.width+1]:[i.border.width+1,i.border.width+1];t.setLineDash(e)}if(s.length>0){t.moveTo(s[0].x,s[0].y);for(var h=1;h<s.length;h++)t.lineTo(s[h].x+0,s[h].y+0);t.closePath()}t.stroke(),this.drawShadowTo(t),this.fillBackgroundTo(t,2),t.clip(),this.fillBackgroundTo(t),this.drawImageTo(t),t.restore()}else this.fillBackgroundTo(t),this.drawImageTo(t);return this}},triangle=function(i){var e={name:"triangle",corner:null,background:{filltype:"none",image:"",imageType:"fill",color:"white"},width:150,height:150,linecap:"round",afterresize:function(t){this.functionPoints[0].x+=t.offset.x/2,this.functionPoints[0].x=Math.max(this.functionPoints[0].x,0),this.functionPoints[0].x=Math.min(this.functionPoints[0].x,this.width)},afterfunctionPoint:function(t){this.functionPoints[0].y=0,this.functionPoints[0].x=Math.max(this.functionPoints[0].x,0),this.functionPoints[0].x=Math.min(this.functionPoints[0].x,this.width)}};return t.extend(e,i),i.focus&&(e.text=""),t.extend(this,new note(e)),this.propertyEditors=["common","border","font","background","hyperlink"],0==this.functionPoints.length&&(this.functionPoints=[{x:75,y:0,cursor:"pointer",visible:!0}]),this.end=null,this.type="triangle",this.drawBorderTo=function(t){var i=.5;if(t.save(),t.beginPath(),t.strokeStyle=this.border.color,t.lineWidth=this.border.width,t.lineCap=this.linecap,t.lineJoin="round",this.border.width>1&&(i=0),"solid"!=this.border.type&&t.setLineDash){var e="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];t.setLineDash(e)}return t.moveTo(this.functionPoints[0].x+i,this.functionPoints[0].y+i),t.lineTo(this.resizers[2].x+i,this.resizers[2].y+i),t.lineTo(this.resizers[3].x+i,this.resizers[3].y+i),t.closePath(),t.stroke(),this.fillBackgroundTo(t,2),t.clip(),this.fillBackgroundTo(t),this.drawImageTo(t),t.restore(),this},this},parallelogram=function(i){var e={name:"parallelogram",corner:null,width:150,height:150,background:{filltype:"none",color:"white"},linecap:"round",offsetx:0,afterresize:function(t){this.width<this.offsetx+10&&(this.width=this.offsetx+10)},afterfunctionPoint:function(t){this.functionPoints[0].y=0;var i=this.offsetx;this.offsetx+=t.offset.x,i<0&&this.offsetx<0?(this.width-=t.offset.x,this.x+=t.offset.x):i>0&&this.offsetx>0&&(this.width+=t.offset.x),this.setfunctionPoints()}};return t.extend(e,i),i.focus&&(e.text=""),t.extend(this,new note(e)),this.propertyEditors=["common","border","font","background","shadow","hyperlink","paragraph"],this.setfunctionPoints=function(){var t=this.offsetx;this.functionPoints=t>=0?[{x:t,y:0,cursor:"pointer",visible:!0}]:[{x:0,y:0,cursor:"pointer",visible:!0}]},this.functionPoints.length<1&&this.setfunctionPoints(),this.type="parallelogram",this.drawBorderTo=function(t){var i=0;if(t.save(),t.beginPath(),t.strokeStyle=this.border.color,t.lineWidth=this.border.width,1===this.border.width&&(i=.5),t.lineCap=this.linecap,"solid"!=this.border.type&&t.setLineDash){var e="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];t.setLineDash(e)}return this.setResizers(),t.moveTo(this.functionPoints[0].x+i,this.functionPoints[0].y+i),this.offsetx>=0?(t.lineTo(this.resizers[1].x+i,this.resizers[1].y+i),t.lineTo(this.resizers[1].x+i-this.offsetx,this.resizers[2].y+i),t.lineTo(this.resizers[2].x+i,this.resizers[2].y+i)):(t.lineTo(this.resizers[1].x+i+this.offsetx,this.resizers[1].y+i),t.lineTo(this.resizers[3].x+i,this.resizers[3].y+i),t.lineTo(this.resizers[2].x+i-this.offsetx,this.resizers[2].y+i)),t.closePath(),t.stroke(),this.fillBackgroundTo(t,2),t.clip(),this.fillBackgroundTo(t),this.drawImageTo(t),t.restore(),this},this},quadrangle=function(i){var e={name:"quadrangle",corner:null,width:150,height:150,background:{filltype:"none",color:"white"},linecap:"round",afterresize:function(t){this.functionPoints[1].x+=t.offset.x,1!=t.resizer&&3!=t.resizer||(this.functionPoints[1].x-=2*t.offset.x),this.functionPoints[0].x=Math.max(0,this.functionPoints[0].x),this.functionPoints[0].x=Math.min(this.functionPoints[0].x,this.width/2),this.functionPoints[1].x=Math.max(this.width/2,this.functionPoints[1].x),this.functionPoints[1].x=Math.min(this.functionPoints[1].x,this.width)},afterfunctionPoint:function(t){this.functionPoints[0].y=0,this.functionPoints[0].x=Math.max(0,this.functionPoints[0].x),this.functionPoints[0].x=Math.min(this.functionPoints[0].x,this.width/2),this.functionPoints[1].y=0,this.functionPoints[1].x=Math.max(this.width/2,this.functionPoints[1].x),this.functionPoints[1].x=Math.min(this.functionPoints[1].x,this.width)}};return t.extend(e,i),i.focus&&(e.text=""),t.extend(this,new note(e)),this.propertyEditors=["common","border","font","background","hyperlink"],0==this.functionPoints.length&&(this.functionPoints=[{x:0,y:0,cursor:"pointer",visible:!0},{x:this.width,y:0,cursor:"pointer",visible:!0}]),this.type="quadrangle",this.drawBorderTo=function(t){var i=.5;if(t.save(),t.beginPath(),t.strokeStyle=this.border.color,t.lineWidth=this.border.width,this.border.width>1&&(i=0),t.lineCap=this.linecap,"solid"!=this.border.type&&t.setLineDash){var e="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];t.setLineDash(e)}return this.setResizers(),t.moveTo(this.functionPoints[0].x+i,this.functionPoints[0].y+i),t.lineTo(this.functionPoints[1].x+i,this.functionPoints[1].y+i),t.lineTo(this.resizers[3].x+i,this.resizers[3].y+i),t.lineTo(this.resizers[2].x+i,this.resizers[2].y+i),t.closePath(),t.stroke(),this.fillBackgroundTo(t,2),t.clip(),this.fillBackgroundTo(t),this.drawImageTo(t),t.restore(),this},this},pentagon=function(i){var e={name:"pentagon",corner:null,width:200,height:150,linecap:"round",background:{filltype:"none",color:"white"},arrow:{sharp:20},afterresize:function(t){this.width<this.arrow.sharp+10&&(this.width=this.arrow.sharp+10),this.setfunctionPoints()},afterfunctionPoint:function(t){this.arrow.sharp-=t.offset.x,this.arrow.sharp<0?this.arrow.sharp=0:this.arrow.sharp>this.width&&(this.arrow.sharp=this.width),this.setfunctionPoints()}};return t.extend(e,i),i.focus&&(e.text=""),t.extend(this,new note(e)),this.propertyEditors=["common","border","font","background","shadow","hyperlink","paragraph"],this.setfunctionPoints=function(){this.functionPoints=[{x:this.width-this.arrow.sharp,y:0,cursor:"pointer",visible:!0}]},0==this.functionPoints.length&&this.setfunctionPoints(),this.type="pentagon",this.drawBorderTo=function(t){var i=0;if(t.save(),t.beginPath(),t.strokeStyle=this.border.color,t.lineWidth=this.border.width,1==this.border.width&&(i=.5),t.lineCap=this.linecap,"solid"!=this.border.type&&t.setLineDash){var e="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];t.setLineDash(e)}return this.setResizers(),t.moveTo(i,i),t.lineTo(this.width-this.arrow.sharp+i,i),t.lineTo(this.width+i,this.height/2+i),t.lineTo(this.width-this.arrow.sharp+i,this.height+i),t.lineTo(i,this.height+i),t.lineTo(i,i),t.stroke(),this.fillBackgroundTo(t,2),t.clip(),this.fillBackgroundTo(t),this.drawImageTo(t),t.restore(),this},this},swallowtailed=function(i){var e={name:"swallowtailed",corner:null,width:200,height:150,linecap:"round",background:{filltype:"none",color:"white"},afterresize:function(t){2!=t.resizer&&4!=t.resizer||(this.functionPoints[0].x+=t.offset.x)},afterfunctionPoint:function(t){this.functionPoints[0].y=0,this.functionPoints[0].x=Math.max(this.functionPoints[0].x,10),this.functionPoints[0].x=Math.min(this.functionPoints[0].x,this.width)}};return t.extend(e,i),i.focus&&(e.text=""),t.extend(this,new note(e)),this.propertyEditors=["common","border","font","background","shadow","hyperlink","paragraph"],0==this.functionPoints.length&&(this.functionPoints=[{x:this.width-20,y:0,cursor:"pointer",visible:!0}]),this.type="swallowtailed",this.drawBorderTo=function(t){var i=0;if(t.save(),t.beginPath(),t.strokeStyle=this.border.color,t.lineWidth=this.border.width,1===this.border.width&&(i=.5),t.lineCap=this.linecap,"solid"!=this.border.type&&t.setLineDash){var e="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];t.setLineDash(e)}return this.setResizers(),t.moveTo(this.resizers[0].x+i,this.resizers[0].y+i),t.lineTo(this.functionPoints[0].x+i,this.functionPoints[0].y+i),t.lineTo(this.width+i,this.height/2+i),t.lineTo(this.functionPoints[0].x+i,this.height+i),t.lineTo(this.resizers[2].x+i,this.resizers[2].y+i),t.lineTo(this.width-this.functionPoints[0].x+i,this.height/2+i),t.closePath(),t.stroke(),this.fillBackgroundTo(t,2),t.clip(),this.fillBackgroundTo(t),this.drawImageTo(t),t.restore(),this},this},spirit=function(i){var e={name:"spirit",width:121,height:168,text:"",font:null,border:{color:"none",width:1,type:"solid"},background:{filltype:"images",color:"white",image:null,imageType:"fill"},spirit:{images:[],index:0,interval:6,direction:"forward",autoplay:!1},mousedown:function(t){this.oldx=t.x,this.oldy=t.y,this.isdown=!0},mousemove:function(t){if(this.isdown){var i=t.x-this.oldx;this.oldx=t.x,this.oldy=t.y,i>=2?(this.spirit.index++,this.spirit.index==this.spirit.images.length&&(this.spirit.index=0),this.paint()):i<=-2&&(this.spirit.index--,this.spirit.index<0&&(this.spirit.index=this.spirit.images.length-1),this.paint())}},mouseup:function(t){this.isdown=!1},click:function(t){this.spirit.index++,this.spirit.index==this.spirit.images.length&&(this.spirit.index=0),this.paint()}};t.extend(e,i),t.extend(this,new note(e)),this.propertyEditors=["common","border","font","background","shadow","hyperlink","paragraph"],this.spirit.direction=this.spirit.direction||"forward1",this.type="spirit",this.isdown=!1,this.init=function(){var i=[];t(this.spirit.images).each(function(t,e){var s="";if("string"==typeof(s="string"==typeof e?e:e.value)){var h=new Image;h.src=s,i.push(h)}}),this.spirit._images=i,this.spirit.index=this.spirit.index||0,this.spirit.interval=this.spirit.interval||1},this.init();var s=0;this.panright=function(t){3==++s&&(this.forward(),this.paint(),s=0)},this.panleft=function(t){3==++s&&(this.backward(),this.paint(),s=0)},this.appendPresenter=function(t){return this.parent=t.rootwidget,this.root=t.rootwidget,t.widgets.push(this),this.depth=t.widgets.length,this.presenters.push(t),this.spirit.autoplay&&(t.globalAnimations||(t.globalAnimations=[]),t.globalAnimations.push(this)),this},this.persist=function(){var i=widget.persistproperty(this);return i.spirit={},i.spirit.images=[],i.spirit.autoplay=this.spirit.autoplay,i.spirit.interval=this.spirit.interval,t(this.spirit.images).each(function(t,e){i.spirit.images.push(e)}),i},this.drawImageTo=function(t){var i=this,e=null;if(null!=i.background&&("images"==i.background.filltype||"image"==i.background.filltype)){"images"==i.background.filltype?(this.spirit.index<this.spirit.images.length&&(e=this.spirit._images[this.spirit.index]),null==e&&(e=i.background.image)):e=i.background.image;var s=i.background.imageType?i.background.imageType:"fit";if(e)if("fit"===s){var h,n=0,o=0,r=0;e.width>i.width?(n=i.width,(h=e.height/e.width*n)>i.height&&(h=i.height,n=e.width/e.height*h)):(h=i.height,(n=e.width/e.height*h)>i.width&&(n=i.width,h=e.height/e.width*n)),o=(i.width-n)/2,r=(i.height-h)/2,t.drawImage(e,o,r,n,h)}else if("repeat"===s){for(var n=i.width,h=i.height,o=0,r=0;;)if(t.drawImage(e,o,r,e.width,e.height),(o+=e.width)>n){if(!((r+=e.height)<h))break;o=0}}else if("fill"===s)t.drawImage(e,0,0,i.width,i.height);else if("center"===s){var n=e.width,h=e.height,o=0,r=0;o=(i.width-n)/2,r=(i.height-h)/2,t.drawImage(e,o,r,n,h)}return this}};this.run=function(){var t=this,i={index:0},e={index:this.spirit.images.length-1};new TWEEN.Tween(i).to(e,1e3*t.spirit.interval).delay(0).repeat(1/0).easing(TWEEN.Easing.Linear.None).onUpdate(function(){for(var e in i)t.spirit[e]=parseInt(this[e])}).onComplete(function(){}).start()}},t.register("box",box),t.register("label",label),t.register("note",note),t.register("link",link),t.register("checkbox",checkbox),t.register("textInput",textInput),t.register("tooltip",tooltip),t.register("radio",radio),t.register("line",line),t.register("curve",quadraticCurve),t.register("bezierCurve",bezierCurve),t.register("triangle",triangle),t.register("quadrangle",quadrangle),t.register("parallelogram",parallelogram),t.register("pentagon",pentagon),t.register("swallowtailed",swallowtailed),t.register("circle",circle),t.register("noticeboard",noticeboard),t.register("polygon",polygon),t.register("spirograph",spirograph),t.register("spirit",spirit)}(jQuery),function(t){t.connector=function(t,i){return"lineConnector"===t?new lineConnector(i||{}):"brokenLineConnector"===t?new brokenLineConnector(i||{}):"quadraticCurveConnector"===t?new quadraticCurveConnector(i||{}):"relationConnector"===t?new relationConnector(i||{}):"referenceConnector"===t?new referenceConnector(i||{}):"mapConnector"===t?new mapConnector(i||{}):new widget(i||{})},_connector=function(i){var e={border:{width:1,type:"solid",color:"black"},offsetX:35,offsetY:35,minOffset:20,dashOffset:0,dashColor:"green",corner:null,selectable:!1,linefixed:!1,linecap:"round"};return t.extend(e,i),t.extend(this,new widget(e)),this.allowconnectionPoint=!1,this.appendPresenter=function(t){return this.parent=t.rootwidget,this.root=t.rootwidget,t.widgets.push(this),this.depth=t.widgets.length,this.presenters.push(t),this.begin&&this.begin.widget&&this.end&&this.end.widget&&this.paint(),this},this.persist=function(){var t=widget.persistproperty(this);return t.offsetX=this.offsetX,t.offsetY=this.offsetY,t.linecap=this.linecap,t.minOffset=this.minOffset,t.dashOffset=this.dashOffset,t.begin=this.begin.persist(),t.end=this.end.persist(),t},this.appendPresenter=function(t){return this.parent=t.rootwidget,this.root=t.rootwidget,t.widgets.push(this),this.depth=t.widgets.length,this.presenters.push(t),t.globalAnimations||(t.globalAnimations=[]),t.globalAnimations.push(this),this},this.run=function(t){var i=this,e={dashOffset:0},s={dashOffset:20};new TWEEN.Tween(e).to(s,1e3).delay(0).repeat(1/0).easing(TWEEN.Easing.Linear.None).onUpdate(function(){for(var t in e)i[t]=parseInt(this[t])}).onComplete(function(){}).start()},this},
brokenLineConnector=function(i){var e={name:"brokenLineConnector",width:150,height:50,linefixed:!1,text:"brokenLineConnector"};return t.extend(e,i),t.extend(this,new _connector(e)),this.propertyEditors=["common","border","arrow"],this.begin=new endpoint(i.begin),this.end=new endpoint(i.end),this.type="brokenLineConnector",this.checkPointIn=function(t,i,e){null!=this.root&&(e=e||this.root.scale),e||(e=1);for(var s=this.relativePoint(t,i,e),h=s.x,n=s.y,o=0;o<this.resizers.length-1;o++)if(1==math.isPointOnLine(h,n,this.resizers[o].x*e,this.resizers[o].y*e,this.resizers[o+1].x*e,this.resizers[o+1].y*e))return!0;return!1},this.persist=function(){var t=widget.persistproperty(this);return t.offsetX=this.offsetX,t.offsetY=this.offsetY,t.linecap=this.linecap,t.minOffset=this.minOffset,t.begin=this.begin.persist(),t.end=this.end.persist(),t.begin.position=this.begin.position,t.end.position=this.end.position,t},this.setResizers=function(){var t=16,i={x:this.begin.x+this.begin.widget.x,y:this.begin.y+this.begin.widget.y},e={x:this.end.x+this.end.widget.x,y:this.end.y+this.end.widget.y};this.begin.widget.x+this.begin.widget.width<this.end.widget.x+this.end.x?(this.end.position||(this.end.position="left"),this.begin.widget.y+this.begin.widget.height<this.end.widget.y+this.end.y?("top"===this.begin.position?(i.y=this.begin.widget.y,this.end.position="top",e.y=this.end.widget.y+this.end.offsety):"left"===this.begin.position?(this.end.position="left",i.x=this.begin.widget.x,e.x=this.end.widget.x+this.end.offsetx):"right"===this.begin.position?(i.x=this.begin.widget.x+this.begin.widget.width,this.begin.widget.x+this.begin.widget.width>this.end.widget.x-t?(this.end.position="top",e.y=this.end.widget.y+this.end.offsety):this.begin.widget.y+this.begin.y>this.end.widget.y-t&&(this.end.position="left",e.x=this.end.widget.x+this.end.offsetx)):(i.y=this.begin.widget.y+this.begin.widget.height,this.begin.widget.y+this.begin.widget.height>this.end.widget.y-t?(this.end.position="left",e.x=this.end.widget.x+this.end.offsetx):this.begin.widget.x+this.begin.x>this.end.widget.x-t&&(this.end.position="top",e.y=this.end.widget.y+this.end.offsety)),"left"==this.end.position?e.x=this.end.widget.x+this.end.offsetx:"right"===this.end.position?(this.end.position="left",e.x=this.end.widget.x+this.end.offsetx):"top"==this.end.position?e.y=this.end.widget.y+this.end.offsety:"bottom"==this.end.position&&(this.end.position="top",e.y=this.end.widget.y+this.end.offsety)):this.begin.widget.y>this.end.widget.y+this.end.y?("bottom"===this.begin.position?(i.y=this.begin.widget.y+this.begin.widget.height,this.end.position="bottom",e.y=this.end.widget.y+this.end.widget.height-this.end.offsety):"left"===this.begin.position?(this.end.position="left",i.x=this.begin.widget.x,e.x=this.end.widget.x+this.end.offsetx):"right"===this.begin.position?(i.x=this.begin.widget.x+this.begin.widget.width,this.begin.widget.x+this.begin.widget.width>this.end.widget.x-t?(this.end.position="bottom",e.y=this.end.widget.y+this.end.widget.height-this.end.offsety):this.begin.widget.y+this.begin.y<this.end.widget.y+this.end.widget.height-t&&(this.end.position="left",e.x=this.end.widget.x+this.end.offsetx)):(i.y=this.begin.widget.y,this.begin.widget.y<this.end.widget.y+this.end.widget.height+t?(this.end.position="left",e.x=this.end.widget.x+this.end.offsetx):this.begin.widget.x+this.begin.x>this.end.widget.x-t&&(this.end.position="bottom",e.y=this.end.widget.y-this.end.offsety)),"left"==this.end.position?e.x=this.end.widget.x+this.end.offsetx:"right"==this.end.position?(this.end.position="left",e.x=this.end.widget.x+this.end.offsetx):"bottom"==this.end.position?e.y=this.end.widget.y+this.end.widget.height+this.end.offsety:"top"==this.end.position&&(this.end.position="bottom",e.y=this.end.widget.y+this.end.widget.height-this.end.offsety)):"top"===this.begin.position?(this.end.position="top",e.y=this.end.widget.y+this.end.offsety,i.y=this.begin.widget.y):"bottom"===this.begin.position?(this.end.position="bottom",e.y=this.end.widget.y+this.end.widget.height-this.end.offsety,i.y=this.begin.widget.y+this.begin.widget.height):(i.x=this.begin.widget.x+this.begin.widget.width,this.begin.position="right",e.x=this.end.widget.x+this.end.offsetx,this.end.position="left")):this.end.widget.x+this.end.widget.width<this.begin.widget.x+this.begin.x?(this.end.position||(this.end.position="right"),this.begin.widget.y>this.end.widget.y+this.end.y?("bottom"===this.begin.position?(i.y=this.begin.widget.y+this.begin.widget.height,this.end.position="bottom",e.y=this.end.widget.y+this.end.widget.height-this.end.offsety):"right"===this.begin.position?(this.end.position="right",i.x=this.begin.widget.x+this.begin.widget.width,e.x=this.end.widget.x+this.end.widget.width):"left"===this.begin.position?(i.x=this.begin.widget.x,this.begin.widget.x-t<this.end.widget.x+this.end.widget.width?(this.end.position="bottom",e.y=this.end.widget.y+this.end.widget.height-this.end.offsety):this.begin.widget.y+this.begin.y<this.end.widget.y+this.end.widget.height-t&&(this.end.position="right",e.x=this.end.widget.x+this.end.widget.width)):(i.y=this.begin.widget.y,this.begin.widget.y<this.end.widget.y+this.end.widget.height-t?(this.end.position="right",e.x=this.end.widget.x+this.end.widget.width):this.begin.widget.x+this.begin.x<this.end.widget.x+this.end.widget.width+t&&(this.end.position="bottom",e.y=this.end.widget.y+this.end.widget.height-this.end.offsety)),"right"==this.end.position?e.x=this.end.widget.x+this.end.widget.width:"left"==this.end.position?(this.end.position="right",e.x=this.end.widget.x+this.end.widget.width):"bottom"==this.end.position?e.y=this.end.widget.y+this.end.widget.height+this.end.offsety:"top"==this.end.position&&(this.end.position="bottom",e.y=this.end.widget.y+this.end.widget.height-this.end.offsety)):this.begin.widget.y+this.begin.widget.height<this.end.widget.y+this.end.y?("top"===this.begin.position?(i.y=this.begin.widget.y,this.end.position="top",e.y=this.end.widget.y+this.end.offsety):"right"===this.begin.position?(this.end.position="right",i.x=this.begin.widget.x+this.begin.widget.width,e.x=this.end.widget.x+this.end.widget.width):"left"===this.begin.position?(i.x=this.begin.widget.x,this.begin.widget.x<this.end.widget.x+this.end.widget.width+t?(this.end.position="top",e.y=this.end.widget.y+this.end.offsety):this.begin.widget.y+this.begin.y>this.end.widget.y&&(this.end.position="right",e.x=this.end.widget.x+this.end.widget.width)):"bottom"!==this.end.position?(i.y=this.begin.widget.y+this.begin.widget.height,this.begin.widget.y+this.begin.widget.height>this.end.widget.y?(this.end.position="right",e.x=this.end.widget.x+this.end.widget.width):this.begin.widget.x+this.begin.x<this.end.widget.x+this.end.widget.width+t&&(this.end.position="top",e.y=this.end.widget.y+this.end.offsety)):(i.y=this.begin.widget.y+this.begin.widget.height,e.y=this.end.widget.y+this.end.widget.height+this.end.offsety),"right"===this.end.position?e.x=this.end.widget.x+this.end.widget.width:"left"===this.end.position?(this.end.position="right",e.x=this.end.widget.x+this.end.widget.width):"top"==this.end.position?e.y=this.end.widget.y+this.end.offsety:"bottom"==this.end.position&&(this.end.position="top",e.y=this.end.widget.y+this.end.offsety)):"top"===this.begin.position?(this.end.position="top",e.y=this.end.widget.y+this.end.offsety,i.y=this.begin.widget.y):"bottom"===this.begin.position?(this.end.position="bottom",e.y=this.end.widget.y+this.end.widget.height-this.end.offsety,i.y=this.begin.widget.y+this.begin.widget.height):(i.x=this.begin.widget.x,this.begin.position="left",e.x=this.end.widget.x+this.end.widget.width,this.end.position="right")):"left"===this.begin.position?(this.end.position="left",e.x=this.end.widget.x+this.end.offsetx,i.x=this.begin.widget.x):"right"===this.begin.position?(this.end.position="right",e.x=this.end.widget.x+this.end.widget.width,i.x=this.begin.widget.x+this.begin.widget.width):this.begin.widget.y+this.begin.widget.height<this.end.widget.y?(this.begin.position="bottom",i.y=this.begin.widget.y+this.begin.widget.height,this.end.position="top",e.y=this.end.widget.y+this.end.offsety):(i.y=this.begin.widget.y,this.begin.position="top",e.y=this.end.widget.y+this.end.widget.height+this.end.offsety,this.end.position="bottom");this.x=Math.min(i.x,e.x),this.y=Math.min(i.y,e.y),this.width=Math.abs(e.x-i.x),this.height=Math.abs(e.y-i.y);var s={x:i.x-this.x,y:i.y-this.y,cursor:"move",visible:!0},h={x:e.x-this.x,y:e.y-this.y,cursor:"move",visible:!0};if(this.begin.position==this.end.position&&"right"===this.begin.position&&(this.width=this.width+this.offsetX),this.begin.position==this.end.position&&"left"===this.begin.position&&(this.width=this.width+this.offsetX),this.begin.position==this.end.position&&"top"===this.begin.position&&(this.height=this.height+this.offsetY),this.begin.position==this.end.position&&"bottom"===this.begin.position&&(this.height=this.height+this.offsetY),this.sp=s,this.ep=h,s.x!==h.x&&s.y!==h.y||this.begin.position==this.end.position){if("top"===this.begin.position||"bottom"===this.begin.position)if("top"!==this.end.position&&"bottom"!==this.end.position||this.end.position==this.begin.position)if("top"===this.end.position&&this.end.position===this.begin.position){var n={x:s.x,y:Math.min(s.y,h.y)-Math.max(this.offsetY,30),visible:!0},o={x:h.x,y:Math.min(s.y,h.y)-Math.max(this.offsetY,30),visible:!0};this.resizers=[s,n,o,h]}else if("bottom"===this.end.position&&this.end.position===this.begin.position){var n={x:s.x,y:Math.max(this.height,30),visible:!0},o={x:h.x,y:Math.max(this.height,30),visible:!0};this.resizers=[s,n,o,h]}else{var n={x:s.x,y:h.y,visible:!0};this.resizers=[s,n,h]}else{var n={x:s.x,y:this.offsetY,visible:!0},o={x:h.x,y:this.offsetY,visible:!0};this.linefixed&&("bottom"==this.begin.position?(n={x:s.x,y:Math.max(this.height/3,30),visible:!0},o={x:h.x,y:this.height-Math.max(this.height/3,30),visible:!0}):(n={x:s.x,y:this.height-Math.max(this.height/3,30),visible:!0},o={x:h.x,y:Math.max(this.height/3,30),visible:!0})),this.resizers=[s,n,o,h]}else if("right"===this.begin.position||"left"===this.begin.position)if("right"!==this.end.position&&"left"!==this.end.position||this.end.position==this.begin.position)if("left"===this.end.position&&this.end.position===this.begin.position){var n={x:Math.min(s.x,h.x)-Math.max(this.offsetX,30),y:s.y,visible:!0},o={x:Math.min(s.x,h.x)-Math.max(this.offsetX,30),y:h.y,visible:!0};this.resizers=[s,n,o,h]}else if("right"===this.end.position&&this.end.position===this.begin.position){var n={x:Math.max(this.width,30),y:s.y,visible:!0},o={x:Math.max(this.width,30),y:h.y,visible:!0};this.resizers=[s,n,o,h]}else{var n={x:h.x,y:s.y,visible:!0};this.resizers=[s,n,h]}else{var n={x:this.offsetX,y:s.y,visible:!0},o={x:this.offsetX,y:h.y,visible:!0};this.linefixed&&("right"===this.begin.position?(n={x:Math.max(this.width/3,30),y:s.y,visible:!0},o={x:this.width-Math.max(this.width/3,30),y:h.y,visible:!0}):(o={x:Math.max(this.width/3,30),y:h.y,visible:!0},n={x:this.width-Math.max(this.width/3,30),y:s.y,visible:!0})),this.resizers=[s,n,o,h]}}else this.resizers=[s,h]},this.resize=function(t){var i=t.offset.x,e=t.offset.y;this.resizer=t.resizer-1,0==this.resizer?(this.begin.x+=i,this.begin.y+=e,this.begin.widget.x+this.begin.widget.width<this.end.widget.x+this.end.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y+this.end.y?(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.position="right",this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.position="bottom",this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2)):this.end.widget.y+this.end.y<this.begin.widget.y?(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.position="right",this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2),this.begin.y<0?(this.begin.position="top",this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2):this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin)):(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.position="right",this.begin.x=this.begin.widget.width/2,this.end.position="left",this.end.y=this.end.widget.height/2),this.begin.y<0?(this.begin.position="top",this.end.position="top",this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2,this.end.x=this.end.widget.width/2,this.end.y=this.end.widget.height/2):this.begin.y>this.begin.widget.height&&(this.begin.position="bottom",this.end.position="bottom",this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2,this.end.x=this.end.widget.width/2,this.end.y=this.end.widget.height/2)):this.end.widget.x+this.end.x<this.begin.widget.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y+this.end.y?(this.begin.x<0?(this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2,this.begin.position="left"):this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.position="bottom",this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2)):this.end.widget.y+this.end.y<this.begin.widget.y?(this.begin.x<0?(this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2,this.begin.position="left"):this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?(this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2,this.begin.position="top"):this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin)):(this.begin.x<0?(this.begin.position="left",this.begin.x=0,this.end.position="right",this.end.y=this.end.widget.height/2):this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width),this.begin.y<0?(this.begin.position="top",this.end.position="top",this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2,this.end.x=this.end.widget.width/2,this.end.y=this.end.widget.height/2):this.begin.y>this.begin.widget.height&&(this.begin.position="bottom",this.end.position="bottom",this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2,this.end.x=this.end.widget.width/2,this.end.y=this.end.widget.height/2)):this.begin.widget.y+this.begin.widget.height<this.end.widget.y?"bottom"!=this.begin.position?this.begin.y>this.begin.widget.height?(this.begin.y=this.begin.widget.height/2,this.begin.x=this.begin.widget.width/2,this.end.x=this.end.widget.width/2,this.begin.position="bottom",this.end.position="top"):this.begin.y<0&&(this.begin.y=this.begin.widget.margin):this.begin.x<0?(this.begin.x=0,this.begin.position="left",this.end.position="left",this.begin.y=this.begin.widget.height/2,this.end.y=this.end.widget.height/2):this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width/2,this.begin.position="right",this.end.position="right",this.begin.y=this.begin.widget.height/2,this.end.y=this.end.widget.height/2):this.end.widget.y+this.end.widget.height<this.begin.widget.y&&("top"!=this.begin.position?this.begin.y<0&&(this.begin.position="top",this.end.position="bottom",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2,this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2):this.begin.x<0?(this.begin.x=this.begin.widget.width/2,this.end.position="left",this.begin.position="left",this.begin.y=this.begin.widget.height/2,this.end.y=this.end.widget.height/2):this.begin.x>this.begin.widget.width?(this.begin.x=this.begin.widget.width/2,this.begin.position="right",this.end.position="right",this.begin.y=this.begin.widget.height/2,this.end.y=this.end.widget.height/2):this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin))):this.resizer==this.resizers.length-1?(this.end.x+=i,this.end.y+=e,this.begin.widget.x+this.begin.x<this.end.widget.x?this.begin.widget.y+this.begin.y<this.end.widget.y?(this.end.x<0?(this.end.position="left",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2):this.end.x>this.end.widget.width&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?(this.end.position="top",this.end.x=this.end.widget.width/2,this.end.y=this.end.widget.height/2):this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin)):this.end.widget.y+this.end.widget.height<this.begin.widget.y+this.begin.y?(this.end.x<0?(this.end.position="left",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2):this.end.x>this.end.widget.width&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.position="bottom",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2)):(this.end.x<0?(this.end.position="left",this.begin.position="right",this.begin.y=this.begin.widget.height/2):this.end.x>this.end.widget.width&&(this.end.x=this.end.widget.width),this.end.y<0?(this.begin.position="top",this.end.position="top",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2,this.begin.y=this.begin.widget.height/2,this.begin.x=this.begin.widget.width/2):this.end.y>this.end.widget.height&&(this.begin.position="bottom",this.end.position="bottom",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2,this.begin.y=this.begin.widget.height/2,this.begin.x=this.begin.widget.width/2)):this.end.widget.x+this.end.widget.width<this.begin.widget.x+this.begin.x?this.begin.widget.y+this.begin.y<this.end.widget.y?(this.end.x<0?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width&&(this.end.position="right",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2),this.end.y<0?(this.end.position="top",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2):this.end.y>this.end.widget.height&&(this.begin.position="bottom",this.end.position="bottom",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2,this.begin.y=this.begin.widget.height/2,this.begin.x=this.begin.widget.width/2)):this.begin.widget.y+this.begin.y>this.end.widget.y+this.end.widget.height?(this.end.x<0?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width&&(this.end.position="right",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height/2,this.end.position="bottom")):(this.end.x<0?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width&&(this.end.position="right",this.end.x=this.end.widget.width/2,this.begin.position="left",this.begin.y=this.begin.widget.height/2),this.end.y<0?(this.end.position="top",this.begin.position="top",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2,this.begin.y=this.begin.widget.height/2,this.begin.x=this.begin.widget.width/2):this.end.y>this.end.widget.height&&(this.begin.position="bottom",this.end.position="bottom",this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2,this.begin.y=this.begin.widget.height/2,this.begin.x=this.begin.widget.width/2)):(this.begin.widget.y+this.begin.widget.height<this.end.widget.y&&("top"!=this.end.position?this.end.y<0?(this.end.y=this.end.widget.height/2,this.end.x=this.end.widget.width/2,this.begin.x=this.begin.widget.width/2,this.begin.y=this.begin.widget.height/2,this.end.position="top",this.begin.position="bottom"):this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height):this.end.x<0?(this.begin.position="left",this.end.position="left",this.end.x=this.end.widget.width/2,this.end.y=this.end.widget.height/2,this.begin.y=this.begin.widget.height/2):this.end.x>this.end.widget.width&&(this.end.x=this.end.widget.width,this.end.y=this.end.widget.margin,this.begin.y=this.begin.widget.height/2,this.begin.position="right",this.end.position="right")),this.end.widget.y+this.end.widget.height<this.begin.widget.y&&("bottom"!=this.end.position?this.end.y>this.end.widget.height?(this.end.x=this.end.widget.width/2,this.end.y=this.end.widget.height/2,this.begin.y=this.begin.widget.height/2,this.begin.x=this.begin.widget.width/2,this.end.position="bottom",this.begin.position="top"):this.end.y<0&&(this.end.y=0):this.end.x<0?(this.begin.position="left",this.end.position="left",this.end.x=this.end.widget.width/2,this.end.y=this.end.widget.height/2,this.begin.y=this.begin.widget.height/2,this.begin.x=this.begin.widget.width/2):this.end.x>this.end.widget.width&&(this.begin.position="right",this.end.position="right",this.end.x=this.end.widget.width/2,this.end.y=this.end.widget.height/2,this.begin.y=this.begin.widget.height/2,this.begin.x=this.begin.widget.width/2)))):1==this.resizer?"top"===this.begin.position||"bottom"===this.begin.position?this.begin.position!=this.end.position?(this.begin.x+=i,this.offsetY+=e,this.begin.x<this.begin.widget.margin?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.offsetY<this.minOffset?this.offsetY=this.minOffset:this.offsetY>this.height-this.minOffset&&(this.offsetY=this.height-this.minOffset)):this.begin.position===this.end.position&&"top"===this.begin.position?(this.begin.x+=i,this.offsetY-=e,this.offsetY<this.minOffset&&(this.offsetY=this.minOffset),this.begin.x<this.begin.widget.margin?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width-this.begin.widget.margin&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin)):this.begin.position===this.end.position&&"bottom"===this.begin.position&&(this.begin.x+=i,this.offsetY+=e,this.offsetY<this.minOffset&&(this.offsetY=this.minOffset),this.begin.x<this.begin.widget.margin?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width-this.begin.widget.margin&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin)):"right"!==this.begin.position&&"left"!==this.begin.position||(this.begin.position!=this.end.position?(this.begin.y+=e,this.offsetX+=i,this.begin.y<this.begin.widget.margin?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height-this.begin.widget.margin&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin),this.offsetX<this.minOffset?this.offsetX=this.minOffset:this.offsetX>this.width-this.minOffset&&(this.offsetX=this.width-this.minOffset)):this.begin.position===this.end.position&&"right"===this.begin.position?(this.offsetX+=i,this.begin.y+=e,this.offsetX<this.minOffset&&(this.offsetX=this.minOffset),this.begin.y<this.begin.widget.margin?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height-this.begin.widget.margin&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin)):this.begin.position===this.end.position&&"left"===this.begin.position&&(this.offsetX-=i,this.begin.y+=e,this.offsetX<this.minOffset&&(this.offsetX=this.minOffset),this.begin.y<this.begin.widget.margin?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height-this.begin.widget.margin&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin))):2==this.resizer&&("top"===this.end.position||"bottom"===this.end.position?this.begin.position!=this.end.position?(this.end.x+=i,this.offsetY+=e,this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.offsetY<this.minOffset?this.offsetY=this.minOffset:this.offsetY>this.height-this.minOffset&&(this.offsetY=this.height-this.minOffset)):this.begin.position===this.end.position&&"top"===this.begin.position?(this.end.x+=i,this.offsetY-=e,this.offsetY<this.minOffset&&(this.offsetY=this.minOffset),this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin)):this.begin.position===this.end.position&&"bottom"===this.begin.position&&(this.end.x+=i,this.offsetY+=e,this.offsetY<this.minOffset&&(this.offsetY=this.minOffset),this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin)):"right"!==this.end.position&&"left"!==this.end.position||(this.begin.position!=this.end.position?(this.end.y+=e,this.offsetX+=i,this.end.y<this.end.widget.margin?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height-this.end.widget.margin&&(this.end.y=this.end.widget.height-this.end.widget.margin),this.offsetX<this.minOffset?this.offsetX=this.minOffset:this.offsetX>this.width-this.minOffset&&(this.offsetX=this.width-this.minOffset)):this.begin.position===this.end.position&&"right"===this.begin.position?(this.offsetX+=i,this.end.y+=e,this.offsetX<this.minOffset&&(this.offsetX=this.minOffset),this.end.y<this.end.widget.margin?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height-this.end.widget.margin&&(this.end.y=this.end.widget.height-this.end.widget.margin)):this.begin.position===this.end.position&&"left"===this.begin.position&&(this.offsetX-=i,this.end.y+=e,this.offsetX<this.minOffset&&(this.offsetX=this.minOffset),this.end.y<this.end.widget.margin?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height-this.end.widget.margin&&(this.end.y=this.end.widget.height-this.end.widget.margin))))},this.paintTo=function(t){var i=t.getContext("2d");i.save(),i.scale(this.scaleX,this.scaleY),i.globalAlpha=this.alpha,this.setResizers(),i.translate(this.x,this.y),i.globalCompositeOperation="source-over",i.rotate(this.rotate/180*Math.PI),i.lineJoin="round",i.lineCap="round",this.beforePaint&&this.beforePaint(i),this.begin.widget.focus||this.end.widget.focus?this.drawImageTo(i,!0):this.drawImageTo(i),this.focus&&this.editable&&!this.autosize&&this.drawResizerTo(i),i.restore()},this.drawImageTo=function(i,e){e=e||!1,i.save(),i.beginPath();"bottom"===this.begin.position?this.resizers[0].y=this.resizers[0].y+this.border.width/2:"top"===this.begin.position?this.resizers[0].y=this.resizers[0].y-this.border.width/2:"left"===this.begin.position?this.resizers[0].x=this.resizers[0].x-this.border.width/2:"right"===this.begin.position&&(this.resizers[0].x=this.resizers[0].x+this.border.width/2);var s=this.resizers.length-1;if("bottom"===this.end.position?this.resizers[s].y=this.resizers[s].y+this.border.width/2:"top"===this.end.position?this.resizers[s].y=this.resizers[s].y-this.border.width/2:"left"===this.end.position?this.resizers[s].x=this.resizers[s].x-this.border.width/2:"right"===this.end.position&&(this.resizers[s].x=this.resizers[s].x+this.border.width/2),e)if(i.strokeStyle=this.dashColor,i.fillStyle=this.dashColor,i.lineWidth=this.border.width,i.lineCap=this.linecap,this.editable)i.lineWidth=this.border.width+1;else{var h=[this.border.width+4,this.border.width+7];i.setLineDash(h),i.lineDashOffset=-this.dashOffset}else if(i.strokeStyle=this.border.color,i.fillStyle=this.border.color,i.lineWidth=this.border.width,i.lineCap=this.linecap,"solid"!=this.border.type){var h="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];i.setLineDash(h)}i.moveTo(parseInt(this.resizers[0].x)+.5,parseInt(this.resizers[0].y)+.5);for(var n=1;n<this.resizers.length;n++)i.lineTo(parseInt(this.resizers[n].x)+.5,parseInt(this.resizers[n].y)+.5);return i.stroke(),"arrow"===this.begin.shape.name?t.drawArrow(i,this.resizers[1],this.resizers[0],this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"diamond"===this.begin.shape.name?t.drawDiamond(i,this.resizers[1],this.resizers[0],this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"dot"===this.begin.shape.name&&(i.beginPath(),i.arc(this.resizers[0].x,this.resizers[0].y,this.begin.shape.radius,0,2*Math.PI),i.stroke(),2===this.begin.shape.type?i.fill():3===this.begin.shape.type&&(i.fillStyle="white",i.fill(),i.fillStyle=this.border.color)),"arrow"===this.end.shape.name?2===this.resizers.length?t.drawArrow(i,this.resizers[0],this.resizers[1],this.end.shape.type,{size:this.end.shape.size,shape:this.end.shape.sharp}):3===this.resizers.length?t.drawArrow(i,this.resizers[1],this.resizers[2],this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):4===this.resizers.length&&t.drawArrow(i,this.resizers[2],this.resizers[3],this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):"diamond"===this.end.shape.name?2===this.resizers.length?t.drawDiamond(i,this.resizers[0],this.resizers[1],this.end.shape.type,{size:this.end.shape.size,shape:this.end.shape.sharp}):3===this.resizers.length?t.drawDiamond(i,this.resizers[1],this.resizers[2],this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):4===this.resizers.length&&t.drawDiamond(i,this.resizers[2],this.resizers[3],this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):"dot"===this.end.shape.name&&(i.beginPath(),i.arc(this.ep.x,this.ep.y,this.end.shape.radius,0,2*Math.PI),i.stroke(),2===this.end.shape.type?i.fill():3===this.end.shape.type&&(i.fillStyle="white",i.fill())),i.restore(),this},this},lineConnector=function(i){var e={name:"lineConnector",width:150,height:30,text:"lineConnector",linecap:"square"};return t.extend(e,i),t.extend(this,new _connector(e)),this.propertyEditors=["common","border","arrow"],this.begin=new endpoint(i.begin),this.end=new endpoint(i.end),this.type="lineConnector",this.checkPointIn=function(t,i,e){null!=this.root&&(e=e||this.root.scale),e||(e=1);var s=this.relativePoint(t,i,e),h=s.x,n=s.y;return math.isPointOnLine(h,n,this.sp.x*e,this.sp.y*e,this.ep.x*e,this.ep.y*e)},this.setResizers=function(){var t={x:this.begin.x+this.begin.widget.x,y:this.begin.y+this.begin.widget.y},i={x:this.end.x+this.end.widget.x,y:this.end.y+this.end.widget.y};"top"==this.begin.position?t.y=this.begin.widget.y:"bottom"==this.begin.position?t.y=this.begin.widget.y+this.begin.widget.height:"left"==this.begin.position?t.x=this.begin.widget.x:"right"==this.begin.position&&(t.x=this.begin.widget.x+this.begin.widget.width),this.begin.widget.x+this.begin.widget.width<this.end.widget.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y?"top"!=this.end.position?(i.x=this.end.widget.x+this.end.offsetx,this.end.position="left"):i.y=this.end.widget.y+this.end.offsety:this.end.widget.y+this.end.widget.height<this.begin.widget.y?"left"!=this.end.position?(i.y=this.end.widget.y+this.end.widget.height-this.end.offsety,this.end.position="bottom"):i.x=this.end.widget.x+this.end.offsetx:(t.x=this.begin.widget.x+this.begin.widget.width,i.x=this.end.widget.x+this.end.offsetx,this.end.position="left"):this.end.widget.x+this.end.widget.width<this.begin.widget.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y?"top"!=this.end.position?(i.x=this.end.widget.x+this.end.widget.width,this.end.position="right"):i.y=this.end.widget.y+this.end.offsety:this.end.widget.y+this.end.widget.height<this.begin.widget.y&&("right"!=this.end.position?(i.y=this.end.widget.y+this.end.widget.height-this.end.offsety,this.end.position="bottom"):i.x=this.end.widget.x+this.end.widget.width):this.begin.widget.y+this.begin.widget.height<this.end.widget.y?(i.y=this.end.widget.y+this.end.offsety,this.end.position="top"):(i.y=this.end.widget.y+this.end.widget.height+this.end.offsety,this.end.position="bottom");var e={x:t.x-this.x,
y:t.y-this.y,cursor:"move",visible:!0},s={x:i.x-this.x,y:i.y-this.y,cursor:"move",visible:!0};this.x=Math.min(t.x,i.x),this.y=Math.min(t.y,i.y),this.width=Math.abs(i.x-t.x),this.height=Math.abs(i.y-t.y),this.sp=e,this.ep=s,this.resizers=[e,s]},this.resize=function(t){var i=t.offset.x,e=t.offset.y;this.resizer=t.resizer-1,0==this.resizer?(this.begin.x+=i,this.begin.y+=e,this.begin.widget.x+this.begin.widget.width<this.end.widget.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y?(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.position="right",this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.position="bottom",this.begin.y=this.begin.widget.height-this.begin.widget.margin)):this.end.widget.y+this.end.widget.height<this.begin.widget.y?(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.position="right",this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?(this.begin.position="top",this.begin.y=this.begin.widget.margin):this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin)):(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin)):this.end.widget.x+this.end.widget.width<this.begin.widget.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y?(this.begin.x<0?(this.begin.x=this.begin.widget.margin,this.begin.position="left"):this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.position="bottom",this.begin.y=this.begin.widget.height-this.begin.widget.margin)):this.end.widget.y+this.end.widget.height<this.begin.widget.y?(this.begin.x<0?(this.begin.x=this.begin.widget.margin,this.begin.position="left"):this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?(this.begin.y=this.begin.widget.margin,this.begin.position="top"):this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin)):(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin)):(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin))):this.resizer==this.resizers.length-1&&(this.end.x+=i,this.end.y+=e,this.begin.widget.x+this.begin.widget.width<this.end.widget.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y?(this.end.x<this.end.widget.margin?(this.end.x=this.end.widget.margin,this.end.position="left"):this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?(this.end.y=this.end.widget.margin,this.end.position="top"):this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin)):this.end.widget.y+this.end.widget.height<this.begin.widget.y?(this.end.x<this.end.widget.margin?(this.end.x=this.end.widget.margin,this.end.position="left"):this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin,this.end.position="bottom")):(this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin)):this.end.widget.x+this.end.widget.width<this.begin.widget.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y?(this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin,this.end.position="right"),this.end.y<0?(this.end.y=this.end.widget.margin,this.end.position="top"):this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin)):this.end.widget.y+this.end.widget.height<this.begin.widget.y?(this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin,this.end.position="right"),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin,this.end.position="bottom")):(this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin)):(this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin)))},this.paintTo=function(t){var i=t.getContext("2d");i.save(),i.scale(this.scaleX,this.scaleY),i.globalAlpha=this.alpha,i.translate(this.x,this.y),i.rotate(this.rotate/180*Math.PI),this.setResizers(),this.drawImageTo(i),(this.begin.widget.focus||this.end.widget.focus)&&this.drawImageTo(i,!0),this.focus&&this.editable&&!this.autosize&&this.drawResizerTo(i),i.restore()},this.drawImageTo=function(i,e){var s=this.sp,h=this.ep;i.save();if(i.beginPath(),e){i.strokeStyle=this.dashColor,i.fillStyle=this.dashColor,i.lineWidth=this.border.width+1,i.lineCap=this.linecap;var n=[this.border.width+4,this.border.width+7];i.setLineDash(n),i.lineDashOffset=-this.dashOffset}else if(i.strokeStyle=this.border.color,i.fillStyle=this.border.color,i.lineWidth=this.border.width,i.lineCap=this.linecap,"solid"!=this.border.type){var n="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];i.setLineDash(n)}i.moveTo(this.resizers[0].x+.5,this.resizers[0].y+.5);for(var o=1;o<this.resizers.length;o++)i.lineTo(this.resizers[o].x+.5,this.resizers[o].y+.5);return i.lineTo(h.x+.5,h.y+.5),i.stroke(),"arrow"===this.begin.shape.name?t.drawArrow(i,h,s,this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"diamond"===this.begin.shape.name?t.drawDiamond(i,h,s,this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"dot"===this.begin.shape.name&&(i.beginPath(),i.arc(s.x,s.y,this.begin.shape.radius,0,2*Math.PI),i.stroke(),2===this.begin.shape.type?i.fill():3===this.begin.shape.type&&(i.fillStyle="white",i.fill(),i.fillStyle=this.border.color)),"arrow"===this.end.shape.name?t.drawArrow(i,s,h,this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):"diamond"===this.end.shape.name?t.drawDiamond(i,s,h,this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):"dot"===this.end.shape.name&&(i.beginPath(),i.arc(h.x,h.y,this.end.shape.radius,0,2*Math.PI),i.stroke(),2===this.end.shape.type?i.fill():3===this.end.shape.type&&(i.fillStyle="white",i.fill())),i.restore(),this},this},quadraticCurveConnector=function(i){var e={name:"quadraticCurveConnector",width:150,height:30,text:"quadraticCurveConnector"};t.extend(e,i),t.extend(this,new _connector(e)),this.propertyEditors=["common","border","arrow"],this.begin=new endpoint(i.begin),this.end=new endpoint(i.end),this.offsetX=0,this.offsetY=0;var s=this.offsetX,h=this.offsetY;return this.type="quadraticCurveConnector",this.persist=function(){var t=widget.persistproperty(this);return t.offsetX=this.offsetX,t.offsetY=this.offsetY,t.linecap=this.linecap,t.minOffset=this.minOffset,t.begin=this.begin.persist(),t.end=this.end.persist(),t.begin.position=this.begin.position,t.end.position=this.end.position,t},this.checkPointIn=function(t,i,e){null!=this.root&&(e=e||this.root.scale),e||(e=1);for(var s=this.relativePoint(t,i,e),h=s.x,n=s.y,o=0;o<this.resizers.length-1;o++)if(1==math.isPointOnLine(h,n,this.resizers[o].x*e,this.resizers[o].y*e,this.resizers[o+1].x*e,this.resizers[o+1].y*e))return!0;return!1},this.setResizers=function(){var t={x:this.begin.x+this.begin.widget.x,y:this.begin.y+this.begin.widget.y},i={x:this.end.x+this.end.widget.x,y:this.end.y+this.end.widget.y};if("top"==this.begin.position?t.y=this.begin.widget.y:"bottom"==this.begin.position?t.y=this.begin.widget.y+this.begin.widget.height:"left"==this.begin.position?t.x=this.begin.widget.x:"right"==this.begin.position&&(t.x=this.begin.widget.x+this.begin.widget.width),this.begin.widget.x+this.begin.widget.width<this.end.widget.x){var e=(this.end.widget.x-this.begin.widget.x+this.begin.widget.width)/2;if(this.begin.widget.y+this.begin.widget.height<this.end.widget.y){var n=(this.end.widget.y-this.begin.widget.y+this.begin.widget.height)/2;"right"==this.begin.position?(s=this.begin.widget.x+this.offsetX-this.x+e,h=this.begin.widget.y-this.y+this.begin.widget.height/2+this.offsetY,"left"!=this.end.position?(i.y=this.end.widget.y+this.end.offsety,this.end.position="top"):i.x=this.end.widget.x+this.end.offsetx):"bottom"==this.begin.position?(s=this.begin.widget.x+this.offsetX+this.begin.widget.width/2-this.x,h=this.begin.widget.y-this.y+n+this.offsetY,"top"!=this.end.position?(i.x=this.end.widget.x+this.end.offsetx,this.end.position="left"):i.y=this.end.widget.y+this.end.offsety):"top"==this.begin.position?(s=this.begin.widget.x+this.offsetX+e-this.x,h=this.begin.widget.y-this.y-n+this.offsetY,"left"!=this.end.position?(i.y=this.end.widget.y+this.end.offsety,this.end.position="top"):i.x=this.end.widget.x+this.end.offsetx):"left"==this.begin.position&&(s=this.begin.widget.x+this.offsetX-e-this.x,h=this.begin.widget.y+n+this.offsetY-this.y,"top"!=this.end.position?(i.x=this.end.widget.x+this.end.offsetx,this.end.position="left"):i.y=this.end.widget.y+this.end.offsety)}else if(this.end.widget.y+this.end.widget.height<this.begin.widget.y){var n=(this.begin.widget.y-this.end.widget.y-this.end.widget.height)/2;"right"==this.begin.position?(s=this.begin.widget.x+this.offsetX-this.x+e,h=this.begin.widget.y-this.y+this.begin.widget.height/2+this.offsetY,"left"!=this.end.position?(i.y=this.end.widget.y+this.end.widget.height+this.end.offsety,this.end.position="bottom"):i.x=this.end.widget.x+this.end.offsetx):"top"==this.begin.position?(s=this.begin.widget.x+this.offsetX-this.x+this.begin.widget.width/2,h=this.begin.widget.y-this.y+this.offsetY-n,"bottom"!=this.end.position?(i.x=this.end.widget.x+this.end.offsetx,this.end.position="left"):i.y=this.end.widget.y+this.end.widget.height+this.end.offsety):"left"==this.begin.position?(s=this.begin.widget.x-e+this.offsetX-this.x,h=this.begin.widget.y-n+this.offsetY-this.y,"bottom"!=this.end.position?(i.x=this.end.widget.x+this.end.offsetx,this.end.position="left"):i.y=this.end.widget.y+this.end.widget.height+this.end.offsety):"bottom"==this.begin.position&&(s=this.begin.widget.x+e+this.offsetX-this.x,h=this.begin.widget.y+this.begin.widget.height+n+this.offsetY-this.y,"left"!=this.end.position?(i.y=this.end.widget.y+this.end.widget.height+this.end.offsety,this.end.position="bottom"):i.x=this.end.widget.x+this.end.offsetx)}else s=this.begin.widget.x-this.x+e+this.offsetX,"right"==this.begin.position?(t.x=this.begin.widget.x+this.begin.widget.width,i.x=this.end.widget.x+this.end.offsetx,this.end.position="left",h=this.begin.widget.y-this.y-e/4+this.offsetY):(this.end.position=this.begin.position,"top"==this.begin.position?(h=this.begin.widget.y-this.y-e/4+this.offsetY,i.y=this.end.widget.y+this.end.offsety):"bottom"==this.begin.position&&(i.y=this.end.widget.y+this.end.widget.height+this.end.offsety,h=this.begin.widget.y+this.begin.widget.height-this.y+e/4+this.offsetY))}else if(this.end.widget.x+this.end.widget.width<this.begin.widget.x){var e=(this.begin.widget.x-this.end.widget.x+this.end.widget.width)/2;if(this.begin.widget.y+this.begin.widget.height<this.end.widget.y){var n=(this.end.widget.y-this.begin.widget.y+this.begin.widget.height)/2;"bottom"==this.begin.position?(s=this.begin.widget.x+this.begin.widget.width/2+this.offsetX-this.x,h=this.begin.widget.y+n+this.offsetY-this.y,"top"!=this.end.position?(i.x=this.end.widget.x+this.end.widget.width,this.end.position="right"):i.y=this.end.widget.y+this.end.offsety):"left"==this.begin.position?(s=this.begin.widget.x-e+this.offsetX-this.x,h=this.begin.widget.y+this.begin.widget.height/2+this.offsetY-this.y,"right"!=this.end.position?(i.y=this.end.widget.y+this.end.offsety,this.end.position="top"):i.x=this.end.widget.x+this.end.widget.width):"top"==this.begin.position?(s=this.begin.widget.x-e+this.offsetX-this.x,h=this.begin.widget.y-n+this.offsetY-this.y,"right"!=this.end.position?(i.y=this.end.widget.y+this.end.offsety,this.end.position="top"):i.x=this.end.widget.x+this.end.widget.width):"right"==this.begin.position&&(s=this.begin.widget.x+e+this.offsetX-this.x,h=this.begin.widget.y+n+this.offsetY-this.y,"top"!=this.end.position?(i.x=this.end.widget.x+this.end.widget.width,this.end.position="right"):i.y=this.end.widget.y+this.end.offsety)}else if(this.end.widget.y+this.end.widget.height<this.begin.widget.y){var n=(this.begin.widget.y-this.end.widget.y+this.end.widget.height)/2;"top"==this.begin.position?(s=this.begin.widget.x+this.begin.widget.width/2+this.offsetX-this.x,h=this.end.widget.y+n+this.offsetY-this.y,"bottom"!=this.end.position?(i.x=this.end.widget.x+this.end.widget.width,this.end.position="right"):i.y=this.end.widget.y+this.end.widget.height+this.end.offsety):"left"==this.begin.position?(s=this.begin.widget.x-e+this.offsetX-this.x,h=this.begin.widget.y+this.offsetY-this.y,"right"!=this.end.position?(i.y=this.end.widget.y+this.end.widget.height+this.end.offsety,this.end.position="bottom"):i.x=this.end.widget.x+this.end.widget.width):"bottom"==this.begin.position?(s=this.begin.widget.x-e+this.offsetX-this.x,h=this.begin.widget.y+n+this.offsetY-this.y,"right"!=this.end.position?(i.y=this.end.widget.y+this.end.widget.height+this.end.offsety,this.end.position="bottom"):i.x=this.end.widget.x+this.end.widget.width):"right"==this.begin.position&&(s=this.begin.widget.x+this.begin.widget.width+e+this.offsetX-this.x,h=this.begin.widget.y-n+this.offsetY-this.y,"bottom"!=this.end.position?(i.x=this.end.widget.x+this.end.widget.width,this.end.position="right"):i.y=this.end.widget.y+this.end.widget.height+this.end.offsety)}else s=this.begin.widget.x-(this.begin.widget.x-this.end.widget.x+this.end.widget.width)/2+this.offsetY-this.y,"left"==this.begin.position?(i.x=this.end.widget.x+this.end.widget.width,this.end.position="right",h=this.end.widget.y+this.offsetY-this.y):(this.end.position=this.begin.position,"top"==this.end.position?(i.y=this.end.widget.y+this.end.offsety,h=this.end.widget.y-this.end.widget.height+this.offsetY-this.y):(i.y=this.end.widget.y+this.end.widget.height+this.end.offsety,h=this.end.widget.y+2*this.end.widget.height+this.offsetY-this.y))}else if(this.begin.widget.y+this.begin.widget.height<this.end.widget.y){var n=(this.end.widget.y-this.begin.widget.y+this.begin.widget.height)/2;"bottom"==this.begin.position?(this.end.position="top",i.y=this.end.widget.y+this.end.offsety,s=this.begin.widget.x+this.offsetX-this.x,h=this.end.widget.y-n+this.offsetY-this.y):(this.end.position=this.begin.position,"left"==this.begin.position?(i.x=this.end.widget.x+this.end.offsetx,s=this.begin.widget.x-n/3+this.offsetX-this.x,h=this.end.widget.y-n+this.offsetY-this.y):"right"==this.begin.position&&(i.x=this.end.widget.x+this.end.widget.width,s=this.begin.widget.x+this.begin.widget.width+n/3+this.offsetX-this.x,h=this.end.widget.y-n+this.offsetY-this.y))}else{var n=(this.begin.widget.y-this.end.widget.y+this.end.widget.height)/2;"top"==this.begin.position?(this.end.position="bottom",i.y=this.end.widget.y+this.end.widget.height+this.end.offsety,s=this.begin.widget.x+this.offsetX-this.x,h=this.end.widget.y+n+this.offsetY-this.y):(this.end.position=this.begin.position,"left"==this.end.position?(i.x=this.end.widget.x+this.end.offsetx,s=this.begin.widget.x-n/3+this.offsetX-this.x,h=this.begin.widget.y-this.y-n+this.offsetY):"right"==this.end.position&&(i.x=this.end.widget.x+this.end.widget.width,s=this.begin.widget.x+this.begin.widget.width+n/3+this.offsetX-this.x,h=this.begin.widget.y-n+this.offsetY-this.y))}var o={x:t.x-this.x,y:t.y-this.y,cursor:"move",visible:!0},r={x:i.x-this.x,y:i.y-this.y,cursor:"move",visible:!0};this.x=Math.min(t.x,i.x),this.y=Math.min(t.y,i.y),this.width=Math.abs(i.x-t.x),this.height=Math.abs(i.y-t.y),this.sp=o,this.ep=r;var d={x:s,y:h,visible:!0};this.resizers=[o,d,r]},this.resize=function(t){var i=t.offset.x,e=t.offset.y;this.resizer=t.resizer-1,0==this.resizer?(this.begin.x+=i,this.begin.y+=e,this.begin.widget.x+this.begin.widget.width<this.end.widget.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y?(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.position="right",this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.position="bottom",this.begin.y=this.begin.widget.height-this.begin.widget.margin)):this.end.widget.y+this.end.widget.height<this.begin.widget.y?(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.position="right",this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?(this.begin.position="top",this.begin.y=this.begin.widget.margin):this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin)):(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin)):this.end.widget.x+this.end.widget.width<this.begin.widget.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y?(this.begin.x<0?(this.begin.x=this.begin.widget.margin,this.begin.position="left"):this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.position="bottom",this.begin.y=this.begin.widget.height-this.begin.widget.margin)):this.end.widget.y+this.end.widget.height<this.begin.widget.y?(this.begin.x<0?(this.begin.x=this.begin.widget.margin,this.begin.position="left"):this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?(this.begin.y=this.begin.widget.margin,this.begin.position="top"):this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin)):(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin)):(this.begin.x<0?this.begin.x=this.begin.widget.margin:this.begin.x>this.begin.widget.width&&(this.begin.x=this.begin.widget.width-this.begin.widget.margin),this.begin.y<0?this.begin.y=this.begin.widget.margin:this.begin.y>this.begin.widget.height&&(this.begin.y=this.begin.widget.height-this.begin.widget.margin))):this.resizer==this.resizers.length-1?(this.end.x+=i,this.end.y+=e,this.begin.widget.x+this.begin.widget.width<this.end.widget.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y?(this.end.x<this.end.widget.margin?(this.end.x=this.end.widget.margin,this.end.position="left"):this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?(this.end.y=this.end.widget.margin,this.end.position="top"):this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin)):this.end.widget.y+this.end.widget.height<this.begin.widget.y?(this.end.x<this.end.widget.margin?(this.end.x=this.end.widget.margin,this.end.position="left"):this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin,this.end.position="bottom")):(this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin)):this.end.widget.x+this.end.widget.width<this.begin.widget.x?this.begin.widget.y+this.begin.widget.height<this.end.widget.y?(this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin,this.end.position="right"),this.end.y<0?(this.end.y=this.end.widget.margin,this.end.position="top"):this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin)):this.end.widget.y+this.end.widget.height<this.begin.widget.y?(this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin,this.end.position="right"),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin,this.end.position="bottom")):(this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin)):(this.end.x<this.end.widget.margin?this.end.x=this.end.widget.margin:this.end.x>this.end.widget.width-this.end.widget.margin&&(this.end.x=this.end.widget.width-this.end.widget.margin),this.end.y<0?this.end.y=this.end.widget.margin:this.end.y>this.end.widget.height&&(this.end.y=this.end.widget.height-this.end.widget.margin))):1==this.resizer&&(this.offsetX+=i,this.offsetY+=e)},this.paintTo=function(t){var i=t.getContext("2d");i.save(),i.scale(this.scaleX,this.scaleY),i.globalAlpha=this.alpha,i.translate(this.x,this.y),i.rotate(this.rotate/180*Math.PI),this.setResizers(),this.drawImageTo(i),(this.begin.widget.focus||this.end.widget.focus)&&this.drawImageTo(i,!0),this.focus&&this.editable&&!this.autosize&&this.drawResizerTo(i),i.restore()},this.drawImageTo=function(i,e){var s=this.sp,h=this.ep;i.save();if(i.beginPath(),e){i.strokeStyle=this.dashColor,i.fillStyle=this.dashColor,i.lineWidth=this.border.width+1,i.lineCap=this.linecap;var n=[this.border.width+4,this.border.width+7];i.setLineDash(n),i.lineDashOffset=-this.dashOffset}else if(i.strokeStyle=this.border.color,i.lineWidth=this.border.width,i.fillStyle=this.border.color,i.lineCap=this.linecap,"solid"!=this.border.type){var n="dashed"===this.border.type?[this.border.width+5,this.border.width+2]:[this.border.width+2,this.border.width+2];i.setLineDash(n)}return i.moveTo(this.resizers[0].x+.5,this.resizers[0].y+.5),2===this.resizers.length?i.lineTo(h.x+.5+.5,h.y+.5+.5):i.quadraticCurveTo(this.resizers[1].x+.5,this.resizers[1].y+.5,this.resizers[2].x+.5,this.resizers[2].y+.5),i.stroke(),"arrow"===this.begin.shape.name?t.drawArrow(i,this.resizers[1],this.resizers[0],this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"diamond"===this.begin.shape.name?t.drawDiamond(i,this.resizers[1],this.resizers[0],this.begin.shape.type,{size:this.begin.shape.size,sharp:this.begin.shape.sharp}):"dot"===this.begin.shape.name&&(i.beginPath(),i.arc(s.x,s.y,this.begin.shape.radius,0,2*Math.PI),i.stroke(),2===this.begin.shape.type?i.fill():3===this.begin.shape.type&&(i.fillStyle="white",i.fill(),i.fillStyle=this.border.color)),"arrow"===this.end.shape.name?t.drawArrow(i,this.resizers[1],this.resizers[2],this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):"diamond"===this.end.shape.name?t.drawDiamond(i,this.resizers[1],this.resizers[2],this.end.shape.type,{size:this.end.shape.size,sharp:this.end.shape.sharp}):"dot"===this.end.shape.name&&(i.beginPath(),i.arc(h.x,h.y,this.end.shape.radius,0,2*Math.PI),i.stroke(),2===this.end.shape.type?i.fill():3===this.end.shape.type&&(i.fillStyle="white",i.fill())),i.restore(),this},this},t.register("lineConnector",lineConnector),t.register("brokenLineConnector",brokenLineConnector),t.register("quadraticCurveConnector",quadraticCurveConnector)}(jQuery),function(t){field=function(i){var e={border:null,corner:null,background:null,font:{style:"normal",weight:"normal",family:"Arial",size:"12px",color:"none",fill:!0},data:{name:"",text:"",abbreviation:"",datatype:"varchar",precision:0,ispk:!1,isfk:!1,reftable:"",refield:"",nullable:!0,unique:!1,annotation:"",defaultvalue:"",length:255,integer:19,decimal:0},hyperlink:null,shadow:null,width:140,height:44,text:""};t.extend(e,i),t.extend(this,new widget(e)),this.propertyEditors=[],this.allowconnectionPoint=!1,this.type="field",""===this.text&&(this.text=this.name),this.autosize=!1,this.editable=!1,this.persist=function(){var i=widget.persistproperty(this);return i.data={},delete i.font,t.extend(i.data,this.data),i},this.drawBorderTo=function(t){this.x=0,this.parent.focus||(this.focus=!1)},this.click=function(i){var e=this.parent.presenters[0].textbox;this.parent.focuswidget&&this.parent.focuswidget!=this&&(this.parent.focuswidget.focus=!1),this.parent.focuswidget=this,this.parent.presenters[0].focuswidget&&this.parent.presenters[0].focuswidget!=this.parent&&(this.parent.presenters[0].focuswidget.focus=!1),this.parent.Widget(this).focus=!0,this.parent.presenters[0].focuswidget=this,t(e).hide(),this.parent.paint(),this.parent.fieldclickEvent&&this.parent.fieldclickEvent.call(this,i),i.cancel=!0},this.prev=function(t){var i=this.parent.fields;this.data.ispk&&(i=this.parent.pk);for(var e=0;e<=i.length-1;e++)i[e]===this&&e>0&&(i[e].focus=!1,i[e-1].focus=!0,this.parent.focuswidget=i[e-1],this.parent.paint(),this.parent.fieldclickEvent&&this.parent.fieldclickEvent.call(this,t),t.cancel=!0)},this.next=function(t){var i=this.parent.fields;this.data.ispk&&(i=this.parent.pk);for(var e=0;e<=i.length-1;e++)i[e]===this&&e<i.length&&(i[e].focus=!1,i[e+1].focus=!0,this.parent.focuswidget=i[e+1],this.parent.paint(),this.parent.fieldclickEvent&&this.parent.fieldclickEvent.call(this,t),t.cancel=!0)},this.goup=function(){var i=this.parent.fields;this.data.ispk&&(i=this.parent.pk);for(var e=0;e<=i.length-1;e++)if(i[e]===this&&e>0){var s=i[e-1];return i[e-1]=this,i[e]=s,this.parent.widgets.splice(0,this.parent.widgets.length),t(this.parent.pk).each(function(t,i){this.parent.widgets.push(i)}),t(this.parent.fields).each(function(t,i){this.parent.widgets.push(i)}),void this.parent.paint()}},this.godown=function(){var i=this.parent.fields;this.data.ispk&&(i=this.parent.pk);for(var e=0;e<=i.length-1;e++)if(i[e]===this&&e<i.length-1){var s=i[e+1];return i[e+1]=this,i[e]=s,this.parent.widgets.splice(0,this.parent.widgets.length),t(this.parent.pk).each(function(t,i){this.parent.widgets.push(i)}),t(this.parent.fields).each(function(t,i){this.parent.widgets.push(i)}),void this.parent.paint()}},this.beforePaint=function(t){this.data.name=this.name,this.data.text=this.text},this.drawTextTo=function(t){var i=this.data.name+":"+this.data.datatype;"logical"===this.parent.showtype&&(i=this.data.text+":"+this.data.datatype);var e=[];this.data.ispk&&e.push("PK"),this.data.isfk&&e.push("FK"),e.length>0&&(i=i+"("+e.join(",")+")");var s=this.margin,h=this.autosize||!1;t.save();var n=this.font;return"none"===this.font.color&&(n=this.parent.font),this.focus?(t.fillStyle="#cae2ff",t.fillRect(0,0,this.width,this.height),t.fillStyle=n.color||"black",t.strokeStyle=n.color||"black"):this.data.ispk?(t.fillStyle="blue",t.strokeStyle="blue"):(t.fillStyle=n.color||"black",t.strokeStyle=n.color||"black"),null!=n&&i&&(t.font="String"==typeof n?n:n.style+" "+n.weight+" "+n.size+" "+n.family,metrics=t.measureText(i),this.minwidth=metrics.width+2*this.margin,h||(this.parent&&(this.width=this.parent.width),this.height=Math.round(this.fontSize()+2*s)),n.fill=null==n.fill||n.fill,n.fill?t.fillText(i,s,this.parent.fontSize()+s):t.strokeText(i,s,this.parent.fontSize()+s)),t.restore(),this}},table=function(i){var s={border:{width:1,type:"solid",color:"black"},corner:null,background:{filltype:"image",color:"white",image:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAABQ0lEQVRYR2PU2ff/P8MgBoyjDqQwdkZDkMIAZBgNQYpDsGvecpRi5i2HUN4zDtFLlBpMjn6pH6/1hH+8m4Ssl3HmzJno5aBtenr6EXIsoFTPzJkzbRgYGA6POpDckKQoBOfMmaPy9+/fUnItR9bHzMzcnZKScgfdLIociE0zBY7Fms5HHUhCiFI/BKdPn67DxMTUT4IjcCr99+9fYWZm5hWqpkFqOIyQGRSlQUKGU0N+eDtw0KfB0XKQgYGBojQ46ENw0NfF1ChGCJlBURQTMpwa8sPbgTNmzDBhZGRcSY2Q+v//f3hGRsYZqtbFgz4XjzqQ0oJ66tSpEiwsLH7USIN//vzZlJ2d/YKqaZAaDiNkxvAuZgj5nhryxIZgISMjI0Z/gRoOIGTG////dRgYGFD6PdjGZgiZQ1f5UQdSGtyDPgQB56phnoLYMZwAAAAASUVORK5CYII="},font:{style:"normal",weight:"normal",family:"Arial",size:"12px",color:"black",fill:!0},hyperlink:null,shadow:{color:"black",offsetX:4,offsetY:4,blur:4},settings:{name:"",text:"",auditable:!1,prefix:"",abbreviation:"",annotation:"",cachable:!1,namespace:"",strategy:"seqence",sequenceName:"",owner:""},includeChildren:!0,width:140,height:160,showtype:"physical",mode:"full",pk:[],fields:[]};t.extend(s,i),s.click=this.click,t.extend(this,new widget(s)),this.propertyEditors=[],this.gradient=null,this.allowRotate=!1;var h=this;if(this.margin=5,this.type="table",this.widgets.length>0){var n=[];t.extend(n,this.widgets),this.widgets.splice(0,this.widgets.length),this.restoreChildren(n,{editable:h.editable})}if(this.fields.length>0){var o=[];t.extend(o,this.fields),this.fields.splice(0,this.fields.length);for(var r=0;r<=o.length-1;r++)this.fields.push(h.Widget(o[r]))}if(this.pk.length>0){var d=[];t.extend(d,this.pk),this.pk.splice(0,this.pk.length);for(var r=0;r<=d.length-1;r++)this.pk.push(h.Widget(d[r]))}this.persist=function(){var i=widget.persistproperty(this);i.pk=[];for(var e=0;e<=this.pk.length-1;e++)i.pk.push(this.pk[e].name);i.showtype=this.showtype,i.mode=this.mode||"full",i.fields=[];for(var e=0;e<=this.fields.length-1;e++)i.fields.push(this.fields[e].name);return i.settings={},t.extend(i.settings,this.settings),delete i.font,delete i.background,i},this.click=function(t){this.focuswidget&&(this.focuswidget.focus=!1,this.focuswidget=null),i.click&&i.click.call(this,t),this.paint()},
this.dblclick=function(t){t.y>this.lineheight&&(t.cancel=!0)},this.keypress=function(t){if(console.info(t.keyCode),46===t.keyCode)this.focuswidget&&(this.deletefield(),t.cancel=!0);else if(45===t.keyCode)this.newfield();else if(38===t.keyCode){var i=this.focuswidget;t.ctrlKey?null!=i&&(t.preventDefault(),i.goup(),t.cancel=!0):null!=i&&(t.preventDefault(),i.prev(t),t.cancel=!0)}else if(40===t.keyCode){var i=this.focuswidget;t.ctrlKey?null!=i&&(t.preventDefault(),i.godown(),t.cancel=!0):null!=i&&(t.preventDefault(),i.next(t),t.cancel=!0)}},pkcount=1,fieldcount=2,this.drawBorderTo=function(i){i.save();var e=this;pkcount=this.pk.length,fieldcount=pkcount+1+Math.max(this.fields.length,2),this.lineheight=e.fontSize()+2*e.margin,this.minheight=(fieldcount+1)*e.lineheight,this.height<this.minheight&&(this.height=this.minheight),t(this.widgets).each(function(t,i){e.minwidth=Math.max(e.minwidth,i.minwidth)}),e.width=Math.max(this.width,this.minwidth),t(this.pk).each(function(t,i){var s=e.findfield(i.name);s&&(s.y=(t+1)*e.lineheight+e.margin)});var s=0;t(this.fields).each(function(t,i){"full"==e.mode||"simple"==e.mode&&i.data.isfk?(i.visible=!0,e.findfield(i.name).y=(s+1+pkcount)*e.lineheight+e.margin,s++):i.visible=!1}),fieldcount=pkcount+1+Math.max(s,2),this.minheight=(fieldcount+1)*e.lineheight,this.height=this.minheight;var h=this;if("none"!==h.border.color){if(i.beginPath(),i.lineJoin="round",h.border.width=parseInt(h.border.width),i.lineWidth=h.border.width,i.lineCap="round",i.strokeStyle=h.border.color,"solid"!==h.border.type){var n="dashed"===h.border.type?[h.border.width+3,h.border.width+1]:[h.border.width+1,h.border.width+1];i.setLineDash(n)}this.focus&&this.editable||i.strokeRect(-.5,-.5,h.width+.5,h.height+.5),i.restore()}return this.fillBackgroundTo(i),this},this.fillBackgroundTo=function(t){null!=this.background&&"none"!==this.background.color&&(t.save(),t.fillStyle=this.background.color,t.fillRect(0,0,this.width,this.height),t.restore()),this.focus&&this.editable&&(t.save(),t.fillStyle="#cae2ff",t.fillRect(0,0,this.width,h.lineheight+h.margin),t.restore()),t.moveTo(0,h.lineheight+h.margin+.5),t.lineTo(h.width,h.lineheight+h.margin+.5),t.stroke(),this.drawImageTo(t)};this.drawImageTo=function(t){var i=this;if(null!=i.background&&"image"==i.background.filltype){var e=i.background.image;if(e){var s=this.margin/2;t.drawImage(e,s,this.margin/2,18,18)}return this}},this.drawResizerTo=function(t){t.save(),t.beginPath(),t.globalAlpha=1,t.fillStyle="#cecfff",t.lineWidth=1;if(!this.autosize)for(var i=0;i<=this.resizers.length-1;i++)this.resizers[i].visible&&t.fillRect(this.resizers[i].x-4,this.resizers[i].y-4,8,8);t.restore()},this.drawSelectRect=function(t){return this.selectable&&(t.save(),t.beginPath(),t.globalAlpha=1,t.strokeStyle="#cecfff",t.strokeRect(0,0,this.width,this.height),t.closePath(),t.restore()),this},this.drawTextTo=function(t){var i=this.margin,e=this.name;return"logical"===this.showtype&&(e=this.text),t.save(),null!=this.font&&this.text&&("String"==typeof this.font?t.font=this.font:t.font=this.font.style+" "+this.font.weight+" "+this.font.size+" "+this.font.family,this.focus&&this.editable?(t.strokeStyle="black",t.fillStyle="black"):(t.strokeStyle=this.font.color||"black",t.fillStyle=this.font.color||"black"),this.font.fill=null==this.font.fill||this.font.fill,this.font.fill?t.fillText(e,i+18,this.fontSize()+i):t.strokeText(e,i+18,this.fontSize()+i)),t.restore(),this},this.getName=function(t){var i="field";if(1===arguments.length){if(null==this.findfield(t))return t;i=t}for(var e=1;null!=this.findfield(i+e);)e++;return i+e},this.addpk=function(t){if(t.type&&"field"===t.type&&null==this.findfield(t.name)&&(t.data.ispk=!0,t.data.nullable=!1,this.pk.push(t),this.appendWidget(t)),this.connections.length>0)for(var i=0;i<=this.connections.length-1;i++)"relationConnector"==this.connections[i].type&&this.connections[i].begin.widget==this&&this.connections[i].refresh();return this},this.addfield=function(t){return t.type&&"field"===t.type&&null==this.findfield(t.name)&&(t.data.ispk=!1,this.fields.push(t),this.appendWidget(t)),this},this.newfield=function(i){var e=this.getName(),s={name:e,editable:!0,font:this.font};t.extend(s,i);var h=new field(s);return h.data.name=e,this.addfield(h),i.silence||this.paint(),h},this.deletefield=function(t){var i=t;if(null!=i&&i.data.isfk)return alert(","),void(e.cancel=!0);null!=i&&(this.removefield(i),this.widgets.length>0?(this.widgets[this.widgets.length-1].focus=!0,this.presenters[0].focuswidget=this.widgets[this.widgets.length-1]):this.presenters[0].focuswidget=this,this.paint())},this.newpk=function(i){var e=this.getName(),s={name:e,editable:!0};t.extend(s,i);var h=new field(s);return h.data.name=e,this.addpk(h),i.silence||h.click({x:0,y:0}),h},this.findfield=function(t){for(var i=0;i<=this.widgets.length-1;i++)if(this.widgets[i].name===t)return this.widgets[i];return null},this.removefield=function(t){for(var i=0;i<this.fields.length;i++)if(this.fields[i]===t)return this.fields.splice(i,1),this.removeWidget(t),this;for(var i=0;i<this.pk.length;i++)if(this.pk[i]===t){if(this.pk.splice(i,1),this.removeWidget(t),this.connections.length>0)for(var i=0;i<=this.connections.length-1;i++)"relationConnector"==this.connections[i].type&&this.connections[i].begin.widget==this&&this.connections[i].refresh();return this}return this},this.getdata=function(){var i={};t.extend(i,this.settings),i.name=this.name,i.text=this.text,i.fields=[],i.pks=[];for(var e=0;e<=this.pk.length-1;e++)i.pks.push(this.pk[e].data),i.fields.push(this.pk[e].data);for(var e=0;e<=this.fields.length-1;e++)i.fields.push(this.fields[e].data);if(this.settings.auditable){field_created_by={name:"created_by",datatype:"number",precision:0,ispk:!1,isfk:!1,reftable:"",refield:"",nullable:!0,unique:!1,annotation:"",defaultvalue:"",length:255,integer:19,decimal:0},i.fields.push(field_created_by);var s={};t.extend(s,field_created_by,{name:"last_modified_by"}),i.fields.push(s);var h={};t.extend(h,field_created_by,{name:"created_date",datatype:"datetime"});var n={};t.extend(n,field_created_by,{name:"last_modified_date",datatype:"datetime"}),i.fields.push(h),i.fields.push(n)}return i}},relationConnector=function(i){var e={name:"relationConnector",width:150,height:30,border:{width:1,type:"solid",color:"#ccc"},key:{name:"",identifying:!1,nullable:!1}};t.extend(e,i),t.extend(this,new brokenLineConnector(e)),this.propertyEditors=["common"],this.text=this.text?this.name:this.text,this.key.identifying?this.border.type="solid":this.border.type="dashed",this.begin.shape.name="none",this.end.shape.name="arrow",this.type="relationConnector",this.fieldmaps=new Map,i.elements&&(this.fieldmaps.elements=i.elements),this.persist=function(){var i=widget.persistproperty(this);return i.offsetX=this.offsetX,i.offsetY=this.offsetY,i.linecap=this.linecap,i.minOffset=this.minOffset,i.begin=this.begin.persist(),i.end=this.end.persist(),i.begin.position=this.begin.position,i.end.position=this.end.position,i.elements=[],t.extend(i.elements,this.fieldmaps.elements),i.key={},t.extend(i.key,this.key),i},this.ondelete=function(){for(var t=0;t<=this.fieldmaps.size()-1;t++){var i=this.end.widget.findfield(this.fieldmaps.element(t).value);null!=i&&(this.key.identifying&&i.data.ispk||!this.key.identifying&&!i.data.ispk)&&this.end.widget.removefield(i)}for(var t=0;t<=this.begin.widget.connections.length-1;t++)this.begin.widget.connections[t]===this&&this.begin.widget.connections.splice(t,1);for(var t=0;t<=this.end.widget.connections.length-1;t++)this.end.widget.connections[t]===this&&this.end.widget.connections.splice(t,1);this.fieldmaps.clear()},this.onconnected=function(){for(var t=0;t<=this.begin.widget.pk.length-1;t++){for(var i=0;i<this.begin.widget.connections.length;i++){var e=this.begin.widget.connections[i];if(e!==this&&e.begin.widget===this.end.widget&&e.end.widget===this.begin.widget)return alert("there is already has relationship between tables"),void this.presenters[0].removeWidget(this);if(e!==this&&e.begin.widget===this.begin.widget&&e.end.widget===this.end.widget){for(var s=0;s<=e.fieldmaps.size()-1;s++){var h=e.end.widget.findfield(e.fieldmaps.element(s).value);null!=h&&e.end.widget.removefield(h),this.key.identifying?e.end.widget.addpk(widget):e.end.widget.addfield(widget)}this.presenters[0].removeWidget(e)}}var n=this.begin.widget.pk[t].persist(),o=new field(n);o.data.isfk=!0,o.name=this.begin.widget.name+"_"+o.name,o.data.reftable=this.begin.widget.name,o.data.refield=n.name;null!=this.end.widget.findfield(o.name)&&(o.name=this.begin.widget.getName(this.begin.widget.name+"_"+n.name),o.data.name=o.name,o.text=o.name),this.fieldmaps.put(n.name,o.name),this.key.identifying?this.end.widget.addpk(o):this.end.widget.addfield(o)}},this.beforePaint=function(t){this.key.identifying?(this.border.type="solid",this.key.nullable=!1):this.border.type="dashed",this.key.nullable?(this.begin.shape.name="arrow",this.begin.shape.type=3):this.begin.shape.name="none"},this.refresh=function(){for(var t=0;t<=this.fieldmaps.size()-1;t++){var i=this.end.widget.findfield(this.fieldmaps.element(t).value);null!=i&&this.end.widget.removefield(i)}this.fieldmaps.clear();for(var t=0;t<=this.begin.widget.pk.length-1;t++){var e=this.begin.widget.pk[t].persist(),s=new field(e);s.data.isfk=!0,null!=this.end.widget.findfield(s.name)&&(s.name=this.begin.widget.getName(this.begin.widget.name+"_"+e.name),s.data.name=s.name,s.text=s.name),this.fieldmaps.put(e.name,s.name),this.key.identifying?this.end.widget.addpk(s):this.end.widget.addfield(s)}}},t.register("relationConnector",relationConnector),t.register("field",field),t.register("table",table)}(jQuery),function(t){treeNode=function(i){var e={font:{style:"normal",weight:"normal",family:"Arial",size:"12px",color:"none",fill:!0},background:{filltype:"image",color:"white",image:"images/tree/40-1-1.png",imageType:"center"},objectdata:{originedatatype:"",datatype:"String",targetpath:"",collapse:!1,layer:0,index:0},hyperlink:null,shadow:null,width:140,height:44,includeChildren:!1,text:""};i.objectdata&&(t.extend(e.objectdata,i.objectdata),delete i.objectdata),t.extend(e,i),t.extend(this,new widget(e)),this.margin=4,this.propertyEditors=["common"];var s=this,h="images/tree/40-1-1.png";switch(function(t){switch(t){case"String":case"varchar2":case"char":case"varchar":return"String";case"Integer":case"number":case"int":return"Integer";case"Date":case"timestamp(6)":case"time":return Date;default:return"datatype"}}(this.objectdata.datatype)){case"String":break;case"Array":h="images/tree/40-1.png";break;case"Object":h="images/tree/json-40-1.png";break;case"MergedObject":h="images/tree/lable.png";break;case"Date":h="images/tree/date-40-1.png";break;case"Integer":h="images/tree/number-40-1.png"}if(this.Background({filltype:"image",image:h},function(){s.paint()}),this.click=function(i){for(var e=this.collection().presenters[0].textbox,s=0;s<=this.parent.widgets.length-1;s++)this.parent.widgets[s].focus=!1;this.focus=!0,this.collection().presenters[0].focuswidget=this,t(e).hide(),this.collection().presenters[0].paint(),this.collection().fieldclickEvent&&this.collection().fieldclickEvent.call(this,i),i.cancel=!0},!this.includeChildren&&i.widgets&&i.widgets.length>0){var n=[];t.extend(n,i.widgets),i.widgets.splice(0,i.widgets.length),this.restoreChildren(n,{editable:!0,click:this.click})}this.type="treeNode",this.autosize=!1,this.editable=!1;var s=this;this.collection=function(){for(var t=this.parent;t&&"collection"!=t.type;)t=t.parent;return t},this.persist=function(){var i=widget.persistproperty(this);return i.treename=this.collection().name,i.objectdata={},t.extend(i.objectdata,this.objectdata),i},this.newfield=function(i){var e=this.getName(),s={name:e,font:this.font};t.extend(s,i);var h=new treeNode(s);return this.addnode(h),h},this.addnode=function(t){return t.type&&"treeNode"===t.type&&null==this.findnode(t.name)&&(t.objectdata.index=this.widgets.length+1,t.objectdata.layer=this.objectdata.layer+1,this.objectdata.originedatatype=this.objectdata.datatype||"Object",this.objectdata.datatype=this.objectdata.datatype||"Object",this.appendWidget(t),t.fieldclickEvent=this.fieldclickEvent,this.Background({filltype:"image",image:h},function(){s.paint()})),this},this.deletefield=function(){var t=this.parent,i=t.widgets.indexOf(this);if(!(i<0)){var e=this.collection().presenters[0];if(this.objectdata.targetpath){var s=e.Widget(this.objectdata.targetpath);e.removeWidget(s)}t.removeWidget(this),t.widgets.length>0&&(i==t.widgets.length?(t.widgets[i-1].focus=!0,e.focuswidget=t.widgets[i-1]):(t.widgets[i].focus=!0,e.focuswidget=t.widgets[i])),this.paint()}},this.findnode=function(t){for(var i=0;i<=this.widgets.length-1;i++)if(this.widgets[i].name===t)return this.widgets[i];return null},this.beforePaint=function(i){"collection"==this.parent.type?this.objectdata.layer=0:"treeNode"==this.parent.type&&(this.objectdata.layer=this.parent.objectdata.layer+1);var e=this.fontSize()+2*this.margin,s=e+Math.round(this.margin/2);if(this.widgets.length>0&&(t(this.widgets).each(function(t,i){i.y=s,s+=i.height}),this.objectdata.targetpath)){var h=this.collection().presenters[0].Widget(this.objectdata.targetpath);h&&("left"!=h.end.position&&"right"!=h.end.position||(h.end.y=o(this)+e/2,h.end.offsetx=this.margin+this.objectdata.layer*(r+d)+.5))}this.Height(s),this.parent&&this.Width(this.parent.canvas.width)};var o=function(t){for(var i=t.y;t.parent&&"treeNode"==t.parent.type;)i+=t.parent.y,t=t.parent;return i};this.drawBorderTo=function(t){this.x=0,t.save();var i=this;this.lineheight=i.fontSize()+2*i.margin;var e=this;if(this.widgets.length>0&&this.objectdata.targetpath&&(e.border.type="dashed",e.border.color="#00eeff"),"none"!==e.border.color){if(t.beginPath(),t.lineJoin="round",e.border.width=parseInt(e.border.width),t.lineWidth=e.border.width,t.lineCap="round",t.strokeStyle=e.border.color,"solid"!==e.border.type){var s="dashed"===e.border.type?[e.border.width+3,e.border.width+1]:[e.border.width+1,e.border.width+1];t.setLineDash(s)}var h=this.margin+this.objectdata.layer*(r+d)+.5;this.objectdata.layer;t.strokeRect(h,-1,e.width-h-2*(this.objectdata.layer+1)+.5,e.height+1)}return this.drawImageTo(t),t.restore(),this},this.drawImageTo=function(t){var i=this;if(null!=i.background&&"image"==i.background.filltype){var e=i.background.image;if(e){var s=this.margin+this.objectdata.layer*(r+d)+d+3;this.parent.objectdata&&"MergedObject"==this.parent.objectdata.datatype&&(s=this.margin+(this.objectdata.layer-1)*(r+d)+d+3),t.drawImage(e,s-d,this.margin/2,d,d)}return this}};var r=5,d=18;this.drawTextTo=function(t){var i=this.name,e=this.margin;this.autosize;t.save();var h=this.font;if("none"===this.font.color&&(h=this.parent.font),this.focus){t.fillStyle="#cae2ff";var n=e+this.objectdata.layer*(r+d)+3;this.parent.objectdata&&"MergedObject"==this.parent.objectdata.datatype&&(n=this.margin+(this.objectdata.layer-1)*(r+d)+3),t.fillRect(n,0,this.width-n-2*(this.objectdata.layer+1),this.height-2),t.fillStyle="black",t.strokeStyle="black"}else t.fillStyle=h.color||"black",t.strokeStyle=h.color||"black",this.objectdata&&"MergedObject"==this.objectdata.datatype&&(t.fillStyle="blue",t.strokeStyle="blue");if(null!=h&&i){t.font="String"==typeof h?h:h.style+" "+h.weight+" "+h.size+" "+h.family,metrics=t.measureText(i),this.minwidth=metrics.width+2*this.margin+this.objectdata.layer*(r+d);var n=e+this.objectdata.layer*(r+d)+d+2*e;this.parent.objectdata&&"MergedObject"==this.parent.objectdata.datatype&&(n=e+(this.objectdata.layer-1)*(r+d)+d+2*e),h.fill=null==h.fill||h.fill,h.fill?t.fillText(i,n,e+this.parent.fontSize(),this.width-e):t.strokeText(i,e,this.parent.fontSize()+e),t.save(),t.restore()}return s.drawImageTo(t),t.restore(),this},this.keypress=function(t){if(46===t.keyCode)this.focus&&(this.deletefield(),t.cancel=!0);else if(45===t.keyCode)this.newfield();else if(38===t.keyCode)if(t.ctrlKey)t.preventDefault(),this.goup(),t.cancel=!0;else{var i=this.parent,e=i.widgets.indexOf(this);this.focus=!1,e>0?(this.collection().presenters[0].focuswidget=i.widgets[e-1],i.widgets[e-1].focus=!0):"treeNode"==s.parent.type&&(this.collection().presenters[0].focuswidget=s.parent,s.parent.focus=!0),i.paint(),t.preventDefault(),t.cancel=!0}else if(40===t.keyCode)if(t.ctrlKey)t.preventDefault(),this.godown(),t.cancel=!0;else{var i=this.parent,e=i.widgets.indexOf(this);this.focus=!1,e<i.widgets.length-1&&(this.collection().presenters[0].focuswidget=i.widgets[e+1],i.widgets[e+1].focus=!0,i.paint()),t.preventDefault(),t.cancel=!0}},this.goup=function(){for(var t=this.parent.widgets,i=0;i<=t.length-1;i++)if(t[i]===this&&i>0){var e=t[i-1];return t[i-1]=this,t[i]=e,this.parent.widgets[i-1]=this,this.parent.widgets[i]=e,void this.parent.paint()}},this.godown=function(){for(var t=this.parent.widgets,i=0;i<=t.length-1;i++)if(t[i]===this&&i<t.length-1){var e=t[i+1];return t[i+1]=this,t[i]=e,this.parent.widgets[i+1]=this,this.parent.widgets[i]=e,void this.parent.paint()}},this.prev=function(t){for(var i=this.parent.widgets,e=0;e<=i.length-1;e++)i[e]===this&&e>0&&(this.parent.widgets[e].focus=!1,this.parent.widgets[e-1].focus=!0,this.parent.focuswidget=i[e-1],this.parent.paint(),this.parent.fieldclickEvent&&this.parent.fieldclickEvent.call(this,t),t.cancel=!0)},this.next=function(t){for(var i=this.parent.widgets,e=0;e<=i.length-1;e++)i[e]===this&&e<i.length-1&&(this.parent.widgets[e].focus=!1,this.parent.widgets[e+1].focus=!0,this.parent.focuswidget=i[e+1],this.parent.paint(),this.parent.fieldclickEvent&&this.parent.fieldclickEvent.call(this,t),t.cancel=!0)},this.getName=function(t){var i="treeNode";if(1===arguments.length){if(null==this.findnode(t))return t;i=t}for(var e=1;null!=this.findnode(i+e);)e++;return i+e}},collection=function(i){var e={border:{width:1,type:"solid",color:"black"},corner:null,background:{filltype:"image",color:"white",image:"images/tree/jsontree40.png"},font:{style:"normal",weight:"bold",family:"Arial",size:"12px",color:"black",fill:!0},hyperlink:null,shadow:{color:"black",offsetX:4,offsetY:4,blur:4},width:180,height:260,includeChildren:!1,references:[]};t.extend(e,i),t.extend(this,new widget(e)),this.propertyEditors=["common"],this.gradient=null;var s=this;if(this.margin=6,this.type="collection",this.allowRotate=!1,this.click=function(t){for(var e=0;e<=this.widgets.length-1;e++)this.widgets[e].focus=!1;this.presenters[0].focuswidget!=this&&(this.presenters[0].focuswidget.focus=!1),this.focuswidget=null,i.click&&i.click.call(this,t),this.paint()},!this.includeChildren&&i.widgets&&i.widgets.length>0){var h=[];t.extend(h,i.widgets),i.widgets.splice(0,i.widgets.length),this.restoreChildren(h,{editable:!0,click:this.click})}this.persist=function(){return widget.persistproperty(this)},this.dblclick=function(t){t.y>this.lineheight&&(t.cancel=!0)},this.keypress=function(t){if(46===t.keyCode)this.focuswidget&&(this.deletenode(),t.cancel=!0);else if(45===t.keyCode)this.newfield();else if(38===t.keyCode){var i=this.focuswidget;t.ctrlKey?null!=i&&(t.preventDefault(),i.goup(),t.cancel=!0):(null!=i&&(t.preventDefault(),i.prev(t)),t.cancel=!0)}else if(40===t.keyCode){var i=this.focuswidget;t.ctrlKey?null!=i&&(t.preventDefault(),i.godown(),t.cancel=!0):(null!=i&&(t.preventDefault(),i.next(t)),t.cancel=!0)}},this.findtargets=function(t){var i=[],e=function(t,s){for(var h=t.widgets,n=h.length-1;n>=0;--n)if(h[n].checkPointIn(s.x,s.y)){var o=h[n].relativePoint(s.x,s.y),r={};r.x=o.x,r.y=o.y,i.push(h[n]),e(h[n],r);break}};return e(this,t),i},this.beforePaint=function(i){var e=this.parent.fontSize()+2*this.margin,h=e+s.margin;this.minheight=60;var n=this.y;t(this.widgets).each(function(t,i){s.minwidth=Math.max(s.minwidth,i.minwidth),i.y=h+s.margin,h+=i.height+s.margin,i.width=this.width}),this.minheight<h&&this.Height(h),this.y=n},this.drawBorderTo=function(t){t.save();var i=this;this.lineheight=i.fontSize()+2*i.margin;var e=this;if("none"!==e.border.color){if(t.beginPath(),t.lineJoin="round",e.border.width=parseInt(e.border.width),t.lineWidth=e.border.width,t.lineCap="round",t.strokeStyle=e.border.color,"solid"!==e.border.type){var s="dashed"===e.border.type?[e.border.width+3,e.border.width+1]:[e.border.width+1,e.border.width+1];t.setLineDash(s)}this.focus&&this.editable||t.strokeRect(-.5,-.5,e.width+.5,e.height+.5)}return this.fillBackgroundTo(t),t.restore(),this},this.fillBackgroundTo=function(t){null!=this.background&&"none"!==this.background.color&&(t.save(),t.fillStyle=this.background.color,t.fillRect(0,0,this.width,this.height),t.restore()),this.focus&&this.editable&&(t.save(),t.fillStyle="#cae2ff",t.fillRect(0,0,this.width,s.lineheight+s.margin),t.restore()),t.moveTo(0,s.lineheight+s.margin+.5),t.lineTo(s.width,s.lineheight+s.margin+.5),t.stroke(),this.drawImageTo(t)},this.drawResizerTo=function(t){t.save(),t.beginPath(),t.globalAlpha=1,t.fillStyle="#cecfff",t.lineWidth=1;if(!this.autosize)for(var i=0;i<=this.resizers.length-1;i++)this.resizers[i].visible&&t.fillRect(this.resizers[i].x-4,this.resizers[i].y-4,8,8);t.restore()};this.drawImageTo=function(t){var i=this;if(null!=i.background&&"image"==i.background.filltype){var e=i.background.image;if(e){var s=this.margin/2;t.drawImage(e,s,this.margin/2,18,18)}return this}},this.drawTextTo=function(t){var i=this.margin,e=this.name;return t.save(),null!=this.font&&this.text&&("String"==typeof this.font?t.font=this.font:t.font=this.font.style+" "+this.font.weight+" "+this.font.size+" "+this.font.family,t.strokeStyle=this.font.color||"black",t.fillStyle=this.font.color||"black",this.font.fill=null==this.font.fill||this.font.fill,this.font.fill?t.fillText(e,i+18,this.fontSize()+i):t.strokeText(e,i+18,this.fontSize()+i)),t.restore(),this},this.getName=function(t){var i="treeNode";if(1===arguments.length){if(null==this.findnode(t))return t;i=t}for(var e=1;null!=this.findnode(i+e);)e++;return i+e},this.newfield=function(i){var e=this.getName(),s={name:e};t.extend(s,i);var h=new treeNode(s);return h.objectdata.name=e,this.addnode(h),h},this.addnode=function(t){return t.type&&"treeNode"===t.type&&null==this.findnode(t.name)&&(t.objectdata.index=this.widgets.length+1,t.objectdata.layer=1,this.appendWidget(t),this.paint()),this},this.deletefield=function(){var t=this.parent,i=t.widgets.indexOf(this);i<0||(t.removeWidget(this),t.widgets.length>0&&(i==t.widgets.length?(t.widgets[i-1].focus=!0,this.focuswidget=t.widgets[i-1]):(t.widgets[i].focus=!0,this.focuswidget=t.widgets[i])),this.paint())},this.findnode=function(t){for(var i=0;i<=this.widgets.length-1;i++)if(this.widgets[i].name===t)return this.widgets[i];return null}},mapConnector=function(i){var e={name:"mapConnector",width:150,height:30,referpath:"",border:{width:1,type:"solid",color:"blue"},objectdata:{mappingtype:"MergedObject",targetpath:"",matchcriteria:{type:"object",fields:[{id:"source",value:"",type:"textinput",title:""},{id:"target",value:"",type:"textinput",title:""}],values:[]},matchcriteria2:{type:"object",fields:[{id:"source",value:"",type:"textinput",title:""},{id:"target",value:"",type:"textinput",title:""}],values:[]},fieldmaps:{type:"object",fields:[{id:"source",value:"",type:"textinput",title:""},{id:"target",value:"",type:"textinput",title:""}],values:[]}}};t.extend(e,i),t.extend(this,new brokenLineConnector(e)),this.propertyEditors=["common"],this.text=this.text?this.name:this.text,this.border.type="solid",this.begin.shape.name="none",this.end.shape.name="arrow",this.type="mapConnector";var s=this,h=function(t,i,e){var h=[];for("treeNode"==t.type&&h.push(t.name);t.parent&&"treeNode"==t.parent.type;)t=t.parent,h.push(t.name);return"MergedObject"==s.objectdata.mappingtype&&i&&h.splice(0,1),e||h.push(t.parent.name),h.reverse().join(".")};this.gettargetpath=h,this.persist=function(){var i=widget.persistproperty(this);return i.offsetX=this.offsetX,i.offsetY=this.offsetY,i.linecap=this.linecap,i.minOffset=this.minOffset,i.begin=this.begin.persist(),i.end=this.end.persist(),i.begin.position=this.begin.position,i.end.position=this.end.position,i.targetpath=this.targetpath,i.elements=[],i.objectdata={},t.extend(i.objectdata,this.objectdata),this.objectdata.target&&(i.objectdata.targetpath=h(this.objectdata.target,1,1),delete i.objectdata.target),i},this.ondelete=function(){for(var t=0;t<=this.begin.widget.connections.length-1;t++)this.begin.widget.connections[t]===this&&this.begin.widget.connections.splice(t,1);for(var t=0;t<=this.end.widget.connections.length-1;t++)this.end.widget.connections[t]===this&&this.end.widget.connections.splice(t,1);if(this.objectdata.target)this.objectdata.target.parent.removeWidget(this.objectdata.target);else if(this.targetpath){var i=this.targetpath.split(".");if(i.length>0){this.end.widget.includeChildren=!0;var e=this.presenters[0].Widget(this.end.widget.name);this.objectdata.target=e;for(var t=1;t<=i.length-1;t++)this.objectdata.target=this.objectdata.target.Widget(i[t]);this.objectdata.target.parent.removeWidget(this.objectdata.target)}}},this.beforePaint=function(t){"Array"==this.objectdata.mappingtype?(this.begin.shape.name="arrow",this.begin.shape.type=5):this.begin.shape.name="none","left"!=this.end.position&&"right"!=this.end.position&&(this.end.widget.x>this.begin.widget.x+this.begin.widget.width?(this.end.position="left",this.begin.position="right"):this.begin.widget.x+this.begin.widget.width>this.end.widget.x&&this.begin.widget.x+this.begin.widget.width<this.end.widget.x+this.end.x?"left"!=this.begin.position&&(this.begin.position="left",this.end.position="left"):this.begin.widget.x>this.end.widget.x&&this.begin.widget.x<this.end.widget.x+this.end.widget.width?"right"!=this.begin.position&&(this.begin.position="right",this.end.position="right"):this.end.widget.x+this.end.widget.width<this.begin.x&&"right"!=this.begin.position&&(this.begin.position="right",this.end.position="left"))},this.onconnected=function(t){this.begin.widget.focus=!1,this.end.widget.focus=!0,this.presenters[0].focuswidget=this.end.widget;var i,e="MergedObject";if(this.name=this.presenters[0].getName("Rule"),this.text=this.name,t){if("Object"!=t.objectdata.datatype)return alert("The target field data type is not object"),void this.parent.removeWidget(this);i=t.newfield({name:this.begin.widget.name,text:this.begin.widget.name}),e="Object"}else this.end.widget.widgets.length>0&&(e="Object"),i=this.end.widget.newfield({name:this.begin.widget.name,text:this.begin.widget.name,objectdata:{datatype:e}});this.end.offsetx=i.x,this.end.offsety=i.y,this.targetpath=h(i),this.objectdata={target:i,mappingtype:e,matchcriteria2:{type:"object",fields:[{id:"source",value:"",type:"textinput",title:""},{id:"target",value:"",type:"textinput",title:""}],values:[]},matchcriteria:{type:"object",fields:[{id:"source",value:"",type:"textinput",title:""},{id:"target",value:"",type:"textinput",title:""}],values:[]},fieldmaps:{type:"object",fields:["source","target"],values:[]},targetpath:h(i,1,1),layer:i.objectdata.layer,index:i.objectdata.index},"MergedObject"!=e&&(this.objectdata.targetpath=h(i,0,1)),"Array"!=e&&(this.objectdata.matchcriteria.visible=!1),this.objectdata.target.objectdata={visible:!1,datatype:e,targetpath:this.name};for(var n=0;n<=this.begin.widget.pk.length-1;n++){var o=this.begin.widget.pk[n],r=o.name;o.data.isfk&&this.objectdata.matchcriteria2.values.push({source:r,target:r});var d=h(i,1,1);d?this.objectdata.matchcriteria.values.push({source:r,target:d+"."+r}):this.objectdata.matchcriteria.values.push({source:r,target:r}),this.objectdata.fieldmaps.values.push({source:r,target:r}),i.newfield({name:o.name,text:o.name,objectdata:{originedatatype:o.data.datatype,datatype:o.data.datatype}})}for(var n=0;n<=this.begin.widget.fields.length-1;n++){var o=this.begin.widget.fields[n],r=o.name;o.data.isfk&&this.objectdata.matchcriteria2.values.push({source:r,target:r}),i.newfield({name:o.name,objectdata:{originedatatype:o.data.datatype,datatype:o.data.datatype}})}var g="images/tree/json-40-1.png";"MergedObject"==this.objectdata.mappingtype&&(g="images/tree/lable.png"),i.Background({filltype:"image",image:g},function(){s.paint()})},this.refresh=function(){for(var t=0;t<=this.begin.widget.pk.length-1;t++){var i=this.begin.widget.pk[t].persist(),e=new field(i);e.data.isfk=!0,null!=this.end.widget.findfield(e.name)&&(e.name=this.begin.widget.getName(this.begin.widget.name+"_"+i.name),e.data.name=e.name,e.text=e.name),this.end.widget.addfield(e)}}},t.register("collection",collection),t.register("treeNode",treeNode),t.register("mapConnector",mapConnector)}(jQuery);